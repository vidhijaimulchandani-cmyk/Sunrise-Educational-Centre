<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Management - Sunrise Education Centre</title>
  <link rel="icon" type="image/png" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="admin-modern.css">
  <link rel="stylesheet" href="uiverse-components.css">
  <style>
    /* Additional styles for user management */
    .user-management-container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: #667eea;
      text-decoration: none;
      font-weight: 500;
      margin-bottom: 2rem;
      padding: 0.75rem 1rem;
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
    }
    
    .back-link:hover {
      background: #667eea;
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102,126,234,0.3);
    }
    
    .page-header {
      text-align: center;
      margin-bottom: 3rem;
    }
    
    .page-header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      color: #1a202c;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
    }
    
    .page-header h1 i {
      color: #667eea;
    }
    
    .page-header p {
      font-size: 1.1rem;
      color: #718096;
    }
    
    .stats-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }
    
    .overview-card {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #e2e8f0;
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    
    .overview-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
    }
    
    .overview-card.users::before { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .overview-card.paid::before { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); }
    .overview-card.unpaid::before { background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); }
    .overview-card.admissions::before { background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); }
    
    .overview-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .overview-icon {
      width: 60px;
      height: 60px;
      margin: 0 auto 1rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: white;
    }
    
    .overview-icon.users { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .overview-icon.paid { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); }
    .overview-icon.unpaid { background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); }
    .overview-icon.admissions { background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); }
    
    .overview-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #1a202c;
      margin-bottom: 0.5rem;
    }
    
    .overview-label {
      color: #718096;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.875rem;
    }
    
    .main-content-grid {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }
    
    .create-user-card {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #e2e8f0;
      height: fit-content;
    }
    
    .users-list-card {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #e2e8f0;
    }
    
    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .card-title i {
      color: #667eea;
    }
    
    .search-filters {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    
    .search-input, .filter-select {
      padding: 0.75rem 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      background: white;
    }
    
    .search-input {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-select {
      min-width: 150px;
    }
    
    .search-input:focus, .filter-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }
    
    .users-table-container {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }
    
    .users-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    
    .users-table th {
      background: #f8fafc;
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 1px solid #e2e8f0;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .users-table td {
      padding: 1rem;
      border-bottom: 1px solid #f1f5f9;
      color: #4a5568;
    }
    
    .users-table tr:hover {
      background: #f8fafc;
    }
    
    .users-table tr:last-child td {
      border-bottom: none;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      margin-right: 0.75rem;
    }
    
    .user-info {
      display: flex;
      align-items: center;
    }
    
    .user-details h4 {
      font-weight: 600;
      color: #1a202c;
      margin: 0;
    }
    
    .user-details p {
      color: #718096;
      font-size: 0.875rem;
      margin: 0;
    }
    
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .status-paid {
      background: rgba(72,187,120,0.1);
      color: #38a169;
      border: 1px solid rgba(72,187,120,0.2);
    }
    
    .status-unpaid {
      background: rgba(237,137,54,0.1);
      color: #dd6b20;
      border: 1px solid rgba(237,137,54,0.2);
    }
    
    .status-admin {
      background: rgba(102,126,234,0.1);
      color: #667eea;
      border: 1px solid rgba(102,126,234,0.2);
    }
    
    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }
    
    .btn-sm {
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
      border-radius: 6px;
    }
    
    .contact-info {
      font-size: 0.875rem;
    }
    
    .contact-info div {
      margin-bottom: 0.25rem;
    }
    
    .contact-info i {
      width: 16px;
      color: #718096;
      margin-right: 0.5rem;
    }
    
    .last-seen {
      font-size: 0.875rem;
      color: #718096;
    }
    
    .traffic-metrics {
      background: white;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #e2e8f0;
      margin-bottom: 1.5rem;
    }
    
    .metrics-row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .metric-item {
      background: #f8fafc;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      font-size: 0.875rem;
    }
    
    .metric-label {
      color: #718096;
      margin-right: 0.5rem;
    }
    
    .metric-value {
      font-weight: 600;
      color: #1a202c;
    }
    
    /* Responsive Design */
    @media (max-width: 1200px) {
      .main-content-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .user-management-container {
        padding: 1rem;
      }
      
      .stats-overview {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
      
      .search-filters {
        flex-direction: column;
      }
      
      .search-input, .filter-select {
        width: 100%;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .users-table th,
      .users-table td {
        padding: 0.75rem 0.5rem;
        font-size: 0.875rem;
      }
      
      .metrics-row {
        flex-direction: column;
      }
    }
    
    /* Loading states */
    .loading-skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    /* Success/Error messages */
    .message {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .message.success {
      background: rgba(72,187,120,0.1);
      color: #2f855a;
      border: 1px solid rgba(72,187,120,0.2);
    }
    
    .message.error {
      background: rgba(245,101,101,0.1);
      color: #c53030;
      border: 1px solid rgba(245,101,101,0.2);
    }
  </style>
</head>
<body>
  <div class="user-management-container">
    <!-- Back Link -->
    <a href="/admin" class="back-link">
      <i class="fas fa-arrow-left"></i>
      Back to Admin Panel
    </a>
    
    <!-- Page Header -->
    <div class="page-header">
      <h1>
        <i class="fas fa-users-cog"></i>
        User & Admissions Management
      </h1>
      <p>Create new users, manage existing accounts, and handle student admissions efficiently</p>
    </div>
    
    <!-- Statistics Overview -->
    <div class="stats-overview">
      <div class="overview-card users">
        <div class="overview-icon users">
          <i class="fas fa-users"></i>
        </div>
        <div class="overview-value">{{ users|length }}</div>
        <div class="overview-label">Total Users</div>
      </div>
      
      <div class="overview-card paid">
        <div class="overview-icon paid">
          <i class="fas fa-credit-card"></i>
        </div>
        <div class="overview-value">{{ paid_users|default(0) }}</div>
        <div class="overview-label">Paid Users</div>
      </div>
      
      <div class="overview-card unpaid">
        <div class="overview-icon unpaid">
          <i class="fas fa-clock"></i>
        </div>
        <div class="overview-value">{{ unpaid_users|default(0) }}</div>
        <div class="overview-label">Unpaid Users</div>
      </div>
      
      <div class="overview-card admissions">
        <div class="overview-icon admissions">
          <i class="fas fa-graduation-cap"></i>
        </div>
        <div class="overview-value">{{ admissions|default([])|length }}</div>
        <div class="overview-label">Admissions</div>
      </div>
    </div>
    
    <!-- Traffic Metrics -->
    <div class="traffic-metrics">
      <div class="metrics-row">
        <div class="metric-item">
          <span class="metric-label">Active Logins (10m):</span>
          <span class="metric-value" id="activeLogins">--</span>
        </div>
        <div class="metric-item">
          <span class="metric-label">Active IPs (10m):</span>
          <span class="metric-value" id="activeIps">--</span>
        </div>
        <div class="metric-item">
          <span class="metric-label">Unique IPs Today:</span>
          <span class="metric-value" id="ipsToday">--</span>
        </div>
        <div class="metric-item">
          <span class="metric-label">Total Unique IPs:</span>
          <span class="metric-value" id="ipsTotal">--</span>
        </div>
      </div>
    </div>
    
    <!-- Main Content Grid -->
    <div class="main-content-grid">
      <!-- Create User Section -->
      <div class="create-user-card">
        <h2 class="card-title">
          <i class="fas fa-user-plus"></i>
          Create New User
        </h2>
        
        <form method="POST" action="/admin/create-user" id="createUserForm">
          <div class="form-group">
            <label for="username" class="form-label">
              <i class="fas fa-user"></i>
              Username
            </label>
            <input type="text" id="username" name="username" class="form-input" placeholder="Enter username" required>
          </div>
          
          <div class="form-group">
            <label for="password" class="form-label">
              <i class="fas fa-lock"></i>
              Password
            </label>
            <input type="password" id="password" name="password" class="form-input" placeholder="Enter password" required>
          </div>
          
          <div class="form-group">
            <label for="class_id" class="form-label">
              <i class="fas fa-graduation-cap"></i>
              Class/Role
            </label>
            <select id="class_id" name="class_id" class="form-select" required>
              <option value="">Select a class/role</option>
              {% for id, name in all_classes %}
                <option value="{{ id }}">{{ name|title }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="form-group">
            <label for="paid" class="form-label">
              <i class="fas fa-credit-card"></i>
              Payment Status
            </label>
            <select id="paid" name="paid" class="form-select" required>
              <option value="">Select payment status</option>
              <option value="paid">Paid</option>
              <option value="not paid">Not Paid</option>
            </select>
          </div>
          
          <button type="submit" class="btn btn-primary" style="width: 100%;">
            <i class="fas fa-plus"></i>
            Create User
          </button>
        </form>
      </div>
      
      <!-- Users List Section -->
      <div class="users-list-card">
        <h2 class="card-title">
          <i class="fas fa-list"></i>
          Current Users
        </h2>
        
        <!-- Search and Filters -->
        <div class="search-filters">
          <input type="text" id="userSearch" class="search-input" placeholder="Search by username..." onkeyup="filterUsers()">
          <select id="roleFilter" class="filter-select" onchange="filterUsers()">
            <option value="">All Roles</option>
            {% for id, name in all_classes %}
              <option value="{{ name|lower }}">{{ name|title }}</option>
            {% endfor %}
          </select>
          <select id="statusFilter" class="filter-select" onchange="filterUsers()">
            <option value="">All Status</option>
            <option value="paid">Paid</option>
            <option value="unpaid">Unpaid</option>
          </select>
        </div>
        
        <!-- Users Table -->
        <div class="users-table-container">
          <table class="users-table">
            <thead>
              <tr>
                <th>User</th>
                <th>Role</th>
                <th>Status</th>
                <th>Contact</th>
                <th>Last Seen</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              {% for id, username, name, paid, mobile_no, email_address in users %}
              <tr data-username="{{ username|lower }}" data-role="{{ name|lower }}" data-paid="{{ paid }}" data-userid="{{ id }}">
                <td>
                  <div class="user-info">
                    <div class="user-avatar">
                      {{ username[0]|upper }}
                    </div>
                    <div class="user-details">
                      <h4>{{ username }}</h4>
                      <p>ID: {{ id }}</p>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="status-badge {% if name|lower in ['admin', 'teacher'] %}status-admin{% else %}status-secondary{% endif %}">
                    <i class="fas fa-{% if name|lower == 'admin' %}crown{% elif name|lower == 'teacher' %}chalkboard-teacher{% else %}user{% endif %}"></i>
                    {{ name|title }}
                  </span>
                </td>
                <td>
                  <span class="status-badge {% if paid == 'paid' %}status-paid{% else %}status-unpaid{% endif %}">
                    <i class="fas fa-{% if paid == 'paid' %}check-circle{% else %}clock{% endif %}"></i>
                    {{ "Paid" if paid == 'paid' else "Unpaid" }}
                  </span>
                </td>
                <td>
                  {% if mobile_no or email_address %}
                    <div class="contact-info">
                      {% if mobile_no %}
                        <div><i class="fas fa-phone"></i>{{ mobile_no }}</div>
                      {% endif %}
                      {% if email_address %}
                        <div><i class="fas fa-envelope"></i>{{ email_address }}</div>
                      {% endif %}
                    </div>
                  {% else %}
                    <span style="color: #a0aec0; font-style: italic;">No contact info</span>
                  {% endif %}
                </td>
                <td>
                  <div class="last-seen" id="lastSeen-{{ id }}">
                    <i class="fas fa-circle" style="color: #a0aec0; font-size: 0.5rem;"></i>
                    Loading...
                  </div>
                </td>
                <td>
                  <div class="action-buttons">
                    <a href="/user-info/{{ id }}" class="btn btn-primary btn-sm" title="Edit User">
                      <i class="fas fa-edit"></i>
                    </a>
                    <button class="btn btn-warning btn-sm" onclick="blockUser({{ id }}, '{{ username }}')" title="Block User">
                      <i class="fas fa-ban"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteUser({{ id }})" title="Delete User">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Load traffic metrics
    async function loadTrafficMetrics() {
      try {
        const response = await fetch('/api/admin/metrics/traffic');
        if (response.ok) {
          const data = await response.json();
          document.getElementById('activeLogins').textContent = data.active_logins_10m || '0';
          document.getElementById('activeIps').textContent = data.active_ips_10m || '0';
          document.getElementById('ipsToday').textContent = data.unique_ips_today || '0';
          document.getElementById('ipsTotal').textContent = data.unique_ips_all || '0';
        }
      } catch (error) {
        console.error('Error loading traffic metrics:', error);
      }
    }
    
    // Filter users function
    function filterUsers() {
      const searchTerm = document.getElementById('userSearch').value.toLowerCase();
      const roleFilter = document.getElementById('roleFilter').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
      
      const rows = document.querySelectorAll('#usersTableBody tr');
      
      rows.forEach(row => {
        const username = row.dataset.username;
        const role = row.dataset.role;
        const paid = row.dataset.paid;
        
        const matchesSearch = username.includes(searchTerm);
        const matchesRole = !roleFilter || role === roleFilter;
        const matchesStatus = !statusFilter || 
          (statusFilter === 'paid' && paid === 'paid') ||
          (statusFilter === 'unpaid' && paid !== 'paid');
        
        if (matchesSearch && matchesRole && matchesStatus) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }
    
    // Block user function
    async function blockUser(userId, username) {
      if (!confirm(`Are you sure you want to block user "${username}"?`)) {
        return;
      }
      
      try {
        const response = await fetch('/admin/block-user', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            user_id: userId,
            reason: 'Blocked by admin',
            duration: 24
          })
        });
        
        if (response.ok) {
          showMessage('User blocked successfully', 'success');
          setTimeout(() => location.reload(), 1500);
        } else {
          showMessage('Error blocking user', 'error');
        }
      } catch (error) {
        console.error('Error blocking user:', error);
        showMessage('Error blocking user', 'error');
      }
    }
    
    // Delete user function
    async function deleteUser(userId) {
      if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        return;
      }
      
      try {
        const response = await fetch(`/admin/delete-user/${userId}`, {
          method: 'POST'
        });
        
        if (response.ok) {
          showMessage('User deleted successfully', 'success');
          setTimeout(() => location.reload(), 1500);
        } else {
          showMessage('Error deleting user', 'error');
        }
      } catch (error) {
        console.error('Error deleting user:', error);
        showMessage('Error deleting user', 'error');
      }
    }
    
    // Show message function
    function showMessage(text, type) {
      const existingMessage = document.querySelector('.message');
      if (existingMessage) {
        existingMessage.remove();
      }
      
      const message = document.createElement('div');
      message.className = `message ${type}`;
      message.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        ${text}
      `;
      
      document.querySelector('.user-management-container').insertBefore(
        message, 
        document.querySelector('.page-header')
      );
      
      setTimeout(() => {
        message.remove();
      }, 5000);
    }
    
    // Load last seen data
    async function loadLastSeenData() {
      try {
        const response = await fetch('/api/admin/users/last-seen');
        if (response.ok) {
          const data = await response.json();
          Object.entries(data).forEach(([userId, lastSeen]) => {
            const element = document.getElementById(`lastSeen-${userId}`);
            if (element) {
              const date = new Date(lastSeen);
              const now = new Date();
              const diffMinutes = Math.floor((now - date) / (1000 * 60));
              
              let status, color, text;
              if (diffMinutes < 5) {
                status = 'online';
                color = '#48bb78';
                text = 'Online';
              } else if (diffMinutes < 30) {
                status = 'recent';
                color = '#ed8936';
                text = `${diffMinutes}m ago`;
              } else {
                status = 'offline';
                color = '#a0aec0';
                text = date.toLocaleDateString();
              }
              
              element.innerHTML = `
                <i class="fas fa-circle" style="color: ${color}; font-size: 0.5rem;"></i>
                ${text}
              `;
            }
          });
        }
      } catch (error) {
        console.error('Error loading last seen data:', error);
      }
    }
    
    // Form submission handling
    document.getElementById('createUserForm').addEventListener('submit', function(e) {
      const submitBtn = this.querySelector('button[type="submit"]');
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
      submitBtn.disabled = true;
    });
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      loadTrafficMetrics();
      loadLastSeenData();
      
      // Refresh metrics every 30 seconds
      setInterval(loadTrafficMetrics, 30000);
      
      // Refresh last seen every 60 seconds
      setInterval(loadLastSeenData, 60000);
    });
  </script>
</body>
</html>
<script src="/attached_assets/theme.js"></script>