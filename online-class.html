<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Live Class - Sunrise Education Centre</title>
    <link rel="icon" type="image/png" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap">
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <nav class="navbar glassmorphic">
      <div class="container nav-content">
        <div class="nav-logo">
          <img src="attached_assets/image_1750584670920.png" alt="Logo">
        </div>
        <ul class="nav-links">
          <li><a href="/">Home</a></li>
          <li><a href="/study-resources">Study Resources</a></li>
          <li><a href="/batch">Batch</a></li>
          <li><a href="/forum">Forum</a></li>
          {% if username %}
          <li style="position:relative;">
            <button id="notifBell" style="background:none; border:none; cursor:pointer; position:relative;">
              <svg width="26" height="26" viewBox="0 0 24 24" fill="none" style="vertical-align:middle;"><path d="M12 22c1.1 0 2-.9 2-2h-4a2 2 0 0 0 2 2zm6-6V11c0-3.07-1.63-5.64-5-6.32V4a1 1 0 1 0-2 0v.68C7.63 5.36 6 7.92 6 11v5l-1.29 1.29A1 1 0 0 0 6 19h12a1 1 0 0 0 .71-1.71L18 16z" fill="#6a82fb"/></svg>
              {% if user_notifications and user_notifications|length > 0 %}
              <span style="position:absolute;top:0;right:0;width:10px;height:10px;background:#fc5c7d;border-radius:50%;"></span>
              {% endif %}
            </button>
            <div id="notifDropdown" style="display:none; position:absolute; right:0; top:36px; background:#fff; min-width:260px; box-shadow:0 4px 24px rgba(100,100,255,0.13); border-radius:12px; z-index:100; padding:1rem;">
              <strong style="color:#6a82fb;">Notifications</strong>
              <ul style="list-style:none; padding:0; margin:0;">
                {% if user_notifications and user_notifications|length > 0 %}
                                  {% for notification in user_notifications %}
                  {% if notification|length >= 7 %}
                    {% set id, message, created_at, status, notification_type, scheduled_time, item_type = notification %}
                    {% if item_type == 'personal_chat' %}
                      {% set sender_name = notification[7] if notification|length > 7 else 'User' %}
                      <li class="notification-item personal-chat-item" data-notification-id="{{ id }}" data-type="personal_chat" style="padding:0.5rem 0; border-bottom:1px solid #eee; font-size:0.98rem; color:#232946; cursor:pointer; transition:all 0.2s ease; border-left:3px solid #fc5c7d; padding-left:0.5rem;" onmouseover="this.style.background='#ffe6cc'" onmouseout="this.style.background='transparent'">
                        <div style="display:flex; align-items:center; gap:0.3rem; margin-bottom:0.2rem;">
                          <span style="background:#fc5c7d; color:white; padding:0.1rem 0.4rem; border-radius:8px; font-size:0.7rem; font-weight:600;">üí¨</span>
                          <span style="color:#fc5c7d; font-size:0.9rem; font-weight:600;">@{{ sender_name }}</span>
                        </div>
                        {{ message }}<br><span style="font-size:0.85rem; color:#888;">{{ format_datetime_for_display(created_at) }}</span>
                      </li>
                    {% else %}
                      <li class="notification-item" data-notification-id="{{ id }}" data-type="notification" style="padding:0.5rem 0; border-bottom:1px solid #eee; font-size:0.98rem; color:#232946; cursor:pointer; transition:all 0.2s ease;" onmouseover="this.style.background='#f0f4ff'" onmouseout="this.style.background='transparent'">
                        <div style="display:flex; align-items:center; gap:0.3rem; margin-bottom:0.2rem;">
                          <span style="background:#6a82fb; color:white; padding:0.1rem 0.4rem; border-radius:8px; font-size:0.7rem; font-weight:600;">üì¢</span>
                        </div>
                        {{ message }}<br><span style="font-size:0.85rem; color:#888;">{{ format_datetime_for_display(created_at) }}</span>
                      </li>
                    {% endif %}
                  {% else %}
                    <!-- Fallback for old notification format -->
                    {% set id, message, created_at, status, notification_type, scheduled_time = notification %}
                    <li class="notification-item" data-notification-id="{{ id }}" data-type="notification" style="padding:0.5rem 0; border-bottom:1px solid #eee; font-size:0.98rem; color:#232946; cursor:pointer; transition:all 0.2s ease;" onmouseover="this.style.background='#f0f4ff'" onmouseout="this.style.background='transparent'">
                      <div style="display:flex; align-items:center; gap:0.3rem; margin-bottom:0.2rem;">
                        <span style="background:#6a82fb; color:white; padding:0.1rem 0.4rem; border-radius:8px; font-size:0.7rem; font-weight:600;">üì¢</span>
                      </div>
                      {{ message }}<br><span style="font-size:0.85rem; color:#888;">{{ format_datetime_for_display(created_at) }}</span>
                    </li>
                  {% endif %}
                {% endfor %}
                {% else %}
                  <li style="padding:0.7rem 0; color:#888; text-align:center;">No new notifications.</li>
                {% endif %}
              </ul>
            </div>
          </li>
          {% endif %}
                     {% if username %}
             <li><a href="/logout" class="btn btn-primary">Logout</a></li>
           {% else %}
           <li><a href="/auth" class="btn btn-primary">Login</a></li>
           {% endif %}
</ul>
      </div>
    </nav>
    <header class="hero-section">
      <div class="container hero-content">
        <h1>Join a Live Class</h1>
        <p>Experience interactive, real-time mathematics coaching from anywhere!</p>
      </div>
    </header>
    <main class="container main-content" style="max-width: 100vw;">
      <div style="text-align:center; margin-top:1.5rem;">
        <button id="previewAVBtn" class="btn btn-primary" style="min-width:180px;">Test Audio/Video</button>
      </div>
      <div id="avPreviewDialog" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#fff; border-radius:16px; padding:2rem; max-width:420px; margin:auto; box-shadow:0 8px 32px rgba(0,0,0,0.18); display:flex; flex-direction:column; align-items:center;">
          <h3 style="margin-bottom:1rem; color:#6a82fb;">Audio/Video Preview</h3>
          <div style="margin-bottom:1rem;">
            <label for="videoSelect" style="display:block; margin-bottom:0.5rem; font-weight:500;">Camera:</label>
            <select id="videoSelect" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:6px; margin-bottom:1rem;"></select>
            <label for="audioSelect" style="display:block; margin-bottom:0.5rem; font-weight:500;">Microphone:</label>
            <select id="audioSelect" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:6px; margin-bottom:1rem;"></select>
            <label for="speakerSelect" style="display:block; margin-bottom:0.5rem; font-weight:500;">Speaker:</label>
            <select id="speakerSelect" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:6px; margin-bottom:1rem;"></select>
          </div>
          <video id="previewVideo" width="320" height="240" autoplay muted playsinline style="background:#000; border-radius:10px; margin-bottom:1rem;"></video>
          <div style="margin-bottom:1rem;">
            <button id="testCameraBtn" class="btn btn-primary" style="margin-right:1rem;" onclick="testCameraAndMic()">Test Camera & Mic</button>
            <button id="stopTestBtn" class="btn btn-secondary" onclick="stopTest()">Stop Test</button>
          </div>
          <div id="testStatus" style="margin-bottom:1rem; font-weight:500; color:#666;"></div>
          <div style="margin-bottom:1rem;">
            <button id="testMicBtn" class="btn btn-secondary" style="margin-right:1rem;">Test Microphone</button>
            <span id="micLevel" style="display:inline-block; width:80px; height:10px; background:#eee; border-radius:5px; vertical-align:middle;"></span>
          </div>
          <div style="margin-bottom:1rem;">
            <button id="testSpeakerBtn" class="btn btn-secondary">Test Speaker</button>
            <audio id="testAudio" style="display:none;">
              <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
            </audio>
          </div>
          <button id="closeAVDialog" class="btn btn-primary" style="margin-top:0.5rem;">Close</button>
        </div>
      </div>
      <section class="card-section" style="max-width: 700px; margin: 2rem auto;">
        <div style="display:flex; gap:1.2rem; justify-content:center; margin-bottom:2.2rem;">
          <button class="live-tab-btn tab-btn" onclick="showLiveTab('live')" style="background:#e3f7fc; color:#232946; font-weight:600; border:none; border-radius:12px; padding:0.8rem 2.2rem; font-size:1.1rem; cursor:pointer;">Live</button>
          <button class="upcoming-tab-btn tab-btn" onclick="showLiveTab('upcoming')" style="background:#ffe082; color:#232946; font-weight:600; border:none; border-radius:12px; padding:0.8rem 2.2rem; font-size:1.1rem; cursor:pointer;">Upcoming</button>
          <button class="schedule-tab-btn tab-btn" onclick="showLiveTab('schedule')" style="background:#d1c4e9; color:#232946; font-weight:600; border:none; border-radius:12px; padding:0.8rem 2.2rem; font-size:1.1rem; cursor:pointer;">Completed</button>
        </div>
        <div id="live-tab-content" class="tab-content" style="display:block;">
          <h2 style="text-align:center;">Live Classes</h2>
          <p style="text-align:center;">Join ongoing live classes here.</p>
          {% if active_classes and active_classes|length > 0 %}
            <div class="live-class-cards" style="display:flex; flex-wrap:wrap; gap:2rem; justify-content:center;">
              {% for c in active_classes %}
                <div class="card-section" style="min-width:260px; max-width:340px; background:#f4f4f4; border-radius:14px; box-shadow:0 2px 8px rgba(100,100,255,0.07); padding:1.5rem;">
                  <h3 style="color:#6a82fb;">{{ c[4] or 'Live Class' }}</h3>
                  {% if c|length > 12 %}
                  <div style="font-size:0.96rem; color:#555; margin:0.2rem 0 0.6rem 0;">
                    {% set subj = c[13] %}{% if subj %}<strong>Subject:</strong> {{ subj|capitalize }}{% endif %}
                    {% if c[14] %}{% if subj %} ‚Ä¢ {% endif %}<strong>Teacher:</strong> {{ c[14] }}{% endif %}
                    {% if c[9] %}
                      <br><strong>Target:</strong> Class {{ c[9] }}{% if c[9] in ['11','12'] and c[10] %} ({{ c[10]|capitalize }}){% endif %}
                    {% endif %}
                  </div>
                  {% endif %}
                  <div style="font-size:1.1rem; color:#232946; margin-bottom:0.7rem;"><strong>Class Code:</strong> {{ c[1] }}</div>
                  <div style="font-size:0.98rem; color:#888; margin-bottom:1.2rem;">{{ c[5] or '' }}</div>
                  <a href="/join-class/{{ c[0] }}" class="btn btn-primary" style="width:auto; min-width:90px; margin-top:0.7rem;">Join</a>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p style="text-align:center;">No live classes are currently active.</p>
          {% endif %}
        </div>
        <div id="upcoming-tab-content" class="tab-content" style="display:none;">
          <h2 style="text-align:center;">Upcoming Classes</h2>
          <p style="text-align:center;">See which classes are scheduled to go live soon.</p>
          {% if upcoming_classes and upcoming_classes|length > 0 %}
            <div class="live-class-cards" style="display:flex; flex-wrap:wrap; gap:2rem; justify-content:center;">
              {% for c in upcoming_classes %}
                <div class="card-section" style="min-width:260px; max-width:340px; background:#f4f4f4; border-radius:14px; box-shadow:0 2px 8px rgba(100,100,255,0.07); padding:1.5rem;">
                  <h3 style="color:#ffa726;">{{ c[4] or 'Upcoming Class' }}</h3>
                  {% if c|length > 12 %}
                  <div style="font-size:0.96rem; color:#555; margin:0.2rem 0 0.6rem 0;">
                    {% set subj = c[13] %}{% if subj %}<strong>Subject:</strong> {{ subj|capitalize }}{% endif %}
                    {% if c[14] %}{% if subj %} ‚Ä¢ {% endif %}<strong>Teacher:</strong> {{ c[14] }}{% endif %}
                    {% if c[9] %}
                      <br><strong>Target:</strong> Class {{ c[9] }}{% if c[9] in ['11','12'] and c[10] %} ({{ c[10]|capitalize }}){% endif %}
                    {% endif %}
                  </div>
                  {% endif %}
                  <div style="font-size:1.1rem; color:#232946; margin-bottom:0.7rem;"><strong>Class Code:</strong> {{ c[1] }}</div>
                  <div style="font-size:0.98rem; color:#888; margin-bottom:1.2rem;">{{ c[5] or '' }}</div>
                  {% if c[8] %}<div style="font-size:0.95rem; color:#888;">Scheduled: {{ c[8] }}</div>{% endif %}
                  <button class="btn btn-secondary" style="width:auto; min-width:90px; margin-top:0.7rem; background:#ccc; color:#888; cursor:not-allowed;" disabled>Pending</button>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p style="text-align:center;">No upcoming classes scheduled.</p>
          {% endif %}
        </div>
        <div id="schedule-tab-content" class="tab-content" style="display:none;">
          <h2 style="text-align:center;">Completed Classes</h2>
          <p style="text-align:center;">View the full schedule of all completed classes.</p>
          {% if completed_classes and completed_classes|length > 0 %}
            <div class="live-class-cards" style="display:flex; flex-wrap:wrap; gap:2rem; justify-content:center;">
              {% for c in completed_classes %}
                <div class="card-section" style="min-width:260px; max-width:340px; background:#f4f4f4; border-radius:14px; box-shadow:0 2px 8px rgba(100,100,255,0.07); padding:1.5rem;">
                  <h3 style="color:#9e9e9e;">{{ c[4] or 'Completed Class' }}</h3>
                  {% if c|length > 12 %}
                  <div style="font-size:0.96rem; color:#555; margin:0.2rem 0 0.6rem 0;">
                    {% set subj = c[13] %}{% if subj %}<strong>Subject:</strong> {{ subj|capitalize }}{% endif %}
                    {% if c[14] %}{% if subj %} ‚Ä¢ {% endif %}<strong>Teacher:</strong> {{ c[14] }}{% endif %}
                    {% if c[9] %}
                      <br><strong>Target:</strong> Class {{ c[9] }}{% if c[9] in ['11','12'] and c[10] %} ({{ c[10]|capitalize }}){% endif %}
                    {% endif %}
                  </div>
                  {% endif %}
                  <div style="font-size:1.1rem; color:#232946; margin-bottom:0.7rem;"><strong>Class Code:</strong> {{ c[1] }}</div>
                  <div style="font-size:0.98rem; color:#888; margin-bottom:1.2rem;">{{ c[5] or '' }}</div>
                  {% if c[8] %}<div style="font-size:0.95rem; color:#888;">Scheduled: {{ c[8] }}</div>{% endif %}
                  {% if c[3] %}
                    <a href="{{ c[3] }}" class="btn btn-primary" style="width:auto; min-width:90px; margin-top:0.7rem;" target="_blank">View Recording</a>
                  {% else %}
                    <button class="btn btn-secondary" style="width:auto; min-width:90px; margin-top:0.7rem; background:#ccc; color:#888; cursor:not-allowed;" disabled>No Recording</button>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p style="text-align:center;">No completed classes yet.</p>
          {% endif %}
        </div>
      </section>
      <div style="text-align:center; margin: 1.5rem 0 2rem 0;">
        <button id="darkModeToggle" class="btn btn-primary" style="min-width:160px;">Toggle Dark Mode</button>
      </div>
    </main>
    <footer class="footer" style="background:#181c2a; color:#fff;">
      <div class="container footer-content">
        <div class="footer-social" style="display:flex; gap:1.2rem;">
          <a href="https://www.instagram.com/sunrise_education_centre?igsh=OGc5enlsanE0eWJ2" target="_blank">Instagram</a>
          <a href="https://youtube.com/@sunriseeducationcentre" target="_blank">YouTube</a>
        </div>
        <div class="footer-links">
          <a href="#">Privacy Policy</a>
          <a href="#">Contact Us</a>
        </div>
        <div class="footer-copy">&copy; 2024 Sunrise Education Centre</div>
      </div>
    </footer>
    <script>
      function showLiveTab(tab) {
        document.getElementById('live-tab-content').style.display = (tab === 'live') ? 'block' : 'none';
        document.getElementById('upcoming-tab-content').style.display = (tab === 'upcoming') ? 'block' : 'none';
        document.getElementById('schedule-tab-content').style.display = (tab === 'schedule') ? 'block' : 'none';
        document.querySelector('.live-tab-btn').style.background = (tab === 'live') ? '#e3f7fc' : '#f1f3f5';
        document.querySelector('.upcoming-tab-btn').style.background = (tab === 'upcoming') ? '#ffe082' : '#f1f3f5';
        document.querySelector('.schedule-tab-btn').style.background = (tab === 'schedule') ? '#d1c4e9' : '#f1f3f5';
        
        // Refresh class status when tab is changed
        refreshClassStatus();
      }

      // Auto-refresh class status every 30 seconds
      function refreshClassStatus() {
        fetch('/api/live-classes/status')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Check if page needs to be refreshed due to status changes
              const hasActiveClasses = data.active && data.active.length > 0;
              const hasUpcomingClasses = data.upcoming && data.upcoming.length > 0;
              const hasCompletedClasses = data.completed && data.completed.length > 0;
              
              // If significant changes detected, refresh the page
              if (shouldRefreshPage(hasActiveClasses, hasUpcomingClasses, hasCompletedClasses)) {
                console.log('Class status changed, refreshing page...');
                window.location.reload();
              }
            }
          })
          .catch(error => {
            console.log('Status check failed:', error);
          });
      }

      // Check if page should be refreshed based on status changes
      function shouldRefreshPage(hasActive, hasUpcoming, hasCompleted) {
        const currentActiveClasses = document.querySelectorAll('#live-tab-content .card-section').length;
        const currentUpcomingClasses = document.querySelectorAll('#upcoming-tab-content .card-section').length;
        const currentCompletedClasses = document.querySelectorAll('#schedule-tab-content .card-section').length;
        
        // Refresh if active classes count changed significantly
        return (hasActive && currentActiveClasses === 0) || (!hasActive && currentActiveClasses > 0);
      }

      // Start auto-refresh when page loads
      setInterval(refreshClassStatus, 30000); // 30 seconds

      const notifBell = document.getElementById('notifBell');
      const notifDropdown = document.getElementById('notifDropdown');
      if (notifBell && notifDropdown) {
        // Handled globally in script.js. Keep only page-specific logic below.
      }

      // Audio/Video Preview Dialog
      const previewBtn = document.getElementById('previewAVBtn');
      const avDialog = document.getElementById('avPreviewDialog');
      const closeAVDialog = document.getElementById('closeAVDialog');
      const previewVideo = document.getElementById('previewVideo');
      const testMicBtn = document.getElementById('testMicBtn');
      const micLevel = document.getElementById('micLevel');
      const testSpeakerBtn = document.getElementById('testSpeakerBtn');
      const testAudio = document.getElementById('testAudio');
      const videoSelect = document.getElementById('videoSelect');
      const audioSelect = document.getElementById('audioSelect');
      const speakerSelect = document.getElementById('speakerSelect');
      let avStream = null;
      let audioContext = null;
      let analyser = null;
      let micSource = null;
      let animationId = null;

      // Load available devices
      async function loadDevices() {
        try {
          const devices = await navigator.mediaDevices.enumerateDevices();
          videoSelect.innerHTML = '';
          audioSelect.innerHTML = '';
          speakerSelect.innerHTML = '';
          
          devices.forEach(device => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            option.text = device.label || `${device.kind} ${device.deviceId.slice(0, 8)}`;
            
            if (device.kind === 'videoinput') {
              videoSelect.appendChild(option);
            } else if (device.kind === 'audioinput') {
              audioSelect.appendChild(option);
            }
          });
          
          // For speakers, we'll use a simple test
          const speakerOption = document.createElement('option');
          speakerOption.value = 'default';
          speakerOption.text = 'Default Speaker';
          speakerSelect.appendChild(speakerOption);
        } catch (err) {
          console.error('Error loading devices:', err);
        }
      }

      previewBtn.onclick = async function() {
        avDialog.style.display = 'flex';
        await loadDevices();
        
        try {
          const constraints = {
            video: { deviceId: videoSelect.value ? { exact: videoSelect.value } : undefined },
            audio: { deviceId: audioSelect.value ? { exact: audioSelect.value } : undefined }
          };
          
          avStream = await navigator.mediaDevices.getUserMedia(constraints);
          previewVideo.srcObject = avStream;
        } catch (err) {
          console.error('Error accessing media devices:', err);
          alert('Could not access camera/microphone. Please check permissions and try again.');
        }
      };

      closeAVDialog.onclick = function() {
        avDialog.style.display = 'none';
        if (avStream) {
          avStream.getTracks().forEach(track => track.stop());
          avStream = null;
        }
        if (audioContext) {
          audioContext.close();
          audioContext = null;
        }
        if (animationId) {
          cancelAnimationFrame(animationId);
          animationId = null;
        }
        micLevel.style.background = '#eee';
      };

      testMicBtn.onclick = function() {
        if (!avStream) return;
        if (audioContext) {
          audioContext.close();
          audioContext = null;
          micLevel.style.background = '#eee';
          return;
        }
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        micSource = audioContext.createMediaStreamSource(avStream);
        analyser = audioContext.createAnalyser();
        micSource.connect(analyser);
        analyser.fftSize = 256;
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        function draw() {
          analyser.getByteTimeDomainData(dataArray);
          let sum = 0;
          for (let i = 0; i < dataArray.length; i++) {
            sum += Math.abs(dataArray[i] - 128);
          }
          let avg = sum / dataArray.length;
          let percent = Math.min(1, avg / 30);
          micLevel.style.background = `linear-gradient(90deg, #6a82fb ${percent*100}%, #eee ${percent*100}%)`;
          animationId = requestAnimationFrame(draw);
        }
        draw();
      };

      testSpeakerBtn.onclick = function() {
        testAudio.currentTime = 0;
        testAudio.play().catch(err => {
          console.error('Error playing test audio:', err);
          alert('Could not play test audio. Please check your speaker settings.');
        });
      };

      // Handle device changes
      videoSelect.onchange = audioSelect.onchange = async function() {
        if (avStream) {
          avStream.getTracks().forEach(track => track.stop());
        }
        
        try {
          const constraints = {
            video: { deviceId: videoSelect.value ? { exact: videoSelect.value } : undefined },
            audio: { deviceId: audioSelect.value ? { exact: audioSelect.value } : undefined }
          };
          
          avStream = await navigator.mediaDevices.getUserMedia(constraints);
          previewVideo.srcObject = avStream;
        } catch (err) {
          console.error('Error switching devices:', err);
          alert('Could not switch to selected device. Please try again.');
        }
      };

      // Test camera and microphone
      async function testCameraAndMic() {
        const testVideo = document.getElementById('testVideo');
        const micLevel = document.getElementById('micLevel');
        const testStatus = document.getElementById('testStatus');
        
        testStatus.textContent = 'Testing camera and microphone...';
        
        try {
          // Check browser support
          if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            testStatus.textContent = '‚ùå Camera/microphone not supported in this browser';
            return;
          }
          
          // Get user media
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: true, 
            audio: true 
          });
          
          // Show video preview
          testVideo.srcObject = stream;
          testVideo.style.display = 'block';
          
          // Test microphone level
          const audioContext = new AudioContext();
          const source = audioContext.createMediaStreamSource(stream);
          const analyser = audioContext.createAnalyser();
          source.connect(analyser);
          
          const dataArray = new Uint8Array(analyser.frequencyBinCount);
          
          function updateMicLevel() {
            analyser.getByteFrequencyData(dataArray);
            const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
            const level = Math.min(100, (average / 128) * 100);
            
            micLevel.style.width = level + '%';
            micLevel.style.backgroundColor = level > 50 ? '#10b981' : level > 20 ? '#f59e0b' : '#ef4444';
            
            if (stream.active) {
              requestAnimationFrame(updateMicLevel);
            }
          }
          
          updateMicLevel();
          
          testStatus.textContent = '‚úÖ Camera and microphone working!';
          testStatus.style.color = '#059669';
          
          // Store stream for cleanup
          window.testStream = stream;
          
        } catch (err) {
          console.error('Test error:', err);
          let errorMsg = 'Failed to access camera/microphone';
          
          if (err.name === 'NotAllowedError') {
            errorMsg = '‚ùå Permission denied. Please allow camera and microphone access.';
          } else if (err.name === 'NotFoundError') {
            errorMsg = '‚ùå No camera or microphone found.';
          } else if (err.name === 'NotReadableError') {
            errorMsg = '‚ùå Camera/microphone is already in use by another app.';
          } else {
            errorMsg = `‚ùå Error: ${err.message}`;
          }
          
          testStatus.textContent = errorMsg;
          testStatus.style.color = '#dc2626';
        }
      }
      
      // Stop test stream
      function stopTest() {
        if (window.testStream) {
          window.testStream.getTracks().forEach(track => track.stop());
          window.testStream = null;
        }
        const testVideo = document.getElementById('testVideo');
        testVideo.style.display = 'none';
        testVideo.srcObject = null;
      }
    </script>
    <style>
      body.dark-mode, .dark-mode body {
        background: #181c2a !important;
        color: #f4f4f4 !important;
      }
      body.dark-mode .card-section, .dark-mode .card-section {
        background: #232946 !important;
        color: #f4f4f4 !important;
        box-shadow: 0 4px 32px rgba(35,41,70,0.25) !important;
      }
      body.dark-mode .navbar, .dark-mode .navbar {
        background: #232946 !important;
        color: #f4f4f4 !important;
      }
      body.dark-mode .btn, .dark-mode .btn {
        background: #232946 !important;
        color: #fff !important;
        border-color: #6a82fb !important;
      }
      body.dark-mode input, body.dark-mode select, body.dark-mode textarea,
      .dark-mode input, .dark-mode select, .dark-mode textarea {
        background: #181c2a !important;
        color: #f4f4f4 !important;
        border: 1.5px solid #444a6d !important;
      }
      body.dark-mode input:focus, body.dark-mode select:focus, body.dark-mode textarea:focus,
      .dark-mode input:focus, .dark-mode select:focus, .dark-mode textarea:focus {
        border-color: #6a82fb !important;
        background: #232946 !important;
      }
      body.dark-mode .footer, .dark-mode .footer {
        background: #181c2a !important;
        color: #fff !important;
      }
      body.dark-mode .btn-primary, .dark-mode .btn-primary {
        background: linear-gradient(90deg, #232946 0%, #6a82fb 100%) !important;
        color: #fff !important;
      }
      body.dark-mode .btn-primary:hover, .dark-mode .btn-primary:hover {
        background: linear-gradient(90deg, #6a82fb 0%, #232946 100%) !important;
      }
      .live-class-cards .card-section {
        min-width:260px;
        max-width:340px;
        background:#f4f4f4;
        border-radius:14px;
        box-shadow:0 2px 8px rgba(100,100,255,0.07);
        padding:1.5rem;
        margin-bottom: 1rem;
        color: #232946;
        border: 1px solid #e0e7ff;
        transition: background 0.2s, color 0.2s;
      }
      body.dark-mode .live-class-cards .card-section {
        background: #232946;
        color: #fff;
        border: 1px solid #44476a;
        box-shadow: 0 2px 12px rgba(40,40,80,0.18);
      }
      body.dark-mode .live-class-cards .card-section h3 {
        color: #6a82fb;
      }
      body.dark-mode .live-class-cards .card-section a.btn-primary {
        background: linear-gradient(135deg, #6a82fb 0%, #5a6fd8 100%);
        color: #fff;
      }
      body.dark-mode .live-class-cards .card-section a.btn-primary:hover {
        background: linear-gradient(135deg, #5a6fd8 0%, #6a82fb 100%);
      }
      body.dark-mode .live-class-cards .card-section strong,
      body.dark-mode .live-class-cards .card-section .class-code,
      body.dark-mode .live-class-cards .card-section .class-description {
        color: #e0e7ff;
      }
      
      /* Mobile Responsive Styles */
      @media (max-width: 768px) {
        .card-section {
          padding: 1rem;
          margin: 1rem 0;
        }
        
        .live-class-cards {
          flex-direction: column;
          align-items: center;
        }
        
        .live-class-cards .card-section {
          min-width: auto;
          max-width: 100%;
          width: 100%;
          margin: 0.5rem 0;
        }
        
        .tab-btn {
          padding: 0.6rem 1.2rem !important;
          font-size: 0.9rem !important;
          margin: 0 0.3rem;
        }
        
        .container {
          padding: 0 1rem;
        }
      }
      
      @media (max-width: 480px) {
        .card-section {
          padding: 0.8rem;
        }
        
        .live-class-cards .card-section {
          padding: 1rem;
        }
        
        .tab-btn {
          padding: 0.5rem 1rem !important;
          font-size: 0.8rem !important;
          margin: 0 0.2rem;
        }
        
        .container {
          padding: 0 0.5rem;
        }
        
        h2 {
          font-size: 1.5rem;
        }
        
        h3 {
          font-size: 1.2rem;
        }
      }
      
      @media (max-width: 320px) {
        .card-section {
          padding: 0.5rem;
        }
        
        .live-class-cards .card-section {
          padding: 0.8rem;
        }
        
        .tab-btn {
          padding: 0.4rem 0.8rem !important;
          font-size: 0.75rem !important;
          margin: 0 0.1rem;
        }
        
        .container {
          padding: 0 0.3rem;
        }
        
        h2 {
          font-size: 1.3rem;
        }
        
        h3 {
          font-size: 1.1rem;
        }
      }
    </style>
    <script src="script.js"></script>
    <script>
      // Dark Mode functionality
      function setupDarkMode() {
          const isDarkMode = localStorage.getItem('darkMode') === 'true';
          if (isDarkMode) {
              document.body.classList.add('dark-mode');
              updateToggleButton();
          }
      }

      function toggleDarkMode() {
          document.body.classList.toggle('dark-mode');
          const isDarkMode = document.body.classList.contains('dark-mode');
          localStorage.setItem('darkMode', isDarkMode);
          updateToggleButton();
      }

      function updateToggleButton() {
          const button = document.getElementById('darkModeToggle');
          if (button) {
              const isDark = document.body.classList.contains('dark-mode');
              button.innerHTML = isDark ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
              button.style.background = isDark ? 'rgba(255,255,255,0.1)' : 'transparent';
              button.style.color = isDark ? '#fff' : '#6a82fb';
              button.style.borderColor = isDark ? '#fff' : '#6a82fb';
          }
      }

      // Initialize dark mode on page load
      document.addEventListener('DOMContentLoaded', function() {
          setupDarkMode();
          
          const darkModeToggle = document.getElementById('darkModeToggle');
          if (darkModeToggle) {
              darkModeToggle.addEventListener('click', toggleDarkMode);
          }
      });
    </script>
  </body>
</html>
