<!DOCTYPE html>
<html>
<head>
  <title>Host Live Class - {{ topic or 'Live Class' }}</title>
  <link rel="stylesheet" href="style.css" />
  <script src="script.js"></script>
  <style>
    .host-container { display: flex; max-width: 1400px; margin: 2rem auto; background: #fff; border-radius: 18px; box-shadow: 0 4px 24px rgba(100,100,255,0.10); }
    .video-section { flex: 2; padding: 2rem; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%); }
    .control-section { flex: 1; padding: 2rem; border-left: 1.5px solid #eee; display: flex; flex-direction: column; background: #fff; max-height: 90vh; overflow-y: auto; }
    .video-player { width: 100%; max-width: 640px; height: 360px; background: #000; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.15); margin-bottom: 1.5rem; }
    .class-info { width: 100%; max-width: 640px; text-align: left; }
    .class-title { font-size: 1.5rem; font-weight: 600; color: #232946; margin-bottom: 0.5rem; }
    .class-description { color: #666; line-height: 1.5; margin-bottom: 1rem; }
    .back-link { color: #6a82fb; text-decoration: none; font-weight: 500; }
    .back-link:hover { text-decoration: underline; }
    
    .tab-container { display: flex; margin-bottom: 1rem; border-bottom: 2px solid #e0e7ff; justify-content: flex-end; gap: 0.5rem; }
    .tab-btn { padding: 0.8rem; background: none; border: none; cursor: pointer; font-weight: 500; color: #666; transition: all 0.2s; }
    .tab-btn.active { color: #6a82fb; border-bottom: 2px solid #6a82fb; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .chat-card { background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%); border-radius:12px; box-shadow: 0 4px 16px rgba(100,100,255,0.08); padding:1.2rem; border: 1px solid #e0e7ff; margin-bottom: 1rem; }
    .chat-messages { max-height: 200px; overflow-y:auto; margin-bottom:0.7rem; border-bottom:1px solid #e0e7ff; padding-bottom:0.5rem; font-size:0.95rem; }
    .chat-input { width: 100%; border-radius:8px; border:1px solid #e0e7ff; padding:0.5rem 0.8rem; background: #fff; margin-bottom: 0.5rem; }
    .chat-input:focus { outline: none; border-color: #6a82fb; box-shadow: 0 0 0 2px rgba(106,130,251,0.1); }
    .chat-send-btn { border-radius:8px; background: linear-gradient(135deg, #6a82fb 0%, #5a6fd8 100%); border: none; color: #fff; padding: 0.5rem 1rem; cursor: pointer; transition: all 0.2s; }
    .chat-send-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(106,130,251,0.3); }
    .chat-message { margin: 0.3rem 0; padding: 0.4rem 0.7rem; background: #fff; border-radius: 7px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-left: 3px solid #6a82fb; }
    
    /* Chat Control Buttons */
    .chat-control-btn { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.8rem; border: 1px solid #e0e7ff; border-radius: 8px; background: #fff; color: #6a82fb; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; font-weight: 500; }
    .chat-control-btn:hover { background: #f8f9ff; border-color: #6a82fb; transform: translateY(-1px); }
    .chat-control-btn.locked { background: #ffe6e6; border-color: #fc5c7d; color: #fc5c7d; }
    .chat-control-btn.private { background: #e6f7ff; border-color: #38b2ac; color: #38b2ac; }
    .chat-control-btn svg { width: 18px; height: 18px; }
    
    /* Enhanced Chat Control Buttons */
    .chat-control-btn.clear-chat { 
      background: #fff3cd; 
      border-color: #ffeaa7; 
      color: #856404; 
    }
    .chat-control-btn.clear-chat:hover { 
      background: #ffeaa7; 
      border-color: #fdcb6e; 
      transform: translateY(-1px); 
    }
    
    .chat-control-btn.export-chat { 
      background: #d1ecf1; 
      border-color: #bee5eb; 
      color: #0c5460; 
    }
    .chat-control-btn.export-chat:hover { 
      background: #bee5eb; 
      border-color: #86cfda; 
      transform: translateY(-1px); 
    }
    
    /* Chat Message Animations */
    .chat-message {
      transition: all 0.3s ease;
      animation: slideInMessage 0.3s ease-out;
    }
    
    @keyframes slideInMessage {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Typing Indicator */
    .typing-indicator {
      opacity: 0.7;
      font-style: italic;
      color: #666;
      padding: 0.5rem;
      background: #f8f9ff;
      border-radius: 8px;
      margin: 0.5rem 0;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 0.4; }
    }
    
    .poll-section { background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%); border-radius:12px; padding:1.2rem; border: 1px solid #e0e7ff; margin-bottom: 1rem; }
    .poll-input { width: 100%; border-radius:8px; border:1px solid #e0e7ff; padding:0.5rem 0.8rem; background: #fff; margin-bottom: 0.5rem; }
    .poll-option { display: flex; align-items: center; margin-bottom: 0.5rem; }
    .poll-option input { margin-right: 0.5rem; }
    .poll-option label { flex: 1; }
    .poll-btn { border-radius:8px; background: linear-gradient(135deg, #fc5c7d 0%, #e74c3c 100%); border: none; color: #fff; padding: 0.5rem 1rem; cursor: pointer; transition: all 0.2s; }
    .poll-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(252,92,125,0.3); }
    
    .doubts-section { background: linear-gradient(135deg, #f0fff4 0%, #e8f5e8 100%); border-radius:12px; padding:1.2rem; border: 1px solid #c6f6d5; margin-bottom: 1rem; }
    .doubt-item { background: #fff; border-radius: 8px; padding: 0.8rem; margin-bottom: 0.5rem; border-left: 3px solid #48bb78; }
    .doubt-user { font-weight: 600; color: #2d3748; font-size: 0.9rem; }
    .doubt-text { color: #4a5568; margin-top: 0.3rem; }
    .doubt-actions { margin-top: 0.5rem; }
    .doubt-btn { border-radius: 6px; border: none; padding: 0.3rem 0.6rem; font-size: 0.8rem; cursor: pointer; margin-right: 0.3rem; }
    .resolve-btn { background: #48bb78; color: #fff; }
    .ignore-btn { background: #e2e8f0; color: #4a5568; }
    
    .host-controls { background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%); border-radius:12px; padding:1.2rem; border: 1px solid #81e6d9; margin-bottom: 1rem; }
    .control-btn { width: 100%; border-radius:8px; border: none; padding: 0.8rem; margin-bottom: 0.5rem; cursor: pointer; font-weight: 500; transition: all 0.2s; }
    .end-class-btn { background: linear-gradient(135deg, #fc5c7d 0%, #e74c3c 100%); color: #fff; }
    .end-class-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(252,92,125,0.3); }
    .mute-all-btn { background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%); color: #fff; }
    .mute-all-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(246,173,85,0.3); }
    
    @media (max-width: 1200px) {
      .host-container { flex-direction: column; }
      .control-section { border-left: none; border-top: 1.5px solid #eee; }
      .video-section, .control-section { padding: 1.2rem; }
    }
    
    /* Dark Mode Styles */
    body.dark-mode {
      background: #1a1a2e;
      color: #fff;
    }
    
    body.dark-mode .host-container {
      background: #232946;
      box-shadow: 0 4px 24px rgba(100,100,255,0.20);
    }
    
    body.dark-mode .video-section {
      background: linear-gradient(135deg, #232946 0%, #1a1a2e 100%);
    }
    
    body.dark-mode .control-section {
      background: #232946;
      border-left-color: #2a2a3a;
    }
    
    body.dark-mode .class-title {
      color: #fff;
    }
    
    body.dark-mode .class-description {
      color: #b8c5d6;
    }
    
    body.dark-mode .chat-card,
    body.dark-mode .poll-section,
    body.dark-mode .doubts-section,
    body.dark-mode .host-controls {
      background: #2a2a3a;
      border-color: #3a3a4a;
    }
    
    body.dark-mode .chat-input,
    body.dark-mode .poll-input {
      background: #1a1a2e;
      border-color: #3a3a4a;
      color: #fff;
    }
    
    body.dark-mode .chat-input:focus,
    body.dark-mode .poll-input:focus {
      border-color: #6a82fb;
    }
    
    body.dark-mode .chat-message {
      background: #1a1a2e;
      border-left-color: #6a82fb;
    }
    
    body.dark-mode .chat-control-btn {
      background: #1a1a2e;
      border-color: #3a3a4a;
      color: #6a82fb;
    }
    
    body.dark-mode .chat-control-btn:hover {
      background: #2a2a3a;
      border-color: #6a82fb;
    }
    
    body.dark-mode .chat-control-btn.locked {
      background: #2a1a1a;
      border-color: #fc5c7d;
      color: #fc5c7d;
    }
    
    body.dark-mode .chat-control-btn.private {
      background: #1a2a2a;
      border-color: #38b2ac;
      color: #38b2ac;
    }
    
    body.dark-mode .doubt-item {
      background: #1a1a2e;
      border-left-color: #48bb78;
    }
    
    body.dark-mode .doubt-user {
      color: #fff;
    }
    
    body.dark-mode .doubt-text {
      color: #b8c5d6;
    }
    
    body.dark-mode .tab-btn {
      color: #b8c5d6;
    }
    
    body.dark-mode .tab-btn.active {
      color: #6a82fb;
      border-bottom-color: #6a82fb;
    }
    
    body.dark-mode .tab-container {
      border-bottom-color: #3a3a4a;
    }
    .live-watch-container { width: 100%; max-width: 680px; background: #fff; border: 1px solid #e0e7ff; border-radius: 12px; box-shadow: 0 6px 24px rgba(100,100,255,0.12); padding: 0.8rem; margin-bottom: 1.5rem; }
    body.dark-mode .live-watch-container { background: #232946; border-color: #3a3a4a; box-shadow: 0 6px 24px rgba(0,0,0,0.3); }
    
    /* Icon-only video controls */
    .video-controls { display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; padding: 1rem; background: rgba(106,130,251,0.05); border-radius: 12px; }
    .icon-btn { width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: all 0.3s ease; position: relative; }
    .icon-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.2); }
    .icon-btn.active { box-shadow: 0 0 0 3px rgba(106,130,251,0.3); }
    .icon-btn-start { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: #fff; }
    .icon-btn-stop { background: linear-gradient(135deg, #fc5c7d 0%, #e74c3c 100%); color: #fff; }
    .icon-btn-mic { background: linear-gradient(135deg, #6a82fb 0%, #5a6fd8 100%); color: #fff; }
    .icon-btn-mic.muted { background: linear-gradient(135deg, #fc5c7d 0%, #e74c3c 100%); }
    .icon-btn-camera { background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%); color: #fff; }
    .icon-btn-content { background: linear-gradient(135deg, #38b2ac 0%, #319795 100%); color: #fff; }
    
    /* Tooltip for icon buttons */
    .icon-btn::after { content: attr(title); position: absolute; bottom: -35px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .icon-btn:hover::after { opacity: 1; }
    
    body.dark-mode .video-controls { background: rgba(35,41,70,0.3); }
    body.dark-mode .icon-btn::after { background: #1a1a2e; }
    
    /* Device Selection Styles */
    .device-selection { margin-top: 1rem; padding: 1rem; background: rgba(106,130,251,0.03); border-radius: 12px; border: 1px solid #e0e7ff; }
    .device-row { display: flex; gap: 1rem; margin-bottom: 0.8rem; align-items: center; }
    .device-row:last-child { margin-bottom: 0; }
    .device-label { min-width: 80px; font-weight: 500; color: #232946; font-size: 0.9rem; }
    .device-select { flex: 1; padding: 0.6rem 0.8rem; border: 1px solid #e0e7ff; border-radius: 8px; background: #fff; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; }
    .device-select:focus { outline: none; border-color: #6a82fb; box-shadow: 0 0 0 2px rgba(106,130,251,0.1); }
    .device-select:hover { border-color: #b8c5d6; }
    .device-icon { width: 20px; height: 20px; color: #6a82fb; }
    .device-status { font-size: 0.8rem; color: #666; margin-top: 0.5rem; }
    
    /* Dark mode device selection */
    body.dark-mode .device-selection { background: rgba(35,41,70,0.2); border-color: #3a3a4a; }
    body.dark-mode .device-label { color: #e0e7ff; }
    body.dark-mode .device-select { background: #232946; border-color: #3a3a4a; color: #fff; }
    body.dark-mode .device-select:focus { border-color: #6a82fb; }
    body.dark-mode .device-status { color: #b8c5d6; }
    
    /* Dark Mode Chat Controls */
    body.dark-mode .chat-control-btn.clear-chat { 
      background: #2d1b0e; 
      border-color: #4a2c0f; 
      color: #fdcb6e; 
    }
    body.dark-mode .chat-control-btn.clear-chat:hover { 
      background: #4a2c0f; 
      border-color: #fdcb6e; 
    }
    
    body.dark-mode .chat-control-btn.export-chat { 
      background: #0c2b2e; 
      border-color: #1a4a4e; 
      color: #86cfda; 
    }
    body.dark-mode .chat-control-btn.export-chat:hover { 
      background: #1a4a4e; 
      border-color: #86cfda; 
    }
    
    body.dark-mode .typing-indicator {
      background: #2a2a3a;
      color: #b8c5d6;
    }
  </style>
</head>
<body>
  <!-- Notification Bell for Host -->
  {% if username %}
  <div id="notifBellContainer" style="position:fixed; top:20px; right:20px; z-index:9999;">
    <button id="notifBell" style="background:none; border:none; cursor:pointer; position:relative; z-index:10000; padding:0;">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none" style="vertical-align:middle;"><path d="M12 22c1.1 0 2-.9 2-2h-4a2 2 0 0 0 2 2zm6-6V11c0-3.07-1.63-5.64-5-6.32V4a1 1 0 1 0-2 0v.68C7.63 5.36 6 7.92 6 11v5l-1.29 1.29A1 1 0 0 0 6 19h12a1 1 0 0 0 .71-1.71L18 16z" fill="#6a82fb"/></svg>
      {% if user_notifications and user_notifications|length > 0 %}
      <span style="position:absolute;top:0;right:0;width:10px;height:10px;background:#fc5c7d;border-radius:50%;"></span>
      {% endif %}
    </button>
    <div id="notifDropdown" style="display:none; position:absolute; right:0; top:36px; background:#fff; min-width:320px; box-shadow:0 4px 24px rgba(100,100,255,0.13); border-radius:12px; z-index:10001; padding:1rem;">
      <strong style="color:#6a82fb; font-size:1.15rem;">Notifications</strong>
      <ul style="list-style:none; padding:0; margin:0; max-height:320px; overflow-y:auto;">
        {% if user_notifications and user_notifications|length > 0 %}
                          {% for notification in user_notifications %}
                  {% if notification|length >= 7 %}
                    {% set id, message, created_at, status, notification_type, scheduled_time, item_type = notification %}
                    {% if item_type == 'personal_chat' %}
                      {% set sender_name = notification[7] if notification|length > 7 else 'User' %}
                      <li class="notification-item personal-chat-item" data-notification-id="{{ id }}" data-type="personal_chat" style="padding:0.9rem 1.2rem; border-bottom:1px solid #eee; font-size:1.05rem; color:#232946; background:#fff3e0; border-radius:10px; margin-bottom:0.7rem; cursor:pointer; transition:all 0.2s ease; border-left:4px solid #fc5c7d;" onmouseover="this.style.background='#ffe6cc'" onmouseout="this.style.background='#fff3e0'">
                        <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.3rem;">
                          <span style="background:#fc5c7d; color:white; padding:0.2rem 0.5rem; border-radius:12px; font-size:0.8rem; font-weight:600;">üí¨ Personal</span>
                          <span style="color:#fc5c7d; font-size:0.9rem; font-weight:600;">@{{ sender_name }}</span>
                        </div>
                        <strong>{{ message }}</strong><br>
                        <span style="font-size:0.92rem; color:#888;">{{ format_datetime_for_display(created_at) }}</span>
                      </li>
                    {% else %}
                      <li class="notification-item" data-notification-id="{{ id }}" data-type="notification" style="padding:0.9rem 1.2rem; border-bottom:1px solid #eee; font-size:1.05rem; color:#232946; background:#f8fafc; border-radius:10px; margin-bottom:0.7rem; cursor:pointer; transition:all 0.2s ease;" onmouseover="this.style.background='#f0f4ff'" onmouseout="this.style.background='#f8fafc'">
                        <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.3rem;">
                          <span style="background:#6a82fb; color:white; padding:0.2rem 0.5rem; border-radius:12px; font-size:0.8rem; font-weight:600;">üì¢ Notification</span>
                        </div>
                        <strong>{{ message }}</strong><br>
                        <span style="font-size:0.92rem; color:#888;">{{ format_datetime_for_display(created_at) }}</span>
                      </li>
                    {% endif %}
                  {% else %}
                    <!-- Fallback for old notification format -->
                    {% set id, message, created_at, status, notification_type, scheduled_time = notification %}
                    <li class="notification-item" data-notification-id="{{ id }}" data-type="notification" style="padding:0.9rem 1.2rem; border-bottom:1px solid #eee; font-size:1.05rem; color:#232946; background:#f8fafc; border-radius:10px; margin-bottom:0.7rem; cursor:pointer; transition:all 0.2s ease;" onmouseover="this.style.background='#f0f4ff'" onmouseout="this.style.background='#f8fafc'">
                      <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.3rem;">
                        <span style="background:#6a82fb; color:white; padding:0.2rem 0.5rem; border-radius:12px; font-size:0.8rem; font-weight:600;">üì¢ Notification</span>
                      </div>
                      <strong>{{ message }}</strong><br>
                      <span style="font-size:0.92rem; color:#888;">{{ format_datetime_for_display(created_at) }}</span>
                    </li>
                  {% endif %}
                {% endfor %}
        {% else %}
          <li style="padding:1.1rem 1.2rem; color:#888; text-align:center; background:#f8fafc; border-radius:10px;">No new notifications.</li>
        {% endif %}
      </ul>
    </div>
  </div>
  {% endif %}
  
  <div class="host-container">
    <div class="video-section">
      <h3 style="color:#6a82fb; margin-bottom:1rem;">Live Class (Host View)</h3>
      
      <!-- Universal Video Container -->
      <div class="live-watch-container">
        <!-- Live Camera Feed -->
        <video id="hostCamera" class="video-player" autoplay muted playsinline style="display: none;"></video>
        
        <!-- Content Video (YouTube or uploaded video) -->
        <div id="contentVideo" style="display: block;">
          {% set is_youtube = 'youtube.com' in meeting_url or 'youtu.be' in meeting_url %}
          {% if is_youtube %}
            {% set youtube_id = None %}
            {% if 'youtu.be' in meeting_url %}
              {% set youtube_id = meeting_url.split('/')[-1].split('?')[0] %}
            {% elif 'youtube.com' in meeting_url and 'v=' in meeting_url %}
              {% set youtube_id = meeting_url.split('v=')[1].split('&')[0] %}
            {% endif %}
            {% if youtube_id %}
              <iframe class="video-player" width="640" height="360" src="https://www.youtube.com/embed/{{ youtube_id }}" frameborder="0" allowfullscreen></iframe>
            {% else %}
              <div class="video-player" style="display:flex;align-items:center;justify-content:center;color:#888;">Invalid YouTube Link</div>
            {% endif %}
          {% else %}
            <video class="video-player" controls>
              <source src="{{ meeting_url }}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
          {% endif %}
        </div>
        
        <!-- Icon-Only Video Controls -->
        <div class="video-controls">
          <button id="startCameraBtn" class="icon-btn icon-btn-start" title="Start Camera">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4zM14 13h-3v3H9v-3H6v-2h3V8h2v3h3v2z"/>
            </svg>
          </button>
          <button id="stopCameraBtn" class="icon-btn icon-btn-stop" title="Stop Camera" style="display: none;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M21 6.5l-4 4V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11zM9.5 16L8 14.5l1.5-1.5L8 11.5 9.5 10l1.5 1.5L12.5 10 14 11.5 12.5 13 14 14.5 12.5 16 11 14.5 9.5 16z"/>
            </svg>
          </button>
          <button id="toggleMicBtn" class="icon-btn icon-btn-mic" title="Mute/Unmute">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/>
            </svg>
          </button>
          <button id="showCameraBtn" class="icon-btn icon-btn-camera" title="Show Live Camera">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
            </svg>
          </button>
          <button id="showContentBtn" class="icon-btn icon-btn-content" title="Show Content Video">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14zM8 15c0-.83.67-1.5 1.5-1.5S11 14.17 11 15s-.67 1.5-1.5 1.5S8 15.83 8 15zm4-4c0-.83.67-1.5 1.5-1.5S15 10.17 15 11s-.67 1.5-1.5 1.5S12 11.83 12 11zm4 4c0-.83.67-1.5 1.5-1.5S19 14.17 19 15s-.67 1.5-1.5 1.5S16 15.83 16 15z"/>
            </svg>
          </button>
        </div>
        
        <!-- Device Selection -->
        <div class="device-selection">
          <div class="device-row">
            <svg class="device-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
            </svg>
            <label class="device-label">Camera:</label>
            <select id="videoSourceSelect" class="device-select">
              <option value="">Select Camera...</option>
            </select>
          </div>
          <div class="device-row">
            <svg class="device-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/>
            </svg>
            <label class="device-label">Microphone:</label>
            <select id="audioSourceSelect" class="device-select">
              <option value="">Select Microphone...</option>
            </select>
          </div>
          <div class="device-status" id="deviceStatus">
            üì± Select your camera and microphone devices
          </div>
        </div>
      </div>
      
      <div id="streamingStatus" style="margin-bottom:1rem; color:#6a82fb; text-align: center;">
        <span id="statusText">Camera Off - Ready to Start Live Class</span>
      </div>
      <div class="class-info">
        {% if subject or teacher_name or target_class %}
        <div style="margin:0.4rem 0 0.6rem 0; color:#555;">
          {% if subject %}<strong>Subject:</strong> {{ subject|capitalize }}{% endif %}
          {% if teacher_name %}{% if subject %} ‚Ä¢ {% endif %}<strong>Teacher:</strong> {{ teacher_name }}{% endif %}
          {% if target_class %}<br><strong>Target:</strong> Class {{ target_class }}{% if target_class in ['11','12'] and class_stream %} ({{ class_stream|capitalize }}){% endif %}{% endif %}
        </div>
        {% endif %}
        <h2 class="class-title">{{ topic or 'Live Class' }}</h2>
        <p class="class-description">{{ description or '' }}</p>
        <a href="/online-class" class="back-link">&larr; Back to Online Classes</a>
      </div>
    </div>
    <div class="control-section">
      <div class="tab-container">
        <button class="tab-btn active" onclick="showTab('chat')">Chat</button>
        <button class="tab-btn" onclick="showTab('polls')">Polls</button>
        <button class="tab-btn" onclick="showTab('doubts')">Doubts</button>
        <button class="tab-btn" onclick="showTab('controls')">Controls</button>
        <button id="darkModeToggle" class="btn btn-primary" style="min-width:160px;">Toggle Dark Mode</button>
      </div>
      
      <!-- Chat Tab -->
      <div id="chat-tab" class="tab-content active">
        <div class="chat-card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="color: #6a82fb; margin: 0;">Live Chat</h3>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
              <!-- Chat Lock Toggle -->
              <button id="chatLockBtn" class="chat-control-btn" title="Lock/Unlock Chat" onclick="toggleChatLock()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S2 3.24 2 6v2H1c-.55 0-1 .45-1 1v12c0 .55.45 1 1 1h16c.55 0 1-.45 1-1V9c0-.55-.45-1-1-1zM4 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H4V6zm12 14H2V9h16v11z"/>
                </svg>
                <span id="chatLockText">Lock Chat</span>
              </button>
              <!-- Chat Private Toggle -->
              <button id="chatPrivateBtn" class="chat-control-btn" title="Toggle Private Chat" onclick="toggleChatPrivate()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <span id="chatPrivateText">Public</span>
              </button>
              <!-- Clear Chat -->
              <button class="chat-control-btn clear-chat" title="Clear All Chat Messages" onclick="clearChat()" style="background: #fff3cd; border-color: #ffeaa7; color: #856404;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 13H5v-2h14v2z"/>
                </svg>
                <span>Clear Chat</span>
              </button>
              <!-- Export Chat -->
              <button class="chat-control-btn export-chat" title="Export Chat to File" onclick="exportChat()" style="background: #d1ecf1; border-color: #bee5eb; color: #0c5460;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                <span>Export</span>
              </button>
            </div>
          </div>
          <div id="chatMessages" class="chat-messages">
            <!-- Chat messages will appear here -->
          </div>
          <form id="chatForm">
            <input type="text" id="chatInput" placeholder="Type a message..." class="chat-input" autocomplete="off" />
            <button type="submit" class="chat-send-btn">Send</button>
          </form>
        </div>
      </div>
      
      <!-- Polls Tab -->
      <div id="polls-tab" class="tab-content">
        <div class="poll-section">
          <h3 style="margin-bottom: 1rem; color: #fc5c7d;">Create Poll</h3>
          <form id="pollForm">
            <input type="text" id="pollQuestion" placeholder="Enter poll question..." class="poll-input" required />
            <div id="pollOptions">
              <div class="poll-option">
                <input type="text" placeholder="Option 1" class="poll-input" required />
                <label style="margin-left: 0.5rem;">
                  <input type="radio" name="correctAnswer" value="0" style="margin-right: 0.3rem;">
                  Correct
                </label>
              </div>
              <div class="poll-option">
                <input type="text" placeholder="Option 2" class="poll-input" required />
                <label style="margin-left: 0.5rem;">
                  <input type="radio" name="correctAnswer" value="1" style="margin-right: 0.3rem;">
                  Correct
                </label>
              </div>
            </div>
            <button type="button" onclick="addPollOption()" style="background: #e2e8f0; color: #4a5568; border: none; padding: 0.3rem 0.6rem; border-radius: 6px; margin-bottom: 0.5rem; cursor: pointer;">+ Add Option</button>
            <div style="margin: 1rem 0; padding: 0.8rem; background: #fff3cd; border-radius: 8px; border: 1px solid #ffeaa7;">
              <span style="color: #856404; font-size: 0.9rem;">‚è±Ô∏è Polls automatically end after 15 seconds</span>
            </div>
            <button type="submit" class="poll-btn">Create Poll (15s Timer)</button>
          </form>
        </div>
        <div id="activePolls">
          <!-- Active polls will appear here -->
        </div>
        <div id="pollResults" style="margin-top: 1rem;">
          <!-- Poll results will appear here -->
        </div>
      </div>
      
      <!-- Doubts Tab -->
      <div id="doubts-tab" class="tab-content">
        <div class="doubts-section">
          <h3 style="margin-bottom: 1rem; color: #48bb78;">Student Doubts</h3>
          <div id="doubtsList">
            <!-- Doubts will appear here -->
            <div class="doubt-item">
              <div class="doubt-user">Student Name</div>
              <div class="doubt-text">This is a sample doubt question from a student.</div>
              <div class="doubt-actions">
                <button class="doubt-btn resolve-btn">Resolve</button>
                <button class="doubt-btn ignore-btn">Ignore</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Controls Tab -->
      <div id="controls-tab" class="tab-content">
        <div class="host-controls">
          <h3 style="margin-bottom: 1rem; color: #6a82fb;">Host Controls</h3>
          <div style="margin-bottom: 1rem;">
            <div style="font-weight: 600; color: #232946; margin-bottom: 0.5rem;">Student Count:</div>
            <div id="studentCount" style="font-size: 1.2rem; color: #6a82fb; font-weight: 700;">0 Students Online</div>
          </div>
          
          <!-- Recording Controls -->
          <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
            <h4 style="margin-bottom: 0.8rem; color: #232946;">üé• Recording Controls</h4>
            <div style="margin-bottom: 0.8rem;">
              <input type="text" id="recordingNameInput" placeholder="Recording Name (optional)" 
                     style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem;">
              <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button id="startRecordingBtn" class="control-btn" style="background: #28a745; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;" onclick="startRecording()">
                  üî¥ Start Recording
                </button>
                <button id="stopRecordingBtn" class="control-btn" style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; display: none;" onclick="stopRecording()">
                  ‚èπÔ∏è Stop Recording
                </button>
                <button id="autoRecordBtn" class="control-btn" style="background: #17a2b8; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;" onclick="toggleAutoRecording()">
                  üîÑ Auto Record
                </button>
                <button id="voiceBtn" class="control-btn" style="background: #6f42c1; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;" onclick="toggleVoice()">
                  üé§ Voice
                </button>
                <button id="playbackBtn" class="control-btn" style="background: #fd7e14; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;" onclick="togglePlayback()">
                  ‚ñ∂Ô∏è Playback
                </button>
              </div>
            </div>
            <div id="recordingStatus" style="font-size: 0.9rem; color: #666;">
              Recording not started
            </div>
            <div id="autoRecordStatus" style="font-size: 0.9rem; color: #17a2b8; display: none;">
              üîÑ Auto-recording enabled - will start automatically when class begins
            </div>
          </div>
          
          <!-- Previous Recordings -->
          <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
            <h4 style="margin-bottom: 0.8rem; color: #232946;">üìπ Previous Recordings</h4>
            <div id="recordingsList" style="max-height: 200px; overflow-y: auto;">
              <div style="color: #666; font-style: italic;">Loading recordings...</div>
            </div>
          </div>
          
          <button class="control-btn mute-all-btn" onclick="muteAllStudents()">üîá Mute All Students</button>
          <button class="control-btn end-class-btn" onclick="endCurrentClass()">‚èπÔ∏è End Live Class</button>
          <div style="margin-top: 1rem; padding: 1rem; background: #fff3cd; border-radius: 8px; border: 1px solid #ffeaa7;">
            <span style="color: #856404; font-size: 0.9rem;">üí° Tip: Use the camera controls above to manage your live stream</span>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    // Get class ID from URL
    const classId = window.location.pathname.split('/').pop();
    
    // Enhanced Socket.IO connection with reconnection
    const socket = io({
      timeout: 10000,
      reconnection: true,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
      maxReconnectionAttempts: 10,
      forceNew: true
    });
    
    const room = 'liveclass_' + classId;
    let isConnected = false;
    let reconnectAttempts = 0;

    // Connection management
    socket.on('connect', () => {
      console.log('Connected to server:', socket.id);
      isConnected = true;
      reconnectAttempts = 0;
      
      // Update status
      if (statusText) {
        statusText.style.color = '#48bb78';
      }
      
      // Join the room
      socket.emit('join-room', { room });
    });

    socket.on('disconnect', (reason) => {
      console.log('Disconnected from server:', reason);
      isConnected = false;
      
      // Update status
      if (statusText) {
        statusText.style.color = '#fc5c7d';
      }
    });

    socket.on('connect_error', (error) => {
      console.error('Connection error:', error);
      reconnectAttempts++;
      
      if (statusText) {
        statusText.textContent = `Connection error - Reconnecting... (${reconnectAttempts}/10)`;
        statusText.style.color = '#ffa726';
      }
    });

    socket.on('reconnect', (attemptNumber) => {
      console.log('Reconnected after', attemptNumber, 'attempts');
      
      if (statusText) {
        statusText.textContent = 'Reconnected - Live Class Ready';
        statusText.style.color = '#48bb78';
      }
    });

    socket.on('reconnect_failed', () => {
      console.error('Failed to reconnect after maximum attempts');
      
      if (statusText) {
        statusText.textContent = 'Connection failed - Please refresh the page';
        statusText.style.color = '#fc5c7d';
      }
    });

    // Error handling
    socket.on('error', (data) => {
      console.error('Socket error:', data);
      alert('Connection error: ' + (data.message || 'Unknown error'));
    });

    // Room management
    socket.on('joined-room', (data) => {
      console.log('Joined room:', data.room);
    });
    
    // Student count management
    let currentStudentCount = 0;
    
    function getCurrentStudentCount() {
      return currentStudentCount;
    }
    
    function updateStudentCount(count) {
      currentStudentCount = count;
      const studentCountEl = document.getElementById('studentCount');
      if (studentCountEl) {
        studentCountEl.textContent = `${count} Student${count !== 1 ? 's' : ''} Online`;
      }
    }
    
    // Listen for student count updates
    socket.on('student_count_update', (data) => {
      if (data.class_id === classId) {
        updateStudentCount(data.count);
      }
    });
    
    // Request initial student count
    socket.emit('get_student_count', { class_id: classId });

    // Live Camera Variables
    let localStream = null;
    let isStreaming = false;
    let isMuted = false;
    let currentVideoMode = 'content'; // 'content' or 'camera'
    let availableDevices = { videoInputs: [], audioInputs: [] };
    let selectedVideoDevice = null;
    let selectedAudioDevice = null;
    
    // WebRTC Variables
    let peerConnections = new Map(); // Store peer connections for each student
    let isWebRTCReady = false;
    let mediaRecorder = null;
    let recordedChunks = [];
    let streamUrl = null;
    let isBroadcasting = false;

    // Camera Control Elements
    const hostCamera = document.getElementById('hostCamera');
    const startCameraBtn = document.getElementById('startCameraBtn');
    const stopCameraBtn = document.getElementById('stopCameraBtn');
    const toggleMicBtn = document.getElementById('toggleMicBtn');
    const showCameraBtn = document.getElementById('showCameraBtn');
    const showContentBtn = document.getElementById('showContentBtn');
    const contentVideo = document.getElementById('contentVideo');
    const statusText = document.getElementById('statusText');
    const videoSourceSelect = document.getElementById('videoSourceSelect');
    const audioSourceSelect = document.getElementById('audioSourceSelect');
    const deviceStatus = document.getElementById('deviceStatus');

    // Start Camera Function
    async function startCamera() {
      try {
        if (!selectedVideoDevice && !selectedAudioDevice) {
          deviceStatus.innerHTML = '‚ö†Ô∏è Please select camera and microphone devices first';
          return;
        }

        await startCameraWithSelectedDevices();
        
        // Notify students that host stream is ready
        if (localStream) {
          isBroadcasting = true;
          
          // Notify students that host stream is ready
          socket.emit('host_stream_ready', { 
            class_id: classId,
            message: 'Host camera stream is now available'
          });
        }
        
        // Update UI
        startCameraBtn.style.display = 'none';
        stopCameraBtn.style.display = 'inline-block';
        statusText.textContent = 'Camera Active - Live Class Ready';
        deviceStatus.innerHTML = 'üî¥ Live streaming with selected devices';
        
        // Notify students that host camera is live
        socket.emit('host_camera_status', { 
          class_id: classId, 
          status: 'live',
          message: 'Host camera is now live!'
        });
        
        // Trigger class started event for auto-recording
        onClassStarted();
        
        console.log('Camera started successfully');
      } catch (error) {
        console.error('Error accessing camera:', error);
        statusText.textContent = 'Camera Access Error - Check Permissions';
        deviceStatus.innerHTML = '‚ùå Failed to access selected devices';
        showNotification('Could not access camera. Please check permissions and selected devices.', 'error');
      }
    }

    // Stop Camera Function
    function stopCamera() {
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      
      hostCamera.srcObject = null;
      isStreaming = false;
      
      // Update UI
      startCameraBtn.style.display = 'inline-block';
      stopCameraBtn.style.display = 'none';
      statusText.textContent = 'Camera Off - Ready to Start Live Class';
      
      // Switch back to content video
      showContentVideo();
      
      // Notify students that host camera is off
      socket.emit('host_camera_status', { 
        class_id: classId, 
        status: 'offline',
        message: 'Host camera is offline'
      });
      
      console.log('Camera stopped');
    }

    // Toggle Microphone
    function toggleMicrophone() {
      if (localStream) {
        const audioTrack = localStream.getAudioTracks()[0];
        if (audioTrack) {
          audioTrack.enabled = !audioTrack.enabled;
          isMuted = !audioTrack.enabled;
          
          // Update icon button appearance
          if (isMuted) {
            toggleMicBtn.classList.add('muted');
            toggleMicBtn.title = 'Unmute Microphone';
            toggleMicBtn.innerHTML = `
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v.18l5.98 5.99zM4.27 3L3 4.27l6.01 6.01V11c0 1.66 1.33 3 2.99 3 .22 0 .44-.03.65-.08l1.66 1.66c-.71.33-1.5.52-2.31.52-2.76 0-5.3-2.1-5.3-5.1H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c.91-.13 1.77-.45 2.54-.9L19.73 21 21 19.73 4.27 3z"/>
              </svg>
            `;
          } else {
            toggleMicBtn.classList.remove('muted');
            toggleMicBtn.title = 'Mute Microphone';
            toggleMicBtn.innerHTML = `
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/>
              </svg>
            `;
          }
          
          socket.emit('host_mic_status', { 
            class_id: classId, 
            muted: isMuted 
          });
        }
      }
    }

    // Show Camera Feed
    function showCameraVideo() {
      if (isStreaming) {
        hostCamera.style.display = 'block';
        contentVideo.style.display = 'none';
        currentVideoMode = 'camera';
        
        // Update icon button states
        showCameraBtn.classList.add('active');
        showContentBtn.classList.remove('active');
        
        socket.emit('host_video_mode', { 
          class_id: classId, 
          mode: 'camera',
          message: 'Host is showing live camera'
        });
        
        // Notify students that host stream is ready for WebRTC
        if (isStreaming) {
          socket.emit('host_stream_ready', { 
            class_id: classId 
          });
        }
      } else {
        alert('Please start the camera first');
      }
    }

    // Show Content Video
    function showContentVideo() {
      hostCamera.style.display = 'none';
      contentVideo.style.display = 'block';
      currentVideoMode = 'content';
      
      // Update icon button states
      showCameraBtn.classList.remove('active');
      showContentBtn.classList.add('active');
      
      socket.emit('host_video_mode', { 
        class_id: classId, 
        mode: 'content',
        message: 'Host is showing content video'
      });
    }

    // Event Listeners
    startCameraBtn.addEventListener('click', startCamera);
    stopCameraBtn.addEventListener('click', stopCamera);
    toggleMicBtn.addEventListener('click', toggleMicrophone);
    showCameraBtn.addEventListener('click', showCameraVideo);
    showContentBtn.addEventListener('click', showContentVideo);
    videoSourceSelect.addEventListener('change', handleDeviceSelection);
    audioSourceSelect.addEventListener('change', handleDeviceSelection);

    // Device Management Functions
    async function enumerateDevices() {
      try {
        // Request permission first
        await navigator.mediaDevices.getUserMedia({ video: true, audio: true })
          .then(stream => {
            stream.getTracks().forEach(track => track.stop());
          });

        const devices = await navigator.mediaDevices.enumerateDevices();
        availableDevices.videoInputs = devices.filter(device => device.kind === 'videoinput');
        availableDevices.audioInputs = devices.filter(device => device.kind === 'audioinput');
        
        populateDeviceSelectors();
        deviceStatus.innerHTML = `üì± Found ${availableDevices.videoInputs.length} camera(s) and ${availableDevices.audioInputs.length} microphone(s)`;
        
        console.log('Devices enumerated:', availableDevices);
      } catch (error) {
        console.error('Error enumerating devices:', error);
        deviceStatus.innerHTML = '‚ùå Could not access media devices. Please check permissions.';
      }
    }

    function populateDeviceSelectors() {
      // Populate video sources
      videoSourceSelect.innerHTML = '<option value="">Select Camera...</option>';
      availableDevices.videoInputs.forEach((device, index) => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.textContent = device.label || `Camera ${index + 1}`;
        videoSourceSelect.appendChild(option);
      });

      // Populate audio sources
      audioSourceSelect.innerHTML = '<option value="">Select Microphone...</option>';
      availableDevices.audioInputs.forEach((device, index) => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.textContent = device.label || `Microphone ${index + 1}`;
        audioSourceSelect.appendChild(option);
      });

      // Set default selections if available
      if (availableDevices.videoInputs.length > 0) {
        selectedVideoDevice = availableDevices.videoInputs[0].deviceId;
        videoSourceSelect.value = selectedVideoDevice;
      }
      if (availableDevices.audioInputs.length > 0) {
        selectedAudioDevice = availableDevices.audioInputs[0].deviceId;
        audioSourceSelect.value = selectedAudioDevice;
      }
    }

    function handleDeviceSelection() {
      selectedVideoDevice = videoSourceSelect.value;
      selectedAudioDevice = audioSourceSelect.value;
      
      const videoDeviceName = videoSourceSelect.options[videoSourceSelect.selectedIndex]?.text || 'None';
      const audioDeviceName = audioSourceSelect.options[audioSourceSelect.selectedIndex]?.text || 'None';
      
      deviceStatus.innerHTML = `üéØ Selected: ${videoDeviceName} & ${audioDeviceName}`;
      
      // If streaming, restart with new devices
      if (isStreaming) {
        restartStreamWithNewDevices();
      }
    }

    async function restartStreamWithNewDevices() {
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
      }
      
      try {
        await startCameraWithSelectedDevices();
        deviceStatus.innerHTML = '‚úÖ Switched to new devices successfully';
      } catch (error) {
        console.error('Error switching devices:', error);
        deviceStatus.innerHTML = '‚ùå Failed to switch devices';
      }
    }

    async function startCameraWithSelectedDevices() {
      try {
        const constraints = {
          video: selectedVideoDevice ? { 
            deviceId: { exact: selectedVideoDevice },
            width: { ideal: 640 },
            height: { ideal: 360 },
            frameRate: { ideal: 30 }
          } : {
            width: { ideal: 640 },
            height: { ideal: 360 },
            frameRate: { ideal: 30 }
          },
          audio: selectedAudioDevice ? { 
            deviceId: { exact: selectedAudioDevice }
          } : true
        };

        console.log('Starting camera with constraints:', constraints);
        
        // Request camera permissions
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        console.log('Camera stream obtained:', localStream);
        
        if (localStream && localStream.getVideoTracks().length > 0) {
          hostCamera.srcObject = localStream;
          isStreaming = true;
          
          // Wait for video to load
          hostCamera.onloadedmetadata = () => {
            console.log('Video metadata loaded, dimensions:', hostCamera.videoWidth, 'x', hostCamera.videoHeight);
            deviceStatus.innerHTML = '‚úÖ Camera started successfully';
          };
          
          // Initialize WebRTC for streaming to students
          await initializeWebRTC();
          
          return localStream;
        } else {
          throw new Error('No video tracks in stream');
        }
      } catch (error) {
        console.error('Error starting camera:', error);
        deviceStatus.innerHTML = `‚ùå Camera error: ${error.message}`;
        
        // Try fallback constraints
        try {
          console.log('Trying fallback camera constraints...');
          const fallbackConstraints = {
            video: { width: { ideal: 640 }, height: { ideal: 360 } },
            audio: true
          };
          
          localStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
          hostCamera.srcObject = localStream;
          isStreaming = true;
          
          deviceStatus.innerHTML = '‚úÖ Camera started with fallback settings';
          await initializeWebRTC();
          
          return localStream;
        } catch (fallbackError) {
          console.error('Fallback camera also failed:', fallbackError);
          deviceStatus.innerHTML = `‚ùå Camera failed: ${fallbackError.message}`;
          throw fallbackError;
        }
      }
    }
    
    // WebRTC Functions
    async function initializeWebRTC() {
      try {
        // Create RTCPeerConnection with STUN servers
        const configuration = {
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
          ]
        };
        
        // Notify students that host stream is ready
        socket.emit('host_stream_ready', { class_id: classId });
        isWebRTCReady = true;
        
        console.log('WebRTC initialized for host streaming');
      } catch (error) {
        console.error('Error initializing WebRTC:', error);
      }
    }
    
    async function createPeerConnection(studentId) {
      try {
        const configuration = {
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
          ]
        };
        
        const peerConnection = new RTCPeerConnection(configuration);
        
        // Add local stream tracks to peer connection
        if (localStream) {
          localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
          });
        }
        
        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            socket.emit('webrtc_ice_candidate', {
              class_id: classId,
              candidate: event.candidate,
              from_user: 'host',
              to_user: studentId
            });
          }
        };
        
        // Handle connection state changes
        peerConnection.onconnectionstatechange = () => {
          console.log(`Connection state with ${studentId}:`, peerConnection.connectionState);
        };
        
        peerConnections.set(studentId, peerConnection);
        return peerConnection;
      } catch (error) {
        console.error('Error creating peer connection:', error);
        return null;
      }
    }
    
    async function handleStudentOffer(studentId, offer) {
      try {
        let peerConnection = peerConnections.get(studentId);
        
        if (!peerConnection) {
          peerConnection = await createPeerConnection(studentId);
        }
        
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        
        socket.emit('webrtc_answer', {
          class_id: classId,
          answer: answer,
          from_user: 'host',
          to_user: studentId
        });
        
        console.log(`Sent answer to student ${studentId}`);
      } catch (error) {
        console.error('Error handling student offer:', error);
      }
    }
    
    async function handleStudentAnswer(studentId, answer) {
      try {
        const peerConnection = peerConnections.get(studentId);
        if (peerConnection) {
          await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
          console.log(`Set remote description for student ${studentId}`);
        }
      } catch (error) {
        console.error('Error handling student answer:', error);
      }
    }
    
    async function handleStudentICECandidate(studentId, candidate) {
      try {
        const peerConnection = peerConnections.get(studentId);
        if (peerConnection) {
          await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
          console.log(`Added ICE candidate for student ${studentId}`);
        }
      } catch (error) {
        console.error('Error handling student ICE candidate:', error);
      }
    }

    // Initialize video mode and enumerate devices
    showContentVideo();
    enumerateDevices();

    // Poll management variables
    let activePollTimers = new Map();
    let pollStatistics = new Map();

    // --- Polls ---
    function renderPolls(polls) {
      const pollsContainer = document.getElementById('activePolls');
      pollsContainer.innerHTML = '';
      polls.forEach(poll => {
        const pollDiv = document.createElement('div');
        pollDiv.className = 'poll-section';
        pollDiv.style.cssText = 'border: 2px solid #fc5c7d; position: relative;';
        
        // Add timer display
        const timeLeft = activePollTimers.get(poll.id) || 0;
        const isActive = timeLeft > 0;
        
        pollDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <h4 style="margin: 0; color: #fc5c7d;">${poll.question}</h4>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <span id="timer-${poll.id}" style="background: ${isActive ? '#48bb78' : '#fc5c7d'}; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                ${isActive ? `‚è±Ô∏è ${timeLeft}s` : '‚èπÔ∏è Ended'}
              </span>
              ${isActive ? `<button onclick="endPoll(${poll.id})" style="background: #fc5c7d; color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">End Now</button>` : ''}
            </div>
          </div>
          <div class="poll-options">
            ${poll.options.map(opt => `
              <div style='margin:0.3rem 0; padding:0.5rem; background:#fff; border-radius:6px; border:1px solid #e0e7ff; display: flex; justify-content: space-between; align-items: center;' data-option-id='${opt.id}'>
                <span>${opt.option_text}</span>
                <span class='poll-votes' id='poll-votes-${opt.id}' style="font-weight: 600; color: #6a82fb;">0 votes</span>
              </div>
            `).join('')}
          </div>
          <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #666; display: flex; justify-content: space-between;">
            <span>${isActive ? 'üî¥ Live Poll' : 'üìä Poll Results'}</span>
            <span id="total-votes-${poll.id}">Total: 0 votes</span>
          </div>
        `;
        pollsContainer.appendChild(pollDiv);
      });
    }

    // Create poll
    function getPollOptions() {
      return Array.from(document.querySelectorAll('#pollOptions input[type="text"]')).map(input => input.value).filter(val => val.trim());
    }
    
    function getCorrectAnswer() {
      const correctRadio = document.querySelector('input[name="correctAnswer"]:checked');
      return correctRadio ? parseInt(correctRadio.value) : null;
    }
    
    document.getElementById('pollForm').onsubmit = function(e) {
      e.preventDefault();
      var question = document.getElementById('pollQuestion').value;
      var options = getPollOptions();
      var correctAnswer = getCorrectAnswer();
      
      if (question && options.length >= 2) {
        if (correctAnswer === null) {
          alert('Please select the correct answer for this poll.');
          return;
        }
        
        const pollData = { 
          class_id: classId, 
          question, 
          options, 
          correct_answer: correctAnswer,
          created_by: 'host',
          duration: 15 // 15 seconds
        };
        
        socket.emit('create_poll', pollData);
        document.getElementById('pollForm').reset();
        resetPollForm();
      }
    };
    
    function addPollOption() {
      var container = document.getElementById('pollOptions');
      var optionIndex = container.children.length;
      var newOption = document.createElement('div');
      newOption.className = 'poll-option';
      newOption.innerHTML = `
        <input type="text" placeholder="Option ${optionIndex + 1}" class="poll-input" required />
        <label style="margin-left: 0.5rem;">
          <input type="radio" name="correctAnswer" value="${optionIndex}" style="margin-right: 0.3rem;">
          Correct
        </label>
      `;
      container.appendChild(newOption);
    }
    
    function resetPollForm() {
      document.getElementById('pollOptions').innerHTML = `
        <div class="poll-option">
          <input type="text" placeholder="Option 1" class="poll-input" required />
          <label style="margin-left: 0.5rem;">
            <input type="radio" name="correctAnswer" value="0" style="margin-right: 0.3rem;">
            Correct
          </label>
        </div>
        <div class="poll-option">
          <input type="text" placeholder="Option 2" class="poll-input" required />
          <label style="margin-left: 0.5rem;">
            <input type="radio" name="correctAnswer" value="1" style="margin-right: 0.3rem;">
            Correct
          </label>
        </div>
      `;
    }
    
    function startPollTimer(pollId) {
      let timeLeft = 15;
      activePollTimers.set(pollId, timeLeft);
      
      const timer = setInterval(() => {
        timeLeft--;
        activePollTimers.set(pollId, timeLeft);
        
        const timerElement = document.getElementById(`timer-${pollId}`);
        if (timerElement) {
          if (timeLeft > 0) {
            timerElement.innerHTML = `‚è±Ô∏è ${timeLeft}s`;
            timerElement.style.background = timeLeft > 5 ? '#48bb78' : '#ffa726';
          } else {
            timerElement.innerHTML = '‚èπÔ∏è Ended';
            timerElement.style.background = '#fc5c7d';
            clearInterval(timer);
            activePollTimers.delete(pollId);
            endPoll(pollId);
          }
        } else {
          clearInterval(timer);
          activePollTimers.delete(pollId);
        }
      }, 1000);
    }
    
    function endPoll(pollId) {
      socket.emit('end_poll', { poll_id: pollId, class_id: classId });
      activePollTimers.delete(pollId);
    }

    // Listen for new polls
    socket.on('new_poll', poll => {
      startPollTimer(poll.id);
      socket.emit('get_polls_and_doubts', { class_id: classId });
    });
    
    // Listen for poll results
    socket.on('poll_results', data => {
      if (data && data.results) {
        let totalVotes = 0;
        data.results.forEach(opt => {
          totalVotes += parseInt(opt.votes) || 0;
        });
        
        data.results.forEach(opt => {
          const el = document.getElementById('poll-votes-' + opt.option_id);
          const percentage = totalVotes > 0 ? Math.round((opt.votes / totalVotes) * 100) : 0;
          if (el) {
            el.textContent = `${opt.votes} votes (${percentage}%)`;
            el.style.color = percentage > 50 ? '#48bb78' : '#6a82fb';
          }
        });
        
        const totalEl = document.getElementById('total-votes-' + data.poll_id);
        if (totalEl) {
          totalEl.textContent = `Total: ${totalVotes} votes`;
        }
        
        updatePollResults(data);
      }
    });
    
    // Listen for poll ended
    socket.on('poll_ended', data => {
      activePollTimers.delete(data.poll_id);
      displayFinalPollResults(data);
    });
    
    function updatePollResults(data) {
      pollStatistics.set(data.poll_id, data);
    }
    
    function displayFinalPollResults(data) {
      const resultsContainer = document.getElementById('pollResults');
      if (!resultsContainer) return;
      
      let totalVotes = 0;
      if (data.results) {
        data.results.forEach(opt => {
          totalVotes += parseInt(opt.votes) || 0;
        });
      }
      
      const resultDiv = document.createElement('div');
      resultDiv.className = 'poll-section';
      resultDiv.style.cssText = 'border: 2px solid #48bb78; background: #f0fff4; margin-bottom: 1rem;';
      
      const participationRate = totalVotes > 0 ? Math.round((totalVotes / (getCurrentStudentCount() || 1)) * 100) : 0;
      
      resultDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h4 style="margin: 0; color: #48bb78;">üìä Poll Results: ${data.question || 'Unknown Question'}</h4>
          <span style="background: #48bb78; color: white; padding: 0.3rem 0.6rem; border-radius: 12px; font-size: 0.9rem;">
            ${participationRate}% Participation
          </span>
        </div>
        <div class="poll-results-chart">
          ${data.results ? data.results.map(opt => {
            const percentage = totalVotes > 0 ? Math.round((opt.votes / totalVotes) * 100) : 0;
            const isCorrect = data.correct_answer !== undefined && data.correct_answer === opt.option_index;
            return `
              <div style="margin: 0.5rem 0; padding: 0.8rem; background: white; border-radius: 8px; border-left: 4px solid ${isCorrect ? '#48bb78' : '#e0e7ff'};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.3rem;">
                  <span style="font-weight: 500;">${isCorrect ? '‚úÖ ' : ''}${opt.option_text}</span>
                  <span style="font-weight: 600; color: ${isCorrect ? '#48bb78' : '#6a82fb'};">${opt.votes} votes (${percentage}%)</span>
                </div>
                <div style="background: #f1f3f5; height: 8px; border-radius: 4px; overflow: hidden;">
                  <div style="background: ${isCorrect ? '#48bb78' : '#6a82fb'}; height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                </div>
              </div>
            `;
          }).join('') : '<p>No results available</p>'}
        </div>
        <div style="margin-top: 1rem; padding: 0.6rem; background: #e8f5e8; border-radius: 6px; text-align: center; color: #2d5a33;">
          <strong>Total Responses: ${totalVotes} | Participation Rate: ${participationRate}%</strong>
        </div>
      `;
      
      resultsContainer.appendChild(resultDiv);
      
      // Auto-scroll to results
      resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // --- Doubts ---
    function renderDoubts(doubts) {
      const doubtsList = document.getElementById('doubtsList');
      doubtsList.innerHTML = '';
      
      if (doubts.length === 0) {
        doubtsList.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: #666;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="#e0e7ff" style="margin-bottom: 1rem;">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
            </svg>
            <p>No doubts yet. Students can ask questions anytime!</p>
          </div>
        `;
        return;
      }
      
      doubts.forEach(doubt => {
        const div = document.createElement('div');
        div.className = 'doubt-item';
        div.style.cssText = `
          background: ${doubt.status === 'open' ? '#fff' : doubt.status === 'resolved' ? '#f0fff4' : '#f8f9fa'};
          border-left: 4px solid ${doubt.status === 'open' ? '#ffa726' : doubt.status === 'resolved' ? '#48bb78' : '#a0aec0'};
          margin-bottom: 1rem;
          border-radius: 8px;
          transition: all 0.2s;
        `;
        
        const timeAgo = doubt.created_at ? new Date(doubt.created_at).toLocaleTimeString() : 'Just now';
        
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <div class="doubt-user" style="font-weight: 600; color: #232946; font-size: 0.95rem;">
              üë§ ${doubt.username}
            </div>
            <div style="font-size: 0.8rem; color: #666;">
              ${timeAgo}
            </div>
          </div>
          <div class="doubt-text" style="color: #4a5568; margin-bottom: 1rem; line-height: 1.4;">
            "${doubt.doubt_text}"
          </div>
          <div class="doubt-actions" style="display: flex; gap: 0.5rem; align-items: center;">
            ${doubt.status === 'open' ? `
              <button class="doubt-btn resolve-btn" onclick="resolveDoubt(${doubt.id})" style="background: #48bb78; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                ‚úì Mark Resolved
              </button>
              <button class="doubt-btn ignore-btn" onclick="ignoreDoubt(${doubt.id})" style="background: #e2e8f0; color: #4a5568; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                ‚úï Ignore
              </button>
            ` : doubt.status === 'resolved' ? 
              '<span style="color: #48bb78; font-weight: 600; padding: 0.3rem 0.6rem; background: #e8f5e8; border-radius: 12px; font-size: 0.85rem;">‚úì Resolved</span>' : 
              '<span style="color: #a0aec0; font-weight: 500; padding: 0.3rem 0.6rem; background: #f1f3f5; border-radius: 12px; font-size: 0.85rem;">Ignored</span>'
            }
          </div>
        `;
        doubtsList.appendChild(div);
      });
    }
    
    function resolveDoubt(doubtId) {
      socket.emit('resolve_doubt', { doubt_id: doubtId, class_id: classId });
    }
    
    function ignoreDoubt(doubtId) {
      socket.emit('ignore_doubt', { doubt_id: doubtId, class_id: classId });
    }
    
    socket.on('update_doubts', data => {
      renderDoubts(data.doubts);
    });
    
    // Listen for new doubts
    socket.on('new_doubt', data => {
      if (data.class_id === classId) {
        socket.emit('get_polls_and_doubts', { class_id: classId });
      }
    });

    // Initial fetch of polls and doubts
    socket.emit('get_polls_and_doubts', { class_id: classId });
    socket.on('init_polls_and_doubts', data => {
      renderPolls(data.polls);
      renderDoubts(data.doubts);
    });

    // --- Tab switching ---
    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabName + '-tab').classList.add('active');
      event.target.classList.add('active');
    }

    // Load messages on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Chat is now handled by socket.io events
      console.log('Host page loaded, chat functionality ready');
    });

    // Mute all students function
    function muteAllStudents() {
      if (confirm('Are you sure you want to mute all students?')) {
        // This would be implemented with WebRTC to actually mute students
        // For now, we'll just show a notification
        socket.emit('host_mic_status', { 
          class_id: classId, 
          muted: true,
          message: 'Host has muted all students'
        });
        alert('Mute all students feature would be implemented with WebRTC');
      }
    }

    // End current class function
    function endCurrentClass() {
      if (confirm('Are you sure you want to end this live class? This will disconnect all students.')) {
        // Stop camera if active
        if (isStreaming) {
          stopCamera();
        }
        
        // Stop recording if active
        if (isRecording) {
          stopRecording();
        }
        
        // End all active polls
        activePollTimers.forEach((timeLeft, pollId) => {
          endPoll(pollId);
        });
        
        // Emit class ended event to all students
        socket.emit('class_ended', {
          class_id: classId,
          message: 'Class ended by host'
        });
        
        // Notify server to end class
        fetch('/api/live-classes/end', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ class_id: classId })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Show success message and redirect to dashboard
            showNotification('Class ended successfully! Redirecting to dashboard...', 'success');
            setTimeout(() => {
              window.location.href = '/dashboard';
            }, 2000);
          } else {
            showNotification('Error ending class: ' + data.message, 'error');
          }
        })
        .catch(error => {
          showNotification('Error ending class: ' + error.message, 'error');
        });
      }
    }

    // --- Chat Functionality ---
    function sendChatMessage() {
      const chatInput = document.getElementById('chatInput');
      const message = chatInput.value.trim();
      
      if (message && isConnected) {
        const messageData = {
          class_id: classId,
          user_id: 'host',
          username: 'Host',
          message: message,
          type: 'chat'
        };
        
        // Emit the message
        socket.emit('chat_message', messageData);
        
        // Clear input
        chatInput.value = '';
        
        // Show typing indicator
        showTypingIndicator('Host');
        
        console.log('Host sent message:', messageData);
      }
    }

    function renderChatMessage(messageData) {
      const chatMessages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'chat-message';
      messageDiv.id = `msg-${messageData.id || Date.now()}`;
      
      const timestamp = new Date(messageData.created_at).toLocaleTimeString();
      const isHost = messageData.username === 'Host';
      const usernameColor = isHost ? '#fc5c7d' : '#6a82fb';
      const messageStyle = isHost ? 'border-left-color: #fc5c7d;' : 'border-left-color: #6a82fb;';
      
      messageDiv.innerHTML = `
        <div style="font-weight: 600; color: ${usernameColor}; font-size: 0.9rem;">
          ${messageData.username} <span style="color: #888; font-weight: 400; font-size: 0.8rem;">${timestamp}</span>
          ${isHost ? '<span style="color: #fc5c7d; font-size: 0.8rem;"> üëë</span>' : ''}
        </div>
        <div style="margin-top: 0.2rem;">${messageData.message}</div>
      `;
      
      // Apply message style
      messageDiv.style.borderLeftColor = isHost ? '#fc5c7d' : '#6a82fb';
      
      // Check if message already exists to prevent duplicates
      const existingMessage = document.getElementById(`msg-${messageData.id || Date.now()}`);
      if (!existingMessage) {
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // Add message animation
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = 'translateY(10px)';
        messageDiv.style.transition = 'all 0.3s ease';
        
        setTimeout(() => {
          messageDiv.style.opacity = '1';
          messageDiv.style.transform = 'translateY(0)';
        }, 100);
      }
    }

    // Enhanced chat event listeners
    socket.on('new_chat_message', (messageData) => {
      console.log('Received new chat message:', messageData);
      
      // Don't render if it's our own message (host messages)
      if (messageData.username !== 'Host') {
        renderChatMessage(messageData);
        
        // Show notification for new student messages
        showChatNotification(`New message from ${messageData.username}`, 'info');
      }
    });

    socket.on('chat_messages_history', (data) => {
      console.log('Received chat history:', data);
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = '';
      
      if (data.messages && data.messages.length > 0) {
        data.messages.forEach(message => {
          renderChatMessage(message);
        });
        
        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
      } else {
        // Show welcome message
        const welcomeDiv = document.createElement('div');
        welcomeDiv.className = 'chat-message';
        welcomeDiv.style.textAlign = 'center';
        welcomeDiv.style.color = '#666';
        welcomeDiv.style.fontStyle = 'italic';
        welcomeDiv.innerHTML = 'Welcome to the live class! Start chatting below.';
        chatMessages.appendChild(welcomeDiv);
      }
    });

    // Chat form submission
    document.getElementById('chatForm').addEventListener('submit', function(e) {
      e.preventDefault();
      sendChatMessage();
    });

    // Load chat history when joining
    socket.emit('get_chat_messages', { class_id: classId, limit: 50 });

    // Add error handling for chat
    socket.on('error', (data) => {
      console.error('Chat error:', data);
      if (data.message) {
        showChatNotification('Chat error: ' + data.message, 'error');
      }
    });

    // Chat status change handling
    socket.on('chat_status_change', (data) => {
      if (data.class_id === classId) {
        updateChatStatus(data.status, data.message);
      }
    });

    function updateChatStatus(status, message) {
      const statusText = document.getElementById('chatStatusText');
      const chatForm = document.getElementById('chatForm');
      const chatInput = document.getElementById('chatInput');
      
      // Remove all status classes
      statusText.classList.remove('locked', 'private', 'public');
      
      if (status === 'locked') {
        statusText.textContent = 'üîí Locked';
        statusText.classList.add('locked');
        chatForm.style.opacity = '0.5';
        chatInput.disabled = true;
        chatInput.placeholder = 'Chat is locked by host';
        
        showChatNotification(message, 'warning');
      } else if (status === 'private') {
        statusText.textContent = 'üîí Private';
        statusText.classList.add('private');
        chatForm.style.opacity = '0.5';
        chatInput.disabled = true;
        chatInput.placeholder = 'Chat is private - only host can see messages';
        
        showChatNotification(message, 'info');
      } else if (status === 'public') {
        statusText.textContent = '‚óè Public';
        statusText.classList.add('public');
        chatForm.style.opacity = '1';
        chatInput.disabled = false;
        chatInput.placeholder = 'Type a message...';
        
        showChatNotification(message, 'success');
      } else if (status === 'unlocked') {
        statusText.textContent = '‚óè Public';
        statusText.classList.add('public');
        chatForm.style.opacity = '1';
        chatInput.disabled = false;
        chatInput.placeholder = 'Type a message...';
        
        showChatNotification(message, 'success');
      }
    }

    function showChatNotification(message, type) {
      // Create a temporary notification
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        max-width: 350px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        backdrop-filter: blur(10px);
        transform: translateX(400px);
        transition: transform 0.3s ease;
        font-size: 14px;
      `;
      
      // Set background color based on type
      switch (type) {
        case 'success':
          notification.style.background = 'linear-gradient(135deg, #48bb78, #38a169)';
          break;
        case 'warning':
          notification.style.background = 'linear-gradient(135deg, #fc5c7d, #e53e3e)';
          break;
        case 'error':
          notification.style.background = 'linear-gradient(135deg, #e53e3e, #c53030)';
          break;
        case 'info':
        default:
          notification.style.background = 'linear-gradient(135deg, #6a82fb, #5a6fd8)';
      }
      
      notification.textContent = message;
      document.body.appendChild(notification);
      
      // Animate in
      setTimeout(() => {
        notification.style.transform = 'translateX(0)';
      }, 100);
      
      // Auto remove after 4 seconds
      setTimeout(() => {
        notification.style.transform = 'translateX(400px)';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 4000);
    }

    function showTypingIndicator(username) {
      // Show typing indicator
      const chatMessages = document.getElementById('chatMessages');
      const typingDiv = document.createElement('div');
      typingDiv.id = 'typing-indicator';
      typingDiv.className = 'chat-message';
      typingDiv.style.opacity = '0.7';
      typingDiv.style.fontStyle = 'italic';
      typingDiv.innerHTML = `${username} is typing...`;
      
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      // Remove typing indicator after 2 seconds
      setTimeout(() => {
        if (typingDiv.parentNode) {
          typingDiv.parentNode.removeChild(typingDiv);
        }
      }, 2000);
    }

    // --- Recording Functions ---
    let isRecording = false;
    let currentRecordingId = null;
    let autoRecordingEnabled = false;
    let voiceEnabled = false;
    let playbackEnabled = false;
    let mediaRecorder = null;
    let recordedChunks = [];

    // Auto-recording functionality
    function toggleAutoRecording() {
      autoRecordingEnabled = !autoRecordingEnabled;
      const autoRecordBtn = document.getElementById('autoRecordBtn');
      const autoRecordStatus = document.getElementById('autoRecordStatus');
      
      if (autoRecordingEnabled) {
        autoRecordBtn.style.background = '#dc3545';
        autoRecordBtn.textContent = 'üîÑ Disable Auto';
        autoRecordStatus.style.display = 'block';
        showNotification('Auto-recording enabled! Recording will start automatically when class begins.', 'success');
        
        // Start recording automatically if class is already active
        if (isStreaming && !isRecording) {
          startRecording();
        }
      } else {
        autoRecordBtn.style.background = '#17a2b8';
        autoRecordBtn.textContent = 'üîÑ Auto Record';
        autoRecordStatus.style.display = 'none';
        showNotification('Auto-recording disabled.', 'info');
      }
    }

    // Voice control functionality
    function toggleVoice() {
      voiceEnabled = !voiceEnabled;
      const voiceBtn = document.getElementById('voiceBtn');
      
      if (voiceEnabled) {
        voiceBtn.style.background = '#dc3545';
        voiceBtn.textContent = 'üé§ Disable Voice';
        showNotification('Voice enabled! Microphone is now active.', 'success');
        
        // Enable microphone if not already enabled
        if (localStream && localStream.getAudioTracks().length > 0) {
          localStream.getAudioTracks().forEach(track => track.enabled = true);
        }
      } else {
        voiceBtn.style.background = '#6f42c1';
        voiceBtn.textContent = 'üé§ Voice';
        showNotification('Voice disabled! Microphone is now muted.', 'warning');
        
        // Disable microphone
        if (localStream && localStream.getAudioTracks().length > 0) {
          localStream.getAudioTracks().forEach(track => track.enabled = false);
        }
      }
    }

    // Playback functionality
    function togglePlayback() {
      playbackEnabled = !playbackEnabled;
      const playbackBtn = document.getElementById('playbackBtn');
      
      if (playbackEnabled) {
        playbackBtn.style.background = '#dc3545';
        playbackBtn.textContent = '‚è∏Ô∏è Disable Playback';
        showNotification('Playback enabled! Students can now replay class content.', 'success');
        
        // Enable playback for students
        socket.emit('toggle_playback', {
          class_id: classId,
          enabled: true
        });
      } else {
        playbackBtn.style.background = '#fd7e14';
        playbackBtn.textContent = '‚ñ∂Ô∏è Playback';
        showNotification('Playback disabled.', 'info');
        
        // Disable playback for students
        socket.emit('toggle_playback', {
          class_id: classId,
          enabled: false
        });
      }
    }

    // Enhanced start recording function
    function startRecording() {
      if (!localStream) {
        showNotification('Please start your camera first before recording.', 'warning');
        return;
      }
      
      try {
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(localStream, {
          mimeType: 'video/webm;codecs=vp9'
        });
        
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            recordedChunks.push(event.data);
          }
        };
        
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: 'video/webm' });
          saveRecording(blob);
        };
        
        mediaRecorder.start();
        isRecording = true;
        
        // Update UI
        document.getElementById('startRecordingBtn').style.display = 'none';
        document.getElementById('stopRecordingBtn').style.display = 'inline-block';
        document.getElementById('recordingStatus').textContent = 'üî¥ Recording in progress...';
        document.getElementById('recordingStatus').style.color = '#dc3545';
        
        // Notify students
        socket.emit('recording_started', {
          class_id: classId,
          message: 'Host has started recording this class'
        });
        
        showNotification('Recording started successfully!', 'success');
        
      } catch (error) {
        console.error('Error starting recording:', error);
        showNotification('Failed to start recording: ' + error.message, 'error');
      }
    }

    // Enhanced stop recording function
    function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        
        // Update UI
        document.getElementById('startRecordingBtn').style.display = 'inline-block';
        document.getElementById('stopRecordingBtn').style.display = 'none';
        document.getElementById('recordingStatus').textContent = 'Recording stopped';
        document.getElementById('recordingStatus').style.color = '#666';
        
        // Notify students
        socket.emit('recording_stopped', {
          class_id: classId,
          message: 'Host has stopped recording this class'
        });
        
        showNotification('Recording stopped successfully!', 'info');
      }
    }

    // Auto-start recording when class begins
    function onClassStarted() {
      if (autoRecordingEnabled && !isRecording) {
        setTimeout(() => {
          startRecording();
        }, 2000); // Start recording 2 seconds after class begins
      }
    }

    // --- Chat Control Functions ---
    let isChatLocked = false;
    let isChatPrivate = false;
    
    function toggleChatLock() {
      isChatLocked = !isChatLocked;
      const lockBtn = document.getElementById('chatLockBtn');
      const lockText = document.getElementById('chatLockText');
      const chatForm = document.getElementById('chatForm');
      const chatInput = document.getElementById('chatInput');
      
      if (isChatLocked) {
        lockBtn.classList.add('locked');
        lockText.textContent = 'Unlock Chat';
        chatForm.style.opacity = '0.5';
        chatInput.disabled = true;
        chatInput.placeholder = 'Chat is locked by host';
        
        // Notify students that chat is locked
        socket.emit('chat_status_change', {
          class_id: classId,
          status: 'locked',
          message: 'Chat has been locked by the host'
        });
      } else {
        lockBtn.classList.remove('locked');
        lockText.textContent = 'Lock Chat';
        chatForm.style.opacity = '1';
        chatInput.disabled = false;
        chatInput.placeholder = 'Type a message...';
        
        // Notify students that chat is unlocked
        socket.emit('chat_status_change', {
          class_id: classId,
          status: 'unlocked',
          message: 'Chat has been unlocked by the host'
        });
      }
    }
    
    function toggleChatPrivate() {
      isChatPrivate = !isChatPrivate;
      const privateBtn = document.getElementById('chatPrivateBtn');
      const privateText = document.getElementById('chatPrivateText');
      
      if (isChatPrivate) {
        privateBtn.classList.add('private');
        privateText.textContent = 'Private';
        
        // Notify students that chat is now private
        socket.emit('chat_status_change', {
          class_id: classId,
          status: 'private',
          message: 'Chat is now private - only host can see messages'
        });
      } else {
        privateBtn.classList.remove('private');
        privateText.textContent = 'Public';
        
        // Notify students that chat is now public
        socket.emit('chat_status_change', {
          class_id: classId,
          status: 'public',
          message: 'Chat is now public - all students can see messages'
        });
      }
    }
    
    // Clean up when page is unloaded
    window.addEventListener('beforeunload', () => {
      // Stop camera and cleanup
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
      }
      socket.emit('host_camera_status', { 
        class_id: classId, 
        status: 'offline',
        message: 'Host has left the class'
      });
    });

    // WebRTC Event Listeners
    socket.on('webrtc_offer', (data) => {
      if (data.from_user !== 'host') {
        handleStudentOffer(data.from_user, data.offer);
      }
    });
    
    socket.on('webrtc_answer', (data) => {
      if (data.from_user !== 'host') {
        handleStudentAnswer(data.from_user, data.offer);
      }
    });
    
    socket.on('webrtc_ice_candidate', (data) => {
      if (data.from_user !== 'host') {
        handleStudentICECandidate(data.from_user, data.candidate);
      }
    });
    
    // Recording Event Listeners
    socket.on('recording_started', (data) => {
      if (data.class_id === classId) {
        updateRecordingStatus('Recording started', 'recording');
        console.log('Recording started:', data);
      }
    });
    
    socket.on('recording_stopped', (data) => {
      if (data.class_id === classId) {
        updateRecordingStatus('Recording stopped', 'stopped');
        loadRecordings();
        console.log('Recording stopped:', data);
      }
    });
    
    socket.on('recording_status_response', (data) => {
      if (data.class_id === classId) {
        updateRecordingUI(data.active_recording, data.all_recordings);
      }
    });

    // Chat Control Functions
    function toggleChatLock() {
      const lockBtn = document.getElementById('chatLockBtn');
      const lockText = document.getElementById('chatLockText');
      const isLocked = lockBtn.classList.contains('locked');
      
      if (isLocked) {
        // Unlock chat
        lockBtn.classList.remove('locked');
        lockText.textContent = 'Lock Chat';
        lockBtn.style.background = '#fff';
        lockBtn.style.borderColor = '#e0e7ff';
        lockBtn.style.color = '#6a82fb';
        
        // Notify all students
        socket.emit('chat_status_change', {
          class_id: classId,
          status: 'unlocked',
          message: 'Chat is now unlocked - students can send messages'
        });
        
        showChatNotification('Chat unlocked - students can now send messages', 'success');
      } else {
        // Lock chat
        lockBtn.classList.add('locked');
        lockText.textContent = 'Unlock Chat';
        lockBtn.style.background = '#ffe6e6';
        lockBtn.style.borderColor = '#fc5c7d';
        lockBtn.style.color = '#fc5c7d';
        
        // Notify all students
        socket.emit('chat_status_change', {
          class_id: classId,
          status: 'locked',
          message: 'Chat is now locked by host'
        });
        
        showChatNotification('Chat locked - students cannot send messages', 'warning');
      }
    }

    function toggleChatPrivate() {
      const privateBtn = document.getElementById('chatPrivateBtn');
      const privateText = document.getElementById('chatPrivateText');
      const isPrivate = privateBtn.classList.contains('private');
      
      if (isPrivate) {
        // Make chat public
        privateBtn.classList.remove('private');
        privateText.textContent = 'Public';
        privateBtn.style.background = '#fff';
        privateBtn.style.borderColor = '#e0e7ff';
        privateBtn.style.color = '#6a82fb';
        
        // Notify all students
        socket.emit('chat_status_change', {
          class_id: classId,
          status: 'public',
          message: 'Chat is now public - all students can see messages'
        });
        
        showChatNotification('Chat is now public - all students can see messages', 'success');
      } else {
        // Make chat private
        privateBtn.classList.add('private');
        privateText.textContent = 'Private';
        privateBtn.style.background = '#e6f7ff';
        privateBtn.style.borderColor = '#38b2ac';
        privateBtn.style.color = '#38b2ac';
        
        // Notify all students
        socket.emit('chat_status_change', {
          class_id: classId,
          status: 'private',
          message: 'Chat is now private - only host can see messages'
        });
        
        showChatNotification('Chat is now private - only you can see messages', 'info');
      }
    }

    // Clear all chat messages
    function clearChat() {
      if (confirm('Are you sure you want to clear all chat messages? This action cannot be undone.')) {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = '';
        
        // Show cleared message
        const clearedDiv = document.createElement('div');
        clearedDiv.className = 'chat-message';
        clearedDiv.style.textAlign = 'center';
        clearedDiv.style.color = '#666';
        clearedDiv.style.fontStyle = 'italic';
        clearedDiv.innerHTML = 'Chat has been cleared by host';
        chatMessages.appendChild(clearedDiv);
        
        // Notify all students
        socket.emit('chat_cleared', {
          class_id: classId,
          message: 'Chat has been cleared by host'
        });
        
        showChatNotification('Chat cleared successfully', 'success');
      }
    }

    // Export chat to file
    function exportChat() {
      const chatMessages = document.getElementById('chatMessages');
      const messages = chatMessages.querySelectorAll('.chat-message');
      let chatText = `Live Class Chat Export - ${new Date().toLocaleString()}\n`;
      chatText += '='.repeat(50) + '\n\n';
      
      messages.forEach(message => {
        const username = message.querySelector('div:first-child').textContent.split(' ')[0];
        const messageText = message.querySelector('div:last-child').textContent;
        const timestamp = message.querySelector('span').textContent;
        chatText += `[${timestamp}] ${username}: ${messageText}\n`;
      });
      
      const blob = new Blob([chatText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `chat_export_${classId}_${new Date().toISOString().split('T')[0]}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showChatNotification('Chat exported successfully', 'success');
    }

    // Save recording to server
    function saveRecording(blob) {
      const recordingName = document.getElementById('recordingNameInput').value.trim() || 
                           `Live Class ${classId} - ${new Date().toLocaleString()}`;
      
      const formData = new FormData();
      formData.append('recording', blob, `${recordingName}.webm`);
      formData.append('class_id', classId);
      formData.append('recording_name', recordingName);
      formData.append('created_by', 'host');
      
      fetch('/api/live-classes/save-recording', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showNotification('Recording saved successfully!', 'success');
          // Refresh recordings list
          loadRecordings();
        } else {
          showNotification('Failed to save recording: ' + data.message, 'error');
        }
      })
      .catch(error => {
        console.error('Error saving recording:', error);
        showNotification('Failed to save recording: ' + error.message, 'error');
      });
    }

    // Load recordings function
    function loadRecordings() {
      if (isConnected) {
        socket.emit('get_recording_status', { class_id: classId });
      }
    }

    // Update recording UI
    function updateRecordingUI(activeRecording, allRecordings) {
      // Update recording status
      if (activeRecording) {
        document.getElementById('recordingStatus').textContent = 'üî¥ Recording in progress...';
        document.getElementById('recordingStatus').style.color = '#dc3545';
        currentRecordingId = activeRecording.recording_id;
      } else {
        document.getElementById('recordingStatus').textContent = 'Recording not started';
        document.getElementById('recordingStatus').style.color = '#666';
        currentRecordingId = null;
      }
      
      // Update recordings list
      renderRecordingsList(allRecordings || []);
    }

    // Render recordings list
    function renderRecordingsList(recordings) {
      const recordingsList = document.getElementById('recordingsList');
      
      if (recordings.length === 0) {
        recordingsList.innerHTML = '<div style="color: #666; font-style: italic;">No recordings found</div>';
        return;
      }
      
      recordingsList.innerHTML = recordings.map(recording => {
        const startedAt = new Date(recording.started_at).toLocaleString();
        const duration = recording.duration ? formatDuration(recording.duration) : 'Unknown';
        const fileSize = recording.file_size ? formatFileSize(recording.file_size) : 'Unknown';
        const status = recording.status;
        
        let statusColor = '#666';
        let statusText = status;
        
        if (status === 'recording') {
          statusColor = '#dc3545';
          statusText = 'üî¥ Recording...';
        } else if (status === 'completed') {
          statusColor = '#28a745';
          statusText = '‚úÖ Completed';
        } else if (status === 'failed') {
          statusColor = '#dc3545';
          statusText = '‚ùå Failed';
        }
        
        return `
          <div style="border: 1px solid #ddd; border-radius: 4px; padding: 0.8rem; margin-bottom: 0.5rem; background: white;">
            <div style="font-weight: 600; color: #232946; margin-bottom: 0.3rem;">${recording.recording_name}</div>
            <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.3rem;">
              Started: ${startedAt} | Duration: ${duration} | Size: ${fileSize}
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: ${statusColor}; font-size: 0.8rem; font-weight: 600;">${statusText}</span>
              ${status === 'completed' ? 
                `<a href="/download-recording/${recording.id}" class="control-btn" style="background: #6a82fb; color: white; text-decoration: none; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem;">üì• Download</a>` : 
                ''
              }
            </div>
          </div>
        `;
      }).join('');
    }

    // Utility functions for formatting
    function formatDuration(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      
      if (hours > 0) {
        return `${hours}h ${minutes}m ${secs}s`;
      } else if (minutes > 0) {
        return `${minutes}m ${secs}s`;
      } else {
        return `${secs}s`;
      }
    }
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Load recordings on page load
    loadRecordings();
    
    // --- Chat Control Functions ---
  </script>
</body>
</html> 