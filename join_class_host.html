<!DOCTYPE html>
<html>
<head>
  <title>Host Live Class - {{ topic or 'Live Class' }}</title>
  <link rel="stylesheet" href="style.css" />
  <script src="script.js"></script>
  <style>
    .host-container { display: flex; max-width: 1400px; margin: 2rem auto; background: #fff; border-radius: 18px; box-shadow: 0 4px 24px rgba(100,100,255,0.10); }
    .video-section { flex: 2; padding: 2rem; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%); }
    .control-section { flex: 1; padding: 2rem; border-left: 1.5px solid #eee; display: flex; flex-direction: column; background: #fff; max-height: 90vh; overflow-y: auto; }
    .video-player { width: 100%; max-width: 640px; height: 360px; background: #000; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.15); margin-bottom: 1.5rem; }
    .class-info { width: 100%; max-width: 640px; text-align: left; }
    .class-title { font-size: 1.5rem; font-weight: 600; color: #232946; margin-bottom: 0.5rem; }
    .class-description { color: #666; line-height: 1.5; margin-bottom: 1rem; }
    .back-link { color: #6a82fb; text-decoration: none; font-weight: 500; }
    .back-link:hover { text-decoration: underline; }
    
    .tab-container { display: flex; margin-bottom: 1rem; border-bottom: 2px solid #e0e7ff; justify-content: flex-end; gap: 0.5rem; }
    .tab-btn { padding: 0.8rem; background: none; border: none; cursor: pointer; font-weight: 500; color: #666; transition: all 0.2s; }
    .tab-btn.active { color: #6a82fb; border-bottom: 2px solid #6a82fb; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .chat-card { background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%); border-radius:12px; box-shadow: 0 4px 16px rgba(100,100,255,0.08); padding:1.2rem; border: 1px solid #e0e7ff; margin-bottom: 1rem; }
    .chat-messages { max-height: 200px; overflow-y:auto; margin-bottom:0.7rem; border-bottom:1px solid #e0e7ff; padding-bottom:0.5rem; font-size:0.95rem; }
    .chat-input { width: 100%; border-radius:8px; border:1px solid #e0e7ff; padding:0.5rem 0.8rem; background: #fff; margin-bottom: 0.5rem; }
    .chat-input:focus { outline: none; border-color: #6a82fb; box-shadow: 0 0 0 2px rgba(106,130,251,0.1); }
    .chat-send-btn { border-radius:8px; background: linear-gradient(135deg, #6a82fb 0%, #5a6fd8 100%); border: none; color: #fff; padding: 0.5rem 1rem; cursor: pointer; transition: all 0.2s; }
    .chat-send-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(106,130,251,0.3); }
    .chat-message { margin: 0.3rem 0; padding: 0.4rem 0.7rem; background: #fff; border-radius: 7px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-left: 3px solid #6a82fb; }
    
    .poll-section { background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%); border-radius:12px; padding:1.2rem; border: 1px solid #e0e7ff; margin-bottom: 1rem; }
    .poll-input { width: 100%; border-radius:8px; border:1px solid #e0e7ff; padding:0.5rem 0.8rem; background: #fff; margin-bottom: 0.5rem; }
    .poll-option { display: flex; align-items: center; margin-bottom: 0.5rem; }
    .poll-option input { margin-right: 0.5rem; }
    .poll-option label { flex: 1; }
    .poll-btn { border-radius:8px; background: linear-gradient(135deg, #fc5c7d 0%, #e74c3c 100%); border: none; color: #fff; padding: 0.5rem 1rem; cursor: pointer; transition: all 0.2s; }
    .poll-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(252,92,125,0.3); }
    
    .doubts-section { background: linear-gradient(135deg, #f0fff4 0%, #e8f5e8 100%); border-radius:12px; padding:1.2rem; border: 1px solid #c6f6d5; margin-bottom: 1rem; }
    .doubt-item { background: #fff; border-radius: 8px; padding: 0.8rem; margin-bottom: 0.5rem; border-left: 3px solid #48bb78; }
    .doubt-user { font-weight: 600; color: #2d3748; font-size: 0.9rem; }
    .doubt-text { color: #4a5568; margin-top: 0.3rem; }
    .doubt-actions { margin-top: 0.5rem; }
    .doubt-btn { border-radius: 6px; border: none; padding: 0.3rem 0.6rem; font-size: 0.8rem; cursor: pointer; margin-right: 0.3rem; }
    .resolve-btn { background: #48bb78; color: #fff; }
    .ignore-btn { background: #e2e8f0; color: #4a5568; }
    
    .host-controls { background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%); border-radius:12px; padding:1.2rem; border: 1px solid #81e6d9; margin-bottom: 1rem; }
    .control-btn { width: 100%; border-radius:8px; border: none; padding: 0.8rem; margin-bottom: 0.5rem; cursor: pointer; font-weight: 500; transition: all 0.2s; }
    .end-class-btn { background: linear-gradient(135deg, #fc5c7d 0%, #e74c3c 100%); color: #fff; }
    .end-class-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(252,92,125,0.3); }
    .mute-all-btn { background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%); color: #fff; }
    .mute-all-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(246,173,85,0.3); }
    
    @media (max-width: 1200px) {
      .host-container { flex-direction: column; }
      .control-section { border-left: none; border-top: 1.5px solid #eee; }
      .video-section, .control-section { padding: 1.2rem; }
    }
    
    /* Dark Mode Styles */
    body.dark-mode {
      background: #1a1a2e;
      color: #fff;
    }
    
    body.dark-mode .host-container {
      background: #232946;
      box-shadow: 0 4px 24px rgba(100,100,255,0.20);
    }
    
    body.dark-mode .video-section {
      background: linear-gradient(135deg, #232946 0%, #1a1a2e 100%);
    }
    
    body.dark-mode .control-section {
      background: #232946;
      border-left-color: #2a2a3a;
    }
    
    body.dark-mode .class-title {
      color: #fff;
    }
    
    body.dark-mode .class-description {
      color: #b8c5d6;
    }
    
    body.dark-mode .chat-card,
    body.dark-mode .poll-section,
    body.dark-mode .doubts-section,
    body.dark-mode .host-controls {
      background: #2a2a3a;
      border-color: #3a3a4a;
    }
    
    body.dark-mode .chat-input,
    body.dark-mode .poll-input {
      background: #1a1a2e;
      border-color: #3a3a4a;
      color: #fff;
    }
    
    body.dark-mode .chat-input:focus,
    body.dark-mode .poll-input:focus {
      border-color: #6a82fb;
    }
    
    body.dark-mode .chat-message {
      background: #1a1a2e;
      border-left-color: #6a82fb;
    }
    
    body.dark-mode .doubt-item {
      background: #1a1a2e;
      border-left-color: #48bb78;
    }
    
    body.dark-mode .doubt-user {
      color: #fff;
    }
    
    body.dark-mode .doubt-text {
      color: #b8c5d6;
    }
    
    body.dark-mode .tab-btn {
      color: #b8c5d6;
    }
    
    body.dark-mode .tab-btn.active {
      color: #6a82fb;
      border-bottom-color: #6a82fb;
    }
    
    body.dark-mode .tab-container {
      border-bottom-color: #3a3a4a;
    }
    .live-watch-container { width: 100%; max-width: 680px; background: #fff; border: 1px solid #e0e7ff; border-radius: 12px; box-shadow: 0 6px 24px rgba(100,100,255,0.12); padding: 0.8rem; margin-bottom: 1.5rem; }
    body.dark-mode .live-watch-container { background: #232946; border-color: #3a3a4a; box-shadow: 0 6px 24px rgba(0,0,0,0.3); }
    
    /* Icon-only video controls */
    .video-controls { display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; padding: 1rem; background: rgba(106,130,251,0.05); border-radius: 12px; }
    .icon-btn { width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: all 0.3s ease; position: relative; }
    .icon-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.2); }
    .icon-btn.active { box-shadow: 0 0 0 3px rgba(106,130,251,0.3); }
    .icon-btn-start { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: #fff; }
    .icon-btn-stop { background: linear-gradient(135deg, #fc5c7d 0%, #e74c3c 100%); color: #fff; }
    .icon-btn-mic { background: linear-gradient(135deg, #6a82fb 0%, #5a6fd8 100%); color: #fff; }
    .icon-btn-mic.muted { background: linear-gradient(135deg, #fc5c7d 0%, #e74c3c 100%); }
    .icon-btn-camera { background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%); color: #fff; }
    .icon-btn-content { background: linear-gradient(135deg, #38b2ac 0%, #319795 100%); color: #fff; }
    
    /* Tooltip for icon buttons */
    .icon-btn::after { content: attr(title); position: absolute; bottom: -35px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .icon-btn:hover::after { opacity: 1; }
    
    body.dark-mode .video-controls { background: rgba(35,41,70,0.3); }
    body.dark-mode .icon-btn::after { background: #1a1a2e; }
    
    /* Device Selection Styles */
    .device-selection { margin-top: 1rem; padding: 1rem; background: rgba(106,130,251,0.03); border-radius: 12px; border: 1px solid #e0e7ff; }
    .device-row { display: flex; gap: 1rem; margin-bottom: 0.8rem; align-items: center; }
    .device-row:last-child { margin-bottom: 0; }
    .device-label { min-width: 80px; font-weight: 500; color: #232946; font-size: 0.9rem; }
    .device-select { flex: 1; padding: 0.6rem 0.8rem; border: 1px solid #e0e7ff; border-radius: 8px; background: #fff; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; }
    .device-select:focus { outline: none; border-color: #6a82fb; box-shadow: 0 0 0 2px rgba(106,130,251,0.1); }
    .device-select:hover { border-color: #b8c5d6; }
    .device-icon { width: 20px; height: 20px; color: #6a82fb; }
    .device-status { font-size: 0.8rem; color: #666; margin-top: 0.5rem; }
    
    /* Dark mode device selection */
    body.dark-mode .device-selection { background: rgba(35,41,70,0.2); border-color: #3a3a4a; }
    body.dark-mode .device-label { color: #e0e7ff; }
    body.dark-mode .device-select { background: #232946; border-color: #3a3a4a; color: #fff; }
    body.dark-mode .device-select:focus { border-color: #6a82fb; }
    body.dark-mode .device-status { color: #b8c5d6; }
  </style>
</head>
<body>
  <div class="host-container">
    <div class="video-section">
      <h3 style="color:#6a82fb; margin-bottom:1rem;">Live Class (Host View)</h3>
      
      <!-- Universal Video Container -->
      <div class="live-watch-container">
        <!-- Live Camera Feed -->
        <video id="hostCamera" class="video-player" autoplay muted playsinline style="display: none;"></video>
        
        <!-- Content Video (YouTube or uploaded video) -->
        <div id="contentVideo" style="display: block;">
          {% set is_youtube = 'youtube.com' in meeting_url or 'youtu.be' in meeting_url %}
          {% if is_youtube %}
            {% set youtube_id = None %}
            {% if 'youtu.be' in meeting_url %}
              {% set youtube_id = meeting_url.split('/')[-1].split('?')[0] %}
            {% elif 'youtube.com' in meeting_url and 'v=' in meeting_url %}
              {% set youtube_id = meeting_url.split('v=')[1].split('&')[0] %}
            {% endif %}
            {% if youtube_id %}
              <iframe class="video-player" width="640" height="360" src="https://www.youtube.com/embed/{{ youtube_id }}" frameborder="0" allowfullscreen></iframe>
            {% else %}
              <div class="video-player" style="display:flex;align-items:center;justify-content:center;color:#888;">Invalid YouTube Link</div>
            {% endif %}
          {% else %}
            <video class="video-player" controls>
              <source src="{{ meeting_url }}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
          {% endif %}
        </div>
        
        <!-- Icon-Only Video Controls -->
        <div class="video-controls">
          <button id="startCameraBtn" class="icon-btn icon-btn-start" title="Start Camera">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4zM14 13h-3v3H9v-3H6v-2h3V8h2v3h3v2z"/>
            </svg>
          </button>
          <button id="stopCameraBtn" class="icon-btn icon-btn-stop" title="Stop Camera" style="display: none;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M21 6.5l-4 4V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11zM9.5 16L8 14.5l1.5-1.5L8 11.5 9.5 10l1.5 1.5L12.5 10 14 11.5 12.5 13 14 14.5 12.5 16 11 14.5 9.5 16z"/>
            </svg>
          </button>
          <button id="toggleMicBtn" class="icon-btn icon-btn-mic" title="Mute/Unmute">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/>
            </svg>
          </button>
          <button id="showCameraBtn" class="icon-btn icon-btn-camera" title="Show Live Camera">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
            </svg>
          </button>
          <button id="showContentBtn" class="icon-btn icon-btn-content" title="Show Content Video">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14zM8 15c0-.83.67-1.5 1.5-1.5S11 14.17 11 15s-.67 1.5-1.5 1.5S8 15.83 8 15zm4-4c0-.83.67-1.5 1.5-1.5S15 10.17 15 11s-.67 1.5-1.5 1.5S12 11.83 12 11zm4 4c0-.83.67-1.5 1.5-1.5S19 14.17 19 15s-.67 1.5-1.5 1.5S16 15.83 16 15z"/>
            </svg>
          </button>
        </div>
        
        <!-- Device Selection -->
        <div class="device-selection">
          <div class="device-row">
            <svg class="device-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
            </svg>
            <label class="device-label">Camera:</label>
            <select id="videoSourceSelect" class="device-select">
              <option value="">Select Camera...</option>
            </select>
          </div>
          <div class="device-row">
            <svg class="device-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/>
            </svg>
            <label class="device-label">Microphone:</label>
            <select id="audioSourceSelect" class="device-select">
              <option value="">Select Microphone...</option>
            </select>
          </div>
          <div class="device-status" id="deviceStatus">
            üì± Select your camera and microphone devices
          </div>
        </div>
      </div>
      
      <div id="streamingStatus" style="margin-bottom:1rem; color:#6a82fb; text-align: center;">
        <span id="statusText">Camera Off - Ready to Start Live Class</span>
      </div>
      <div class="class-info">
        <h2 class="class-title">{{ topic or 'Live Class' }}</h2>
        <p class="class-description">{{ description or '' }}</p>
        <a href="/online-class" class="back-link">&larr; Back to Online Classes</a>
      </div>
    </div>
    <div class="control-section">
      <div class="tab-container">
        <button class="tab-btn active" onclick="showTab('chat')">Chat</button>
        <button class="tab-btn" onclick="showTab('polls')">Polls</button>
        <button class="tab-btn" onclick="showTab('doubts')">Doubts</button>
        <button class="tab-btn" onclick="showTab('controls')">Controls</button>
        <button id="darkModeToggle" class="btn btn-primary" style="min-width:160px;">Toggle Dark Mode</button>
      </div>
      
      <!-- Chat Tab -->
      <div id="chat-tab" class="tab-content active">
        <div class="chat-card">
          <h3 style="margin-bottom: 1rem; color: #6a82fb;">Live Chat</h3>
          <div id="chatMessages" class="chat-messages">
            <!-- Chat messages will appear here -->
          </div>
          <form id="chatForm">
            <input type="text" id="chatInput" placeholder="Type a message..." class="chat-input" autocomplete="off" />
            <button type="submit" class="chat-send-btn">Send</button>
          </form>
        </div>
      </div>
      
      <!-- Polls Tab -->
      <div id="polls-tab" class="tab-content">
        <div class="poll-section">
          <h3 style="margin-bottom: 1rem; color: #fc5c7d;">Create Poll</h3>
          <form id="pollForm">
            <input type="text" id="pollQuestion" placeholder="Enter poll question..." class="poll-input" required />
            <div id="pollOptions">
              <div class="poll-option">
                <input type="text" placeholder="Option 1" class="poll-input" required />
              </div>
              <div class="poll-option">
                <input type="text" placeholder="Option 2" class="poll-input" required />
              </div>
            </div>
            <button type="button" onclick="addPollOption()" style="background: #e2e8f0; color: #4a5568; border: none; padding: 0.3rem 0.6rem; border-radius: 6px; margin-bottom: 0.5rem; cursor: pointer;">+ Add Option</button>
            <button type="submit" class="poll-btn">Create Poll</button>
          </form>
        </div>
        <div id="activePolls">
          <!-- Active polls will appear here -->
        </div>
      </div>
      
      <!-- Doubts Tab -->
      <div id="doubts-tab" class="tab-content">
        <div class="doubts-section">
          <h3 style="margin-bottom: 1rem; color: #48bb78;">Student Doubts</h3>
          <div id="doubtsList">
            <!-- Doubts will appear here -->
            <div class="doubt-item">
              <div class="doubt-user">Student Name</div>
              <div class="doubt-text">This is a sample doubt question from a student.</div>
              <div class="doubt-actions">
                <button class="doubt-btn resolve-btn">Resolve</button>
                <button class="doubt-btn ignore-btn">Ignore</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Controls Tab -->
      <div id="controls-tab" class="tab-content">
        <div class="host-controls">
          <h3 style="margin-bottom: 1rem; color: #319795;">Host Controls</h3>
          <button class="control-btn mute-all-btn">Mute All Students</button>
          <button class="control-btn" style="background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%); color: #fff;">Screen Share</button>
          <button class="control-btn" style="background: linear-gradient(135deg, #38b2ac 0%, #319795 100%); color: #fff;">Record Session</button>
          <button class="control-btn" style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); color: #fff;">Breakout Rooms</button>
          <button class="control-btn end-class-btn">End Class</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    // Get class ID from URL
    const classId = window.location.pathname.split('/').pop();
    const socket = io();
    const room = 'liveclass_' + classId;

    // Join the room for real-time updates
    socket.emit('join-room', { room });

    // Live Camera Variables
    let localStream = null;
    let isStreaming = false;
    let isMuted = false;
    let currentVideoMode = 'content'; // 'content' or 'camera'
    let availableDevices = { videoInputs: [], audioInputs: [] };
    let selectedVideoDevice = null;
    let selectedAudioDevice = null;

    // Camera Control Elements
    const hostCamera = document.getElementById('hostCamera');
    const startCameraBtn = document.getElementById('startCameraBtn');
    const stopCameraBtn = document.getElementById('stopCameraBtn');
    const toggleMicBtn = document.getElementById('toggleMicBtn');
    const showCameraBtn = document.getElementById('showCameraBtn');
    const showContentBtn = document.getElementById('showContentBtn');
    const contentVideo = document.getElementById('contentVideo');
    const statusText = document.getElementById('statusText');
    const videoSourceSelect = document.getElementById('videoSourceSelect');
    const audioSourceSelect = document.getElementById('audioSourceSelect');
    const deviceStatus = document.getElementById('deviceStatus');

    // Start Camera Function
    async function startCamera() {
      try {
        if (!selectedVideoDevice && !selectedAudioDevice) {
          deviceStatus.innerHTML = '‚ö†Ô∏è Please select camera and microphone devices first';
          return;
        }

        await startCameraWithSelectedDevices();
        
        // Update UI
        startCameraBtn.style.display = 'none';
        stopCameraBtn.style.display = 'inline-block';
        statusText.textContent = 'Camera Active - Live Class Ready';
        deviceStatus.innerHTML = 'üî¥ Live streaming with selected devices';
        
        // Notify students that host camera is live
        socket.emit('host_camera_status', { 
          class_id: classId, 
          status: 'live',
          message: 'Host camera is now live!'
        });
        
        console.log('Camera started successfully');
      } catch (error) {
        console.error('Error accessing camera:', error);
        statusText.textContent = 'Camera Access Error - Check Permissions';
        deviceStatus.innerHTML = '‚ùå Failed to access selected devices';
        alert('Could not access camera. Please check permissions and selected devices.');
      }
    }

    // Stop Camera Function
    function stopCamera() {
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      
      hostCamera.srcObject = null;
      isStreaming = false;
      
      // Update UI
      startCameraBtn.style.display = 'inline-block';
      stopCameraBtn.style.display = 'none';
      statusText.textContent = 'Camera Off - Ready to Start Live Class';
      
      // Switch back to content video
      showContentVideo();
      
      // Notify students that host camera is off
      socket.emit('host_camera_status', { 
        class_id: classId, 
        status: 'offline',
        message: 'Host camera is offline'
      });
      
      console.log('Camera stopped');
    }

    // Toggle Microphone
    function toggleMicrophone() {
      if (localStream) {
        const audioTrack = localStream.getAudioTracks()[0];
        if (audioTrack) {
          audioTrack.enabled = !audioTrack.enabled;
          isMuted = !audioTrack.enabled;
          
          // Update icon button appearance
          if (isMuted) {
            toggleMicBtn.classList.add('muted');
            toggleMicBtn.title = 'Unmute Microphone';
            toggleMicBtn.innerHTML = `
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v.18l5.98 5.99zM4.27 3L3 4.27l6.01 6.01V11c0 1.66 1.33 3 2.99 3 .22 0 .44-.03.65-.08l1.66 1.66c-.71.33-1.5.52-2.31.52-2.76 0-5.3-2.1-5.3-5.1H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c.91-.13 1.77-.45 2.54-.9L19.73 21 21 19.73 4.27 3z"/>
              </svg>
            `;
          } else {
            toggleMicBtn.classList.remove('muted');
            toggleMicBtn.title = 'Mute Microphone';
            toggleMicBtn.innerHTML = `
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/>
              </svg>
            `;
          }
          
          socket.emit('host_mic_status', { 
            class_id: classId, 
            muted: isMuted 
          });
        }
      }
    }

    // Show Camera Feed
    function showCameraVideo() {
      if (isStreaming) {
        hostCamera.style.display = 'block';
        contentVideo.style.display = 'none';
        currentVideoMode = 'camera';
        
        // Update icon button states
        showCameraBtn.classList.add('active');
        showContentBtn.classList.remove('active');
        
        socket.emit('host_video_mode', { 
          class_id: classId, 
          mode: 'camera',
          message: 'Host is showing live camera'
        });
      } else {
        alert('Please start the camera first');
      }
    }

    // Show Content Video
    function showContentVideo() {
      hostCamera.style.display = 'none';
      contentVideo.style.display = 'block';
      currentVideoMode = 'content';
      
      // Update icon button states
      showCameraBtn.classList.remove('active');
      showContentBtn.classList.add('active');
      
      socket.emit('host_video_mode', { 
        class_id: classId, 
        mode: 'content',
        message: 'Host is showing content video'
      });
    }

    // Event Listeners
    startCameraBtn.addEventListener('click', startCamera);
    stopCameraBtn.addEventListener('click', stopCamera);
    toggleMicBtn.addEventListener('click', toggleMicrophone);
    showCameraBtn.addEventListener('click', showCameraVideo);
    showContentBtn.addEventListener('click', showContentVideo);
    videoSourceSelect.addEventListener('change', handleDeviceSelection);
    audioSourceSelect.addEventListener('change', handleDeviceSelection);

    // Device Management Functions
    async function enumerateDevices() {
      try {
        // Request permission first
        await navigator.mediaDevices.getUserMedia({ video: true, audio: true })
          .then(stream => {
            stream.getTracks().forEach(track => track.stop());
          });

        const devices = await navigator.mediaDevices.enumerateDevices();
        availableDevices.videoInputs = devices.filter(device => device.kind === 'videoinput');
        availableDevices.audioInputs = devices.filter(device => device.kind === 'audioinput');
        
        populateDeviceSelectors();
        deviceStatus.innerHTML = `üì± Found ${availableDevices.videoInputs.length} camera(s) and ${availableDevices.audioInputs.length} microphone(s)`;
        
        console.log('Devices enumerated:', availableDevices);
      } catch (error) {
        console.error('Error enumerating devices:', error);
        deviceStatus.innerHTML = '‚ùå Could not access media devices. Please check permissions.';
      }
    }

    function populateDeviceSelectors() {
      // Populate video sources
      videoSourceSelect.innerHTML = '<option value="">Select Camera...</option>';
      availableDevices.videoInputs.forEach((device, index) => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.textContent = device.label || `Camera ${index + 1}`;
        videoSourceSelect.appendChild(option);
      });

      // Populate audio sources
      audioSourceSelect.innerHTML = '<option value="">Select Microphone...</option>';
      availableDevices.audioInputs.forEach((device, index) => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.textContent = device.label || `Microphone ${index + 1}`;
        audioSourceSelect.appendChild(option);
      });

      // Set default selections if available
      if (availableDevices.videoInputs.length > 0) {
        selectedVideoDevice = availableDevices.videoInputs[0].deviceId;
        videoSourceSelect.value = selectedVideoDevice;
      }
      if (availableDevices.audioInputs.length > 0) {
        selectedAudioDevice = availableDevices.audioInputs[0].deviceId;
        audioSourceSelect.value = selectedAudioDevice;
      }
    }

    function handleDeviceSelection() {
      selectedVideoDevice = videoSourceSelect.value;
      selectedAudioDevice = audioSourceSelect.value;
      
      const videoDeviceName = videoSourceSelect.options[videoSourceSelect.selectedIndex]?.text || 'None';
      const audioDeviceName = audioSourceSelect.options[audioSourceSelect.selectedIndex]?.text || 'None';
      
      deviceStatus.innerHTML = `üéØ Selected: ${videoDeviceName} & ${audioDeviceName}`;
      
      // If streaming, restart with new devices
      if (isStreaming) {
        restartStreamWithNewDevices();
      }
    }

    async function restartStreamWithNewDevices() {
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
      }
      
      try {
        await startCameraWithSelectedDevices();
        deviceStatus.innerHTML = '‚úÖ Switched to new devices successfully';
      } catch (error) {
        console.error('Error switching devices:', error);
        deviceStatus.innerHTML = '‚ùå Failed to switch devices';
      }
    }

    async function startCameraWithSelectedDevices() {
      const constraints = {
        video: selectedVideoDevice ? { 
          deviceId: { exact: selectedVideoDevice },
          width: { ideal: 640 },
          height: { ideal: 360 },
          frameRate: { ideal: 30 }
        } : {
          width: { ideal: 640 },
          height: { ideal: 360 },
          frameRate: { ideal: 30 }
        },
        audio: selectedAudioDevice ? { 
          deviceId: { exact: selectedAudioDevice }
        } : true
      };

      localStream = await navigator.mediaDevices.getUserMedia(constraints);
      hostCamera.srcObject = localStream;
      isStreaming = true;
      
      return localStream;
    }

    // Initialize video mode and enumerate devices
    showContentVideo();
    enumerateDevices();

    // --- Polls ---
    function renderPolls(polls) {
      const pollsContainer = document.getElementById('activePolls');
      pollsContainer.innerHTML = '';
      polls.forEach(poll => {
        const pollDiv = document.createElement('div');
        pollDiv.className = 'poll-section';
        pollDiv.innerHTML = `
          <h4 style="margin-bottom: 0.5rem;">${poll.question}</h4>
          <div class="poll-options">
            ${poll.options.map(opt => `<div style='margin:0.3rem 0; padding:0.5rem; background:#fff; border-radius:6px; border:1px solid #ffd6d6;' data-option-id='${opt.id}'>${opt.option_text} <span class='poll-votes' id='poll-votes-${opt.id}'>0</span></div>`).join('')}
          </div>
          <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">Live poll</div>
        `;
        pollsContainer.appendChild(pollDiv);
      });
    }

    // Create poll
    function getPollOptions() {
      return Array.from(document.querySelectorAll('#pollOptions input')).map(input => input.value).filter(val => val.trim());
    }
    document.getElementById('pollForm').onsubmit = function(e) {
      e.preventDefault();
      var question = document.getElementById('pollQuestion').value;
      var options = getPollOptions();
      if (question && options.length >= 2) {
        socket.emit('create_poll', { class_id: classId, question, options, created_by: 'host' });
        document.getElementById('pollForm').reset();
        document.getElementById('pollOptions').innerHTML = `
          <div class="poll-option">
            <input type="text" placeholder="Option 1" class="poll-input" required />
          </div>
          <div class="poll-option">
            <input type="text" placeholder="Option 2" class="poll-input" required />
          </div>
        `;
      }
    };
    function addPollOption() {
      var container = document.getElementById('pollOptions');
      var newOption = document.createElement('div');
      newOption.className = 'poll-option';
      newOption.innerHTML = '<input type="text" placeholder="Option ' + (container.children.length + 1) + '" class="poll-input" required />';
      container.appendChild(newOption);
    }

    // Listen for new polls
    socket.on('new_poll', poll => {
      socket.emit('get_polls_and_doubts', { class_id: classId });
    });
    // Listen for poll results
    socket.on('poll_results', data => {
      if (data && data.results) {
        data.results.forEach(opt => {
          const el = document.getElementById('poll-votes-' + opt.option_id);
          if (el) el.textContent = `(${opt.votes} votes)`;
        });
      }
    });

    // --- Doubts ---
    function renderDoubts(doubts) {
      const doubtsList = document.getElementById('doubtsList');
      doubtsList.innerHTML = '';
      doubts.forEach(doubt => {
        const div = document.createElement('div');
        div.className = 'doubt-item';
        div.innerHTML = `
          <div class="doubt-user">${doubt.username}</div>
          <div class="doubt-text">${doubt.doubt_text}</div>
          <div class="doubt-actions">
            ${doubt.status === 'open' ? `<button class="doubt-btn resolve-btn" onclick="resolveDoubt(${doubt.id})">Resolve</button>
            <button class="doubt-btn ignore-btn" onclick="ignoreDoubt(${doubt.id})">Ignore</button>` : doubt.status === 'resolved' ? '<span style="color: #48bb78; font-weight: 600;">‚úì Resolved</span>' : '<span style="color: #a0aec0;">Ignored</span>'}
          </div>
        `;
        doubtsList.appendChild(div);
      });
    }
    function resolveDoubt(doubtId) {
      socket.emit('resolve_doubt', { doubt_id: doubtId, class_id: classId });
    }
    function ignoreDoubt(doubtId) {
      socket.emit('ignore_doubt', { doubt_id: doubtId, class_id: classId });
    }
    socket.on('update_doubts', data => {
      renderDoubts(data.doubts);
    });

    // Initial fetch of polls and doubts
    socket.emit('get_polls_and_doubts', { class_id: classId });
    socket.on('init_polls_and_doubts', data => {
      renderPolls(data.polls);
      renderDoubts(data.doubts);
    });

    // --- Tab switching ---
    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabName + '-tab').classList.add('active');
      event.target.classList.add('active');
    }

    // Load messages on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Auto-refresh messages every 2 seconds for host
      setInterval(loadMessages, 2000);
    });

    // Load existing messages
    function loadMessages() {
      fetch(`/api/live-class/${classId}/messages`)
        .then(response => response.json())
        .then(messages => {
          const chat = document.getElementById('chatMessages');
          chat.innerHTML = '';
          messages.forEach(msg => {
            const div = document.createElement('div');
            div.className = 'chat-message';
            div.innerHTML = `<strong>${msg.username}:</strong> ${msg.message}`;
            chat.appendChild(div);
          });
          chat.scrollTop = chat.scrollHeight;
        })
        .catch(error => console.error('Error loading messages:', error));
    }

    // Send message
    document.getElementById('chatForm').onsubmit = function(e) {
      e.preventDefault();
      const input = document.getElementById('chatInput');
      const msg = input.value.trim();
      if (!msg) return;
      
      fetch(`/api/live-class/${classId}/messages`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: msg })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          input.value = '';
          loadMessages(); // Reload messages to show the new one
        }
      })
      .catch(error => console.error('Error sending message:', error));
    };

    // Clean up when page is unloaded
    window.addEventListener('beforeunload', () => {
      // Stop camera and cleanup
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
      }
      socket.emit('host_camera_status', { 
        class_id: classId, 
        status: 'offline',
        message: 'Host has left the class'
      });
    });
  </script>
</body>
</html> 