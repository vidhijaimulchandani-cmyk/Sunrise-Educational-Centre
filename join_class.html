<!DOCTYPE html>
<html>
<head>
  <title>Join Live Class</title>
  <link rel="stylesheet" href="style.css" />
  <script src="script.js"></script>
  <style>
    .join-container { display: flex; max-width: 1100px; margin: 3rem auto; background: #fff; border-radius: 18px; box-shadow: 0 4px 24px rgba(100,100,255,0.10); }
    .video-section { flex: 2; padding: 2rem; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%); }
    .info-section { flex: 1; padding: 2.5rem 2rem; border-left: 1.5px solid #eee; display: flex; flex-direction: column; justify-content: flex-start; background: #fff; }
    .video-player { width: 100%; max-width: 640px; height: 360px; background: #000; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.15); margin-bottom: 1.5rem; }
    .class-info { width: 100%; max-width: 640px; text-align: left; }
    .class-title { font-size: 1.5rem; font-weight: 600; color: #232946; margin-bottom: 0.5rem; }
    .class-description { color: #666; line-height: 1.5; margin-bottom: 1rem; }
    .back-link { color: #6a82fb; text-decoration: none; font-weight: 500; }
    .back-link:hover { text-decoration: underline; }
    .chat-card { margin-top:1rem; background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%); border-radius:12px; box-shadow: 0 4px 16px rgba(100,100,255,0.08); padding:2rem 1.5rem 1.2rem 1.5rem; max-height:520px; min-height:340px; display:flex; flex-direction:column; border: 1px solid #e0e7ff; }
    .chat-messages { flex:1; overflow-y:auto; min-height:220px; max-height:340px; margin-bottom:1.2rem; border-bottom:1px solid #e0e7ff; padding-bottom:0.7rem; font-size:1.08rem; }
    .chat-input { flex:1; border-radius:8px; border:1px solid #e0e7ff; padding:0.5rem 0.8rem; background: #fff; }
    .chat-input:focus { outline: none; border-color: #6a82fb; box-shadow: 0 0 0 2px rgba(106,130,251,0.1); }
    .chat-send-btn { border-radius:8px; background: linear-gradient(135deg, #6a82fb 0%, #5a6fd8 100%); border: none; color: #fff; padding: 0.5rem 1rem; cursor: pointer; transition: all 0.2s; }
    .chat-send-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(106,130,251,0.3); }
    .chat-message { margin: 0.3rem 0; padding: 0.4rem 0.7rem; background: #fff; border-radius: 7px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-left: 3px solid #6a82fb; }
    
    /* Chat Message Animations */
    .chat-message {
      transition: all 0.3s ease;
      animation: slideInMessage 0.3s ease-out;
    }
    
    @keyframes slideInMessage {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Typing Indicator */
    .typing-indicator {
      opacity: 0.7;
      font-style: italic;
      color: #666;
      padding: 0.5rem;
      background: #f8f9ff;
      border-radius: 8px;
      margin: 0.5rem 0;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 0.4; }
    }
    
    /* Host Message Styling */
    .chat-message.host-message {
      border-left-color: #fc5c7d;
    }
    
    .chat-message.own-message {
      border-left-color: #48bb78;
    }
    
    /* Chat Status Indicator */
    #chatStatusIndicator { font-size: 0.9rem; }
    #chatStatusText.locked { color: #fc5c7d; }
    #chatStatusText.private { color: #38b2ac; }
    #chatStatusText.public { color: #48bb78; }
    @media (max-width: 900px) {
      .join-container { flex-direction: column; }
      .info-section { border-left: none; border-top: 1.5px solid #eee; }
      .video-section, .info-section { padding: 1.2rem; }
    }
    
    /* Dark Mode Styles */
    body.dark-mode {
      background: #1a1a2e;
      color: #fff;
    }
    
    body.dark-mode .join-container {
      background: #232946;
      box-shadow: 0 4px 24px rgba(100,100,255,0.20);
    }
    
    body.dark-mode .video-section {
      background: linear-gradient(135deg, #232946 0%, #1a1a2e 100%);
    }
    
    body.dark-mode .info-section {
      background: #232946;
      border-left-color: #2a2a3a;
    }
    
    body.dark-mode .class-title {
      color: #fff;
    }
    
    body.dark-mode .class-description {
      color: #b8c5d6;
    }
    
    body.dark-mode .chat-card {
      background: linear-gradient(135deg, #2a2a3a 0%, #1a1a2e 100%);
      border-color: #3a3a4a;
    }
    
    body.dark-mode .chat-input {
      background: #1a1a2e;
      border-color: #3a3a4a;
      color: #fff;
    }
    
    body.dark-mode .chat-input:focus {
      border-color: #6a82fb;
    }
    
    body.dark-mode .chat-message {
      background: #1a1a2e;
      border-left-color: #6a82fb;
    }
    
    body.dark-mode #chatStatusText.locked {
      color: #fc5c7d;
    }
    
    body.dark-mode #chatStatusText.private {
      color: #38b2ac;
    }
    
    body.dark-mode #chatStatusText.public {
      color: #48bb78;
    }
    
    body.dark-mode .tab-btn {
      color: #b8c5d6;
    }
    
    body.dark-mode .tab-btn.active {
      color: #6a82fb;
      border-bottom-color: #6a82fb;
    }
    
    body.dark-mode .tab-container {
      border-bottom-color: #3a3a4a;
    }
    .live-watch-container { width: 100%; max-width: 680px; background: #fff; border: 1px solid #e0e7ff; border-radius: 12px; box-shadow: 0 6px 24px rgba(100,100,255,0.12); padding: 0.8rem; margin-bottom: 1.5rem; }
    body.dark-mode .live-watch-container { background: #232946; border-color: #3a3a4a; box-shadow: 0 6px 24px rgba(0,0,0,0.3); }
    
    /* Device Selection Styles for Student View */
    .device-selection { margin-top: 1rem; padding: 1rem; background: rgba(106,130,251,0.03); border-radius: 12px; border: 1px solid #e0e7ff; }
    .device-row { display: flex; gap: 1rem; margin-bottom: 0.8rem; align-items: center; }
    .device-row:last-child { margin-bottom: 0; }
    .device-label { min-width: 80px; font-weight: 500; color: #232946; font-size: 0.9rem; }
    .device-select { flex: 1; padding: 0.6rem 0.8rem; border: 1px solid #e0e7ff; border-radius: 8px; background: #fff; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; }
    .device-select:focus { outline: none; border-color: #6a82fb; box-shadow: 0 0 0 2px rgba(106,130,251,0.1); }
    .device-select:hover { border-color: #b8c5d6; }
    .device-icon { width: 20px; height: 20px; color: #6a82fb; }
    .device-status { font-size: 0.8rem; color: #666; margin-top: 0.5rem; }
    
    /* Dark mode device selection */
    body.dark-mode .device-selection { background: rgba(35,41,70,0.2); border-color: #3a3a4a; }
    body.dark-mode .device-label { color: #e0e7ff; }
    body.dark-mode .device-select { background: #232946; border-color: #3a3a4a; color: #fff; }
    body.dark-mode .device-select:focus { border-color: #6a82fb; }
    body.dark-mode .device-status { color: #b8c5d6; }
    
    /* Enhanced Camera View Styles */
    .camera-controls button {
      transition: all 0.2s ease;
    }
    
    .camera-controls button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .camera-controls button:active {
      transform: translateY(0);
    }
    
    #hostCameraContainer {
      position: relative;
      overflow: hidden;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(106,130,251,0.2);
    }
    
    #hostCameraFeed {
      transition: all 0.3s ease;
    }
    
    #hostCameraFeed:hover {
      transform: scale(1.02);
    }
    
    #connectionStatus {
      transition: all 0.3s ease;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    #cameraControls {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    #hostCameraContainer:hover #cameraControls {
      opacity: 1;
    }
    
    /* Loading Animation for Camera */
    .camera-loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(106,130,251,0.3);
      border-radius: 50%;
      border-top-color: #6a82fb;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Camera Quality Indicator */
    .camera-quality {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    
    /* Responsive Camera Controls */
    @media (max-width: 768px) {
      #cameraControls {
        flex-direction: column;
        gap: 8px;
        padding: 12px;
      }
      
      #cameraControls button {
        font-size: 11px;
        padding: 8px 12px;
      }
      
      #connectionStatus, .camera-quality {
        font-size: 10px;
        padding: 3px 6px;
      }
    }
    
    /* Dark Mode Camera Enhancements */
    body.dark-mode #hostCameraContainer {
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
    
    body.dark-mode #cameraControls {
      background: rgba(0,0,0,0.8);
    }
    
    body.dark-mode #cameraControls button {
      background: rgba(255,255,255,0.15);
    }
    
    body.dark-mode #cameraControls button:hover {
      background: rgba(255,255,255,0.25);
    }
    
    /* Dark Mode Help Section */
    body.dark-mode #cameraHelp {
      background: rgba(35,41,70,0.2);
      border-color: rgba(106,130,251,0.2);
    }
    
    body.dark-mode #cameraHelp .kbd {
      background: #2a2a3a;
      color: #e0e7ff;
      border: 1px solid #3a3a4a;
    }
    
    body.dark-mode #cameraHelp div:last-child {
      color: #b8c5d6;
    }
    
    /* Dark Mode Chat Message Types */
    body.dark-mode .chat-message.host-message {
      border-left-color: #fc5c7d;
    }
    
    body.dark-mode .chat-message.own-message {
      border-left-color: #48bb78;
    }
    
    body.dark-mode .typing-indicator {
      background: #2a2a3a;
      color: #b8c5d6;
    }
  </style>
    <link rel="stylesheet" href="floating-navbar.css">
    <link rel="stylesheet" href="uiverse-components.css">
</head>
<body>
  <!-- Notification Bell for Live Class -->
  {% if username %}
  <div id="notifBellContainer" style="position:fixed; top:20px; right:20px; z-index:9999;">
    <button id="notifBell" style="background:none; border:none; cursor:pointer; position:relative; z-index:10000; padding:0;">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none" style="vertical-align:middle;"><path d="M12 22c1.1 0 2-.9 2-2h-4a2 2 0 0 0 2 2zm6-6V11c0-3.07-1.63-5.64-5-6.32V4a1 1 0 1 0-2 0v.68C7.63 5.36 6 7.92 6 11v5l-1.29 1.29A1 1 0 0 0 6 19h12a1 1 0 0 0 .71-1.71L18 16z" fill="#6a82fb"/></svg>
      {% if user_notifications and user_notifications|length > 0 %}
      <span style="position:absolute;top:0;right:0;width:10px;height:10px;background:#fc5c7d;border-radius:50%;"></span>
      {% endif %}
    </button>
    <div id="notifDropdown" style="display:none; position:absolute; right:0; top:36px; background:#fff; min-width:320px; box-shadow:0 4px 24px rgba(100,100,255,0.13); border-radius:12px; z-index:10001; padding:1rem;">
      <strong style="color:#6a82fb; font-size:1.15rem;">Notifications</strong>
      <ul style="list-style:none; padding:0; margin:0; max-height:320px; overflow-y:auto;">
        {% if user_notifications and user_notifications|length > 0 %}
          {% for notification in user_notifications %}
            {% if notification|length >= 7 %}
              {% set id, message, created_at, status, notification_type, scheduled_time, item_type = notification %}
              {% if item_type == 'personal_chat' %}
                {% set sender_name = notification[7] if notification|length > 7 else 'User' %}
                <li class="notification-item personal-chat-item" data-notification-id="{{ id }}" data-type="personal_chat" style="padding:0.9rem 1.2rem; border-bottom:1px solid #eee; font-size:1.05rem; color:#232946; background:#fff3e0; border-radius:10px; margin-bottom:0.7rem; cursor:pointer; transition:all 0.2s ease; border-left:4px solid #fc5c7d;" onmouseover="this.style.background='#ffe6cc'" onmouseout="this.style.background='#fff3e0'">
                  <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.3rem;">
                    <span style="background:#fc5c7d; color:white; padding:0.2rem 0.5rem; border-radius:12px; font-size:0.8rem; font-weight:600;">💬 Personal</span>
                    <span style="color:#fc5c7d; font-size:0.9rem; font-weight:600;">@{{ sender_name }}</span>
                  </div>
                  <strong>{{ message }}</strong><br>
                  <span style="font-size:0.92rem; color:#888;">{{ format_datetime_for_display(created_at) }}</span>
                </li>
              {% else %}
                <li class="notification-item" data-notification-id="{{ id }}" data-type="notification" style="padding:0.9rem 1.2rem; border-bottom:1px solid #eee; font-size:1.05rem; color:#232946; background:#f8fafc; border-radius:10px; margin-bottom:0.7rem; cursor:pointer; transition:all 0.2s ease;" onmouseover="this.style.background='#f0f4ff'" onmouseout="this.style.background='#f8fafc'">
                  <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.3rem;">
                    <span style="background:#6a82fb; color:white; padding:0.2rem 0.5rem; border-radius:12px; font-size:0.8rem; font-weight:600;">📢 Notification</span>
                  </div>
                  <strong>{{ message }}</strong><br>
                  <span style="font-size:0.92rem; color:#888;">{{ format_datetime_for_display(created_at) }}</span>
                </li>
              {% endif %}
            {% else %}
              <!-- Fallback for old notification format -->
              {% set id, message, created_at, status, notification_type, scheduled_time = notification %}
              <li class="notification-item" data-notification-id="{{ id }}" data-type="notification" style="padding:0.9rem 1.2rem; border-bottom:1px solid #eee; font-size:1.05rem; color:#232946; background:#f8fafc; border-radius:10px; margin-bottom:0.7rem; cursor:pointer; transition:all 0.2s ease;" onmouseover="this.style.background='#f0f4ff'" onmouseout="this.style.background='#f8fafc'">
                <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.3rem;">
                  <span style="background:#6a82fb; color:white; padding:0.2rem 0.5rem; border-radius:12px; font-size:0.8rem; font-weight:600;">📢 Notification</span>
                </div>
                <strong>{{ message }}</strong><br>
                <span style="font-size:0.92rem; color:#888;">{{ format_datetime_for_display(created_at) }}</span>
              </li>
            {% endif %}
          {% endfor %}
        {% else %}
          <li style="padding:1.1rem 1.2rem; color:#888; text-align:center; background:#f8fafc; border-radius:10px;">No new notifications.</li>
        {% endif %}
      </ul>
    </div>
  </div>
  {% endif %}
  
  <div class="join-container">
    <div class="video-section">
      <h3 style="color:#6a82fb; margin-bottom:1rem;">Live Class (Student View)</h3>
      
      <!-- Universal Video Container for Students -->
      <div class="live-watch-container">
        <!-- Host Live Camera Feed (when available) -->
        <div id="hostCameraContainer" style="display: none; margin-bottom: 1rem;">
          <div style="position: relative; width: 100%; max-width: 640px; margin: 0 auto;">
            <video id="hostCameraFeed" class="video-player" autoplay playsinline style="width: 100%; height: auto; border-radius: 12px;"></video>
            
            <!-- Camera Quality Indicator -->
            <div id="cameraQuality" class="camera-quality" style="display: none;">
              <span id="qualityText">HD</span>
            </div>
            
            <!-- Camera Controls Overlay -->
            <div id="cameraControls" style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; background: rgba(0,0,0,0.7); padding: 8px 16px; border-radius: 20px; backdrop-filter: blur(10px);">
              <button id="fullscreenBtn" onclick="toggleFullscreen()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 16px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                </svg>
                Fullscreen
              </button>
              <button id="switchToContentBtn" onclick="switchToContent()" style="background: rgba(106,130,251,0.8); border: none; color: white; padding: 6px 12px; border-radius: 16px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14z"/>
                </svg>
                Switch to Content
              </button>
            </div>
            
            <!-- Connection Status Indicator -->
            <div id="connectionStatus" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">
              🔴 Live
            </div>
            
            <!-- Loading Indicator -->
            <div id="cameraLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 16px; display: none; text-align: center;">
              <div class="camera-loading" style="margin: 0 auto 10px;"></div>
              <div>Connecting to host camera...</div>
            </div>
          </div>
          <div style="text-align: center; margin-top: 0.5rem; color: #6a82fb; font-weight: 600;">
            🔴 Live Host Camera
          </div>
        </div>
        
        <!-- Content Video (YouTube or uploaded video) -->
        <div id="contentVideo" style="display: block;">
          {% set is_youtube = 'youtube.com' in meeting_url or 'youtu.be' in meeting_url %}
          {% if is_youtube %}
            {% set youtube_id = None %}
            {% if 'youtu.be' in meeting_url %}
              {% set youtube_id = meeting_url.split('/')[-1].split('?')[0] %}
            {% elif 'youtube.com' in meeting_url and 'v=' in meeting_url %}
              {% set youtube_id = meeting_url.split('v=')[1].split('&')[0] %}
            {% endif %}
            {% if youtube_id %}
              <iframe class="video-player" width="640" height="360" src="https://www.youtube.com/embed/{{ youtube_id }}" frameborder="0" allowfullscreen></iframe>
            {% else %}
              <div class="video-player" style="display:flex;align-items:center;justify-content:center;color:#888;">Invalid YouTube Link</div>
            {% endif %}
          {% else %}
            <video class="video-player" controls>
              <source src="{{ meeting_url }}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
          {% endif %}
        </div>
        
        <!-- Live Class Status -->
        <div id="liveStatus" style="margin-top: 1rem; text-align: center; padding: 1rem; background: rgba(106,130,251,0.05); border-radius: 12px; border: 1px solid #e0e7ff;">
          <span id="liveStatusText" style="color: #6a82fb; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14z"/>
            </svg>
            Watching content video
          </span>
          <div style="margin-top: 0.5rem;">
            <button id="requestHostStreamBtn" onclick="requestHostStream()" style="background: #6a82fb; color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; margin-right: 0.5rem;">
              📹 Request Host Camera
            </button>
            <button id="switchToCameraBtn" onclick="switchToHostCamera()" style="background: #28a745; color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; margin-right: 0.5rem; display: none;">
              🎥 Switch to Host Camera
            </button>
            <button id="switchToContentBtn2" onclick="switchToContent()" style="background: #6c757d; color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; display: none;">
              📺 Switch to Content
            </button>
          </div>
          
          <!-- Camera Help Section -->
          <div id="cameraHelp" style="margin-top: 1rem; padding: 1rem; background: rgba(106,130,251,0.03); border-radius: 8px; border: 1px solid rgba(106,130,251,0.1); text-align: left; font-size: 0.9rem;">
            <div style="color: #6a82fb; font-weight: 600; margin-bottom: 0.5rem;">
              🎥 Camera Controls Help:
            </div>
            <div style="color: #666; line-height: 1.4;">
              <strong>Keyboard Shortcuts:</strong><br>
              • <kbd style="background: #f1f3f4; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">Ctrl/Cmd + 1</kbd> - Switch to Content<br>
              • <kbd style="background: #f1f3f4; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">Ctrl/Cmd + 2</kbd> - Switch to Host Camera<br>
              • <kbd style="background: #f1f3f4; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">F</kbd> - Toggle Fullscreen<br><br>
              <strong>Features:</strong><br>
              • Hover over camera to see controls<br>
              • Quality indicator shows stream resolution<br>
              • Automatic reconnection on disconnection<br>
              • Smooth switching between camera and content
            </div>
          </div>
        </div>
        
        <!-- Recording Status Notification -->
        <div id="recordingNotification" style="margin-top: 0.5rem; text-align: center; padding: 0.8rem; background: rgba(220,53,69,0.1); border-radius: 8px; border: 1px solid rgba(220,53,69,0.2); display: none;">
          <span id="recordingStatusText" style="color: #dc3545; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <circle cx="12" cy="12" r="8" fill="#dc3545"/>
            </svg>
            Recording in progress
          </span>
        </div>
        
        <!-- Device Selection for Student -->
        <div class="device-selection" style="display: none;" id="studentDeviceSelection">
          <div class="device-row">
            <svg class="device-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
            </svg>
            <label class="device-label">Camera:</label>
            <select id="studentVideoSelect" class="device-select">
              <option value="">Select Camera...</option>
            </select>
          </div>
          <div class="device-row">
            <svg class="device-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/>
            </svg>
            <label class="device-label">Microphone:</label>
            <select id="studentAudioSelect" class="device-select">
              <option value="">Select Microphone...</option>
            </select>
          </div>
          <div class="device-status" id="studentDeviceStatus">
            📱 Select your devices for participation
          </div>
        </div>
      </div>
      <div class="class-info">
        <h2 class="class-title">{{ topic or 'Live Class' }}</h2>
        <p class="class-description">{{ description or '' }}</p>
        {% if subject or teacher_name or target_class %}
        <div style="margin:0.5rem 0 1rem 0; color:#555;">
          {% if subject %}<strong>Subject:</strong> {{ subject|capitalize }}{% endif %}
          {% if teacher_name %}{% if subject %} • {% endif %}<strong>Teacher:</strong> {{ teacher_name }}{% endif %}
          {% if target_class %}<br><strong>Target:</strong> Class {{ target_class }}{% if target_class in ['11','12'] and class_stream %} ({{ class_stream|capitalize }}){% endif %}{% endif %}
        </div>
        {% endif %}
        <a href="/online-class" class="back-link">&larr; Back to Online Classes</a>
      </div>
    </div>
    <div class="info-section">
      <div class="tab-container" style="display:flex; justify-content:flex-end; gap:0.5rem; margin-bottom: 1rem; border-bottom: 2px solid #e0e7ff;">
        <button class="tab-btn active" onclick="showTab('chat')">Chat</button>
        <button class="tab-btn" onclick="showTab('polls')">Polls</button>
        <button class="tab-btn" onclick="showTab('doubts')">Doubts</button>
        <button class="tab-btn" onclick="showTab('benchmark')" id="benchmarkTab" style="display: none;">Benchmark</button>
        
      </div>
      <!-- Chat Tab -->
      <div id="chat-tab" class="tab-content active">
        <div class="chat-card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="color: #6a82fb; margin: 0;">Live Chat</h3>
            <div id="chatStatusIndicator" style="display: flex; gap: 0.5rem; align-items: center;">
              <span id="chatStatusText" style="font-size: 0.9rem; color: #48bb78;">● Public</span>
            </div>
          </div>
          <div id="chatMessages" class="chat-messages">
            <!-- Chat messages will appear here -->
          </div>
          <form id="chatForm" style="display:flex; gap:0.5rem;">
            <input type="text" id="chatInput" placeholder="Type a message..." class="chat-input" autocomplete="off" />
            <button type="submit" class="chat-send-btn">Send</button>
          </form>
        </div>
      </div>
      <!-- Polls Tab -->
      <div id="polls-tab" class="tab-content">
        <div class="poll-section">
          <h3 style="margin-bottom: 1rem; color: #fc5c7d;">Active Polls</h3>
          <div id="activePolls"></div>
        </div>
      </div>
      <!-- Doubts Tab -->
      <div id="doubts-tab" class="tab-content">
        <div class="doubts-section">
          <h3 style="margin-bottom: 1rem; color: #48bb78;">Ask a Doubt</h3>
          <form id="doubtForm" style="margin-bottom:1rem;">
            <input type="text" id="doubtInput" placeholder="Type your doubt..." class="poll-input" required style="width:100%; margin-bottom:0.5rem;" />
            <button type="submit" class="poll-btn">Submit Doubt</button>
          </form>
          <div id="doubtsList">
            <!-- Doubts will appear here -->
            <div class="doubt-item" style="background: #fff; border-radius: 8px; padding: 0.8rem; margin-bottom: 0.5rem; border-left: 3px solid #48bb78;">
              <div class="doubt-user">You</div>
              <div class="doubt-text">(Sample) How to solve quadratic equations?</div>
            </div>
          </div>
          <div style="margin-top:1rem; color:#888; font-size:0.95rem;">Your doubts will be visible to the host.</div>
        </div>
      </div>
      
      <!-- Benchmark Tab -->
      <div id="benchmark-tab" class="tab-content">
        <div class="benchmark-section">
          <h3 style="margin-bottom: 1rem; color: #9c27b0;">📊 Class Benchmark</h3>
          
          <!-- Create Section Form -->
          <div style="background: #f8f9fa; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; border: 1px solid #e9ecef;">
            <h4 style="margin-bottom: 0.8rem; color: #232946;">➕ Create New Section</h4>
            <form id="sectionForm">
              <div style="margin-bottom: 0.8rem;">
                <label style="display: block; margin-bottom: 0.3rem; font-weight: 600; color: #232946;">Section Title:</label>
                <input type="text" id="sectionTitle" placeholder="Enter section title..." class="poll-input" required style="width: 100%;" />
              </div>
              <div style="margin-bottom: 0.8rem;">
                <label style="display: block; margin-bottom: 0.3rem; font-weight: 600; color: #232946;">Section Type:</label>
                <select id="sectionType" class="poll-input" style="width: 100%;">
                  <option value="notes">📝 Notes</option>
                  <option value="questions">❓ Questions</option>
                  <option value="examples">💡 Examples</option>
                  <option value="formulas">🧮 Formulas</option>
                  <option value="summary">📋 Summary</option>
                </select>
              </div>
              <div style="margin-bottom: 0.8rem;">
                <label style="display: block; margin-bottom: 0.3rem; font-weight: 600; color: #232946;">Content:</label>
                <textarea id="sectionContent" placeholder="Enter section content..." class="poll-input" required style="width: 100%; min-height: 80px; resize: vertical;"></textarea>
              </div>
              <button type="submit" class="poll-btn" style="background: #9c27b0; color: white; border: none;">Create Section</button>
            </form>
          </div>
          
          <!-- Completed Sections -->
          <div style="background: #f8f9fa; border-radius: 8px; padding: 1rem; border: 1px solid #e9ecef;">
            <h4 style="margin-bottom: 0.8rem; color: #232946;">📚 Completed Sections</h4>
            <div id="completedSections">
              <div style="color: #666; font-style: italic; text-align: center; padding: 1rem;">
                No sections created yet. Create your first section above!
              </div>
            </div>
          </div>
          
          <!-- Class Summary -->
          <div style="background: #e8f5e8; border-radius: 8px; padding: 1rem; margin-top: 1rem; border: 1px solid #c8e6c9;">
            <h4 style="margin-bottom: 0.8rem; color: #2e7d32;">📈 Class Progress Summary</h4>
            <div id="classSummary">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span>Total Sections Created:</span>
                <span id="totalSections" style="font-weight: 600; color: #2e7d32;">0</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span>Class Duration:</span>
                <span id="classDuration" style="font-weight: 600; color: #2e7d32;">00:00:00</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span>Topics Covered:</span>
                <span id="topicsCovered" style="font-weight: 600; color: #2e7d32;">0</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
// Get class ID from URL
const classId = window.location.pathname.split('/').pop();

// Enhanced Socket.IO connection with reconnection
const socket = io({
  timeout: 10000,
  reconnection: true,
  reconnectionDelay: 1000,
  reconnectionDelayMax: 5000,
  maxReconnectionAttempts: 10,
  forceNew: true
});

const room = 'liveclass_' + classId;
let isConnected = false;
let reconnectAttempts = 0;
let classStartTime = Date.now();
let isClassEnded = false;
let sections = [];
let classDuration = 0;

// Load sections from localStorage
function loadSections() {
  const savedSections = localStorage.getItem(`class_sections_${classId}`);
  if (savedSections) {
    sections = JSON.parse(savedSections);
    renderSections();
    updateClassSummary();
  }
}

// Save sections to localStorage
function saveSections() {
  localStorage.setItem(`class_sections_${classId}`, JSON.stringify(sections));
}

// Create new section
function createSection(title, type, content) {
  const section = {
    id: Date.now(),
    title: title,
    type: type,
    content: content,
    created_at: new Date().toISOString(),
    class_id: classId
  };
  
  sections.push(section);
  saveSections();
  renderSections();
  updateClassSummary();
  
  // Emit to server
  socket.emit('create_section', section);
  
  return section;
}

// Render sections
function renderSections() {
  const completedSections = document.getElementById('completedSections');
  
  if (sections.length === 0) {
    completedSections.innerHTML = `
      <div style="color: #666; font-style: italic; text-align: center; padding: 1rem;">
        No sections created yet. Create your first section above!
      </div>
    `;
    return;
  }
  
  completedSections.innerHTML = sections.map(section => {
    const typeIcon = {
      'notes': '📝',
      'questions': '❓',
      'examples': '💡',
      'formulas': '🧮',
      'summary': '📋'
    }[section.type] || '📄';
    
    const createdAt = new Date(section.created_at).toLocaleTimeString();
    
    return `
      <div class="section-item" style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 0.8rem; border: 1px solid #e9ecef; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
          <h5 style="margin: 0; color: #232946; display: flex; align-items: center; gap: 0.5rem;">
            ${typeIcon} ${section.title}
          </h5>
          <span style="font-size: 0.8rem; color: #666;">${createdAt}</span>
        </div>
        <div style="color: #555; line-height: 1.5; margin-bottom: 0.5rem;">${section.content}</div>
        <div style="display: flex; gap: 0.5rem;">
          <button onclick="editSection(${section.id})" class="poll-btn" style="background: #17a2b8; color: white; border: none; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Edit</button>
          <button onclick="deleteSection(${section.id})" class="poll-btn" style="background: #dc3545; color: white; border: none; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Delete</button>
        </div>
      </div>
    `;
  }).join('');
}

// Update class summary
function updateClassSummary() {
  document.getElementById('totalSections').textContent = sections.length;
  
  const duration = Math.floor((Date.now() - classStartTime) / 1000);
  const hours = Math.floor(duration / 3600);
  const minutes = Math.floor((duration % 3600) / 60);
  const seconds = duration % 60;
  
  document.getElementById('classDuration').textContent = 
    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  
  // Count unique topics (based on section titles)
  const uniqueTopics = new Set(sections.map(s => s.title.toLowerCase()));
  document.getElementById('topicsCovered').textContent = uniqueTopics.size;
}

// Edit section
function editSection(sectionId) {
  const section = sections.find(s => s.id === sectionId);
  if (section) {
    document.getElementById('sectionTitle').value = section.title;
    document.getElementById('sectionType').value = section.type;
    document.getElementById('sectionContent').value = section.content;
    
    // Change form to update mode
    const form = document.getElementById('sectionForm');
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.textContent = 'Update Section';
    submitBtn.onclick = (e) => {
      e.preventDefault();
      updateSection(sectionId);
    };
  }
}

// Update section
function updateSection(sectionId) {
  const title = document.getElementById('sectionTitle').value.trim();
  const type = document.getElementById('sectionType').value;
  const content = document.getElementById('sectionContent').value.trim();
  
  if (!title || !content) return;
  
  const sectionIndex = sections.findIndex(s => s.id === sectionId);
  if (sectionIndex !== -1) {
    sections[sectionIndex] = {
      ...sections[sectionIndex],
      title,
      type,
      content,
      updated_at: new Date().toISOString()
    };
    
    saveSections();
    renderSections();
    updateClassSummary();
    
    // Reset form
    document.getElementById('sectionForm').reset();
    const submitBtn = document.querySelector('#sectionForm button[type="submit"]');
    submitBtn.textContent = 'Create Section';
    submitBtn.onclick = null;
    
    showNotification('Section updated successfully!', 'success');
  }
}

// Delete section
function deleteSection(sectionId) {
  if (confirm('Are you sure you want to delete this section?')) {
    sections = sections.filter(s => s.id !== sectionId);
    saveSections();
    renderSections();
    updateClassSummary();
    showNotification('Section deleted successfully!', 'success');
  }
}

// Handle class end
function handleClassEnd() {
  isClassEnded = true;
  classDuration = Math.floor((Date.now() - classStartTime) / 1000);
  
  // Hide chat, polls, and doubts tabs
  document.querySelectorAll('.tab-btn:not(#benchmarkTab)').forEach(btn => {
    if (!btn.id.includes('darkModeToggle')) {
      btn.style.display = 'none';
    }
  });
  
  // Show benchmark tab
  document.getElementById('benchmarkTab').style.display = 'inline-block';
  
  // Switch to benchmark tab
  showTab('benchmark');
  
  // Update final summary
  updateClassSummary();
  
  // Save class completion data
  const classData = {
    class_id: classId,
    duration: classDuration,
    sections_count: sections.length,
    completed_at: new Date().toISOString(),
    sections: sections
  };
  
  localStorage.setItem(`class_completion_${classId}`, JSON.stringify(classData));
  
  showNotification('Class has ended! You can now create benchmark sections.', 'info');
}

// Daily reset function
function checkDailyReset() {
  const now = new Date();
  const lastReset = localStorage.getItem('last_daily_reset');
  
  if (!lastReset || new Date(lastReset).getDate() !== now.getDate()) {
    // It's a new day, reset completed classes
    const keys = Object.keys(localStorage);
    keys.forEach(key => {
      if (key.startsWith('class_completion_')) {
        localStorage.removeItem(key);
      }
    });
    
    localStorage.setItem('last_daily_reset', now.toISOString());
    console.log('Daily reset completed at', now.toLocaleString());
  }
}

// Check for daily reset every minute
setInterval(checkDailyReset, 60000);
checkDailyReset(); // Initial check

// Load sections on page load
loadSections();

// Form submission handler
document.getElementById('sectionForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const title = document.getElementById('sectionTitle').value.trim();
  const type = document.getElementById('sectionType').value;
  const content = document.getElementById('sectionContent').value.trim();
  
  if (!title || !content) {
    showNotification('Please fill in all fields', 'warning');
    return;
  }
  
  createSection(title, type, content);
  
  // Reset form
  this.reset();
  showNotification('Section created successfully!', 'success');
});

// Connection management
socket.on('connect', () => {
  console.log('Connected to server:', socket.id);
  isConnected = true;
  reconnectAttempts = 0;
  
  // Join the room
  socket.emit('join-room', { room });
});

socket.on('disconnect', (reason) => {
  console.log('Disconnected from server:', reason);
  isConnected = false;
});

socket.on('connect_error', (error) => {
  console.error('Connection error:', error);
  reconnectAttempts++;
  
  const statusEl = document.getElementById('liveStatusText');
  if (statusEl) {
    statusEl.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
      </svg>
      Reconnecting... (${reconnectAttempts}/10)
    `;
    statusEl.style.color = '#ffa726';
  }
});

socket.on('reconnect', (attemptNumber) => {
  console.log('Reconnected after', attemptNumber, 'attempts');
  
  const statusEl = document.getElementById('liveStatusText');
  if (statusEl) {
    statusEl.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14z"/>
      </svg>
      Reconnected to live class
    `;
    statusEl.style.color = '#48bb78';
  }
});

socket.on('reconnect_failed', () => {
  console.error('Failed to reconnect after maximum attempts');
  
  const statusEl = document.getElementById('liveStatusText');
  if (statusEl) {
    statusEl.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
      </svg>
      Connection lost - Please refresh
    `;
    statusEl.style.color = '#fc5c7d';
  }
});

// Error handling
socket.on('error', (data) => {
  console.error('Socket error:', data);
});

// Room management
socket.on('joined-room', (data) => {
  console.log('Joined room:', data.room);
});

// Live Camera Stream Variables
const hostCameraFeed = document.getElementById('hostCameraFeed');
const contentVideo = document.getElementById('contentVideo');
const liveStatusText = document.getElementById('liveStatusText');

// WebRTC Variables for receiving host stream
let peerConnection = null;
let hostStream = null;
let isHostStreamConnected = false;

// Student Device Selection Variables
const studentDeviceSelection = document.getElementById('studentDeviceSelection');
const studentVideoSelect = document.getElementById('studentVideoSelect');
const studentAudioSelect = document.getElementById('studentAudioSelect');
const studentDeviceStatus = document.getElementById('studentDeviceStatus');
let studentDevices = { videoInputs: [], audioInputs: [] };
let selectedStudentVideo = null;
let selectedStudentAudio = null;

// Listen for host camera status updates
socket.on('host_camera_status', (data) => {
  if (data.class_id === classId) {
    if (data.status === 'live') {
      liveStatusText.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <circle cx="12" cy="12" r="8" fill="#ff4444"/>
          <circle cx="12" cy="12" r="4" fill="#fff"/>
        </svg>
        ${data.message}
      `;
      liveStatusText.style.color = '#48bb78';
    } else {
      liveStatusText.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14z"/>
        </svg>
        ${data.message}
      `;
      liveStatusText.style.color = '#666';
    }
  }
});

// WebRTC Functions for receiving host stream
async function initializeWebRTC() {
  try {
    const configuration = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        { urls: 'stun:stun3.l.google.com:19302' },
        { urls: 'stun:stun4.l.google.com:19302' }
      ]
    };
    
    peerConnection = new RTCPeerConnection(configuration);
    
    // Handle incoming tracks from host
    peerConnection.ontrack = (event) => {
      console.log('Received host stream:', event.streams[0]);
      hostStream = event.streams[0];
      
      const hostCameraContainer = document.getElementById('hostCameraContainer');
      const hostCameraFeed = document.getElementById('hostCameraFeed');
      const contentVideo = document.getElementById('contentVideo');
      const switchToCameraBtn = document.getElementById('switchToCameraBtn');
      const switchToContentBtn2 = document.getElementById('switchToContentBtn2');
      const requestBtn = document.getElementById('requestHostStreamBtn');
      
      // Set up the video element
      hostCameraFeed.srcObject = hostStream;
      hostCameraFeed.onloadedmetadata = () => {
        hostCameraFeed.play().catch(e => console.log('Auto-play prevented:', e));
        
        // Setup quality monitoring after video loads
        setupVideoQualityMonitoring();
        
        // Hide loading indicator
        showCameraLoading(false);
      };
      
      // Show loading indicator while connecting
      showCameraLoading(true);
      
      // Show host camera container
      hostCameraContainer.style.display = 'block';
      contentVideo.style.display = 'none';
      isHostStreamConnected = true;
      
      // Update button states
      if (requestBtn) requestBtn.style.display = 'none';
      if (switchToCameraBtn) switchToCameraBtn.style.display = 'none';
      if (switchToContentBtn2) switchToContentBtn2.style.display = 'inline-block';
      
      // Update status
      liveStatusText.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <circle cx="12" cy="12" r="8" fill="#ff4444"/>
          <circle cx="12" cy="12" r="4" fill="#fff"/>
        </svg>
        🔴 Live Host Camera
      `;
      liveStatusText.style.color = '#48bb78';
      
      // Show success notification
      showNotification('🎥 Connected to host camera!', 'success');
      
      console.log('Host camera stream connected successfully');
    };
    
    // Handle ICE candidates
    peerConnection.onicecandidate = (event) => {
      if (event.candidate) {
        socket.emit('webrtc_ice_candidate', {
          class_id: classId,
          candidate: event.candidate,
          from_user: getUserId(),
          to_user: 'host'
        });
      }
    };
    
    // Handle connection state changes
    peerConnection.onconnectionstatechange = () => {
      console.log('Connection state:', peerConnection.connectionState);
      const connectionStatus = document.getElementById('connectionStatus');
      
      switch (peerConnection.connectionState) {
        case 'connected':
          console.log('Connected to host stream!');
          if (connectionStatus) {
            connectionStatus.textContent = '🔴 Live';
            connectionStatus.style.background = 'rgba(72,187,120,0.9)';
          }
          break;
          
        case 'connecting':
          console.log('Connecting to host stream...');
          if (connectionStatus) {
            connectionStatus.textContent = '🔄 Connecting...';
            connectionStatus.style.background = 'rgba(255,167,38,0.9)';
          }
          break;
          
        case 'disconnected':
        case 'failed':
          console.log('Disconnected from host stream');
          
          const hostCameraContainer = document.getElementById('hostCameraContainer');
          const contentVideo = document.getElementById('contentVideo');
          const switchToCameraBtn = document.getElementById('switchToCameraBtn');
          const switchToContentBtn2 = document.getElementById('switchToContentBtn2');
          const requestBtn = document.getElementById('requestHostStreamBtn');
          
          // Hide host camera and show content
          hostCameraContainer.style.display = 'none';
          contentVideo.style.display = 'block';
          isHostStreamConnected = false;
          
          // Update button states
          if (requestBtn) requestBtn.style.display = 'inline-block';
          if (switchToCameraBtn) switchToCameraBtn.style.display = 'none';
          if (switchToContentBtn2) switchToContentBtn2.style.display = 'none';
          
          // Update status
          liveStatusText.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14z"/>
            </svg>
            Watching content video
          `;
          liveStatusText.style.color = '#6a82fb';
          
          // Show reconnection notification
          showNotification('📡 Host camera disconnected. Click "Request Host Camera" to reconnect.', 'warning');
          break;
      }
    };
    
    // Handle ICE connection state changes
    peerConnection.oniceconnectionstatechange = () => {
      console.log('ICE connection state:', peerConnection.iceConnectionState);
    };
    
    console.log('WebRTC initialized for receiving host stream');
  } catch (error) {
    console.error('Error initializing WebRTC:', error);
    showNotification('❌ Failed to initialize camera connection', 'error');
  }
}

async function requestHostStream() {
  try {
    if (!peerConnection) {
      await initializeWebRTC();
    }
    
    // Show loading indicator
    showCameraLoading(true);
    
    // Show connecting status
    liveStatusText.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
      </svg>
      🔄 Requesting Host Camera...
    `;
    liveStatusText.style.color = '#fc5c7d';
    
    // Create offer to request host stream
    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    
    socket.emit('webrtc_offer', {
      class_id: classId,
      offer: offer,
      from_user: getUserId(),
      to_user: 'host'
    });
    
    console.log('Requested host stream');
    showNotification('📡 Requesting host camera...', 'info');
    
    // Set a timeout for the request
    setTimeout(() => {
      if (!isHostStreamConnected) {
        showNotification('⏰ Host camera request timed out. Please try again.', 'warning');
        liveStatusText.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14z"/>
          </svg>
          Watching content video
        `;
        liveStatusText.style.color = '#6a82fb';
        
        // Hide loading indicator
        showCameraLoading(false);
      }
    }, 15000); // 15 second timeout
    
  } catch (error) {
    console.error('Error requesting host stream:', error);
    showNotification('❌ Failed to request host camera', 'error');
    
    // Hide loading indicator
    showCameraLoading(false);
    
    // Reset status
    liveStatusText.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14z"/>
      </svg>
      Watching content video
    `;
    liveStatusText.style.color = '#6a82fb';
  }
}

async function handleHostAnswer(answer) {
  try {
    if (peerConnection) {
      await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
      console.log('Set host answer');
    }
  } catch (error) {
    console.error('Error handling host answer:', error);
  }
}

async function handleHostICECandidate(candidate) {
  try {
    if (peerConnection) {
      await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
      console.log('Added host ICE candidate');
    }
  } catch (error) {
    console.error('Error handling host ICE candidate:', error);
  }
}

// Listen for host video mode changes
socket.on('host_video_mode', (data) => {
  if (data.class_id === classId) {
    if (data.mode === 'camera') {
      // Request host stream when they switch to camera mode
      if (!isHostStreamConnected) {
        requestHostStream();
      }
      liveStatusText.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
        </svg>
        🔴 Connecting to Host Camera...
      `;
      liveStatusText.style.color = '#fc5c7d';
      
      // Show notification
      showNotification('🎥 Host switched to camera mode!', 'info');
      
      // Update button states
      const switchToCameraBtn = document.getElementById('switchToCameraBtn');
      if (switchToCameraBtn) {
        switchToCameraBtn.style.display = 'inline-block';
      }
    } else {
      // Host switched to content mode
      const hostCameraContainer = document.getElementById('hostCameraContainer');
      const contentVideo = document.getElementById('contentVideo');
      const switchToCameraBtn = document.getElementById('switchToCameraBtn');
      const switchToContentBtn2 = document.getElementById('switchToContentBtn2');
      
      // Hide host camera and show content
      hostCameraContainer.style.display = 'none';
      contentVideo.style.display = 'block';
      
      // Update button states
      if (switchToCameraBtn) switchToCameraBtn.style.display = 'none';
      if (switchToContentBtn2) switchToContentBtn2.style.display = 'none';
      
      liveStatusText.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14z"/>
        </svg>
        ${data.message}
      `;
      liveStatusText.style.color = '#6a82fb';
      
      // Show notification
      showNotification('📺 Host switched to content mode', 'info');
    }
  }
});

// Listen for host microphone status
socket.on('host_mic_status', (data) => {
  if (data.class_id === classId) {
    const micStatus = data.muted ? '🔇 Host microphone muted' : '🎤 Host microphone active';
    // You could show this in a toast notification or update the status
    console.log(micStatus);
  }
});

// Student Device Management Functions
async function enumerateStudentDevices() {
  try {
    console.log('Requesting camera permissions...');
    
    // Request permission first
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { width: { ideal: 640 }, height: { ideal: 360 } }, 
      audio: true 
    });
    
    console.log('Camera permission granted, stream obtained:', stream);
    
    // Stop the test stream
    stream.getTracks().forEach(track => track.stop());
    console.log('Test stream stopped');

    const devices = await navigator.mediaDevices.enumerateDevices();
    console.log('Devices enumerated:', devices);
    
    studentDevices.videoInputs = devices.filter(device => device.kind === 'videoinput');
    studentDevices.audioInputs = devices.filter(device => device.kind === 'audioinput');
    
    populateStudentDeviceSelectors();
    studentDeviceStatus.innerHTML = `📱 Found ${studentDevices.videoInputs.length} camera(s) and ${studentDevices.audioInputs.length} microphone(s)`;
    
    // Show device selection if devices are available
    if (studentDevices.videoInputs.length > 0 || studentDevices.audioInputs.length > 0) {
      studentDeviceSelection.style.display = 'block';
    }
    
    console.log('Student devices enumerated:', studentDevices);
  } catch (error) {
    console.error('Error enumerating student devices:', error);
    
    if (error.name === 'NotAllowedError') {
      studentDeviceStatus.innerHTML = '❌ Camera permission denied. Please allow camera access and refresh the page.';
    } else if (error.name === 'NotFoundError') {
      studentDeviceStatus.innerHTML = '❌ No camera found. Please connect a camera and refresh the page.';
    } else if (error.name === 'NotReadableError') {
      studentDeviceStatus.innerHTML = '❌ Camera is busy or in use by another application.';
    } else {
      studentDeviceStatus.innerHTML = `❌ Camera error: ${error.message}. Check permissions to participate.`;
    }
  }
}

function populateStudentDeviceSelectors() {
  // Populate video sources
  studentVideoSelect.innerHTML = '<option value="">Select Camera...</option>';
  studentDevices.videoInputs.forEach((device, index) => {
    const option = document.createElement('option');
    option.value = device.deviceId;
    option.textContent = device.label || `Camera ${index + 1}`;
    studentVideoSelect.appendChild(option);
  });

  // Populate audio sources
  studentAudioSelect.innerHTML = '<option value="">Select Microphone...</option>';
  studentDevices.audioInputs.forEach((device, index) => {
    const option = document.createElement('option');
    option.value = device.deviceId;
    option.textContent = device.label || `Microphone ${index + 1}`;
    studentAudioSelect.appendChild(option);
  });

  // Set default selections if available
  if (studentDevices.videoInputs.length > 0) {
    selectedStudentVideo = studentDevices.videoInputs[0].deviceId;
    studentVideoSelect.value = selectedStudentVideo;
  }
  if (studentDevices.audioInputs.length > 0) {
    selectedStudentAudio = studentDevices.audioInputs[0].deviceId;
    studentAudioSelect.value = selectedStudentAudio;
  }
  
  // Initial status update
  handleStudentDeviceSelection();
}

function handleStudentDeviceSelection() {
  selectedStudentVideo = studentVideoSelect.value;
  selectedStudentAudio = studentAudioSelect.value;
  
  const videoDeviceName = studentVideoSelect.options[studentVideoSelect.selectedIndex]?.text || 'None';
  const audioDeviceName = studentAudioSelect.options[studentAudioSelect.selectedIndex]?.text || 'None';
  
  studentDeviceStatus.innerHTML = `🎯 Ready with: ${videoDeviceName} & ${audioDeviceName}`;
  
  // Store selections for potential future use (like breakout rooms, participation, etc.)
  localStorage.setItem('selectedStudentVideo', selectedStudentVideo || '');
  localStorage.setItem('selectedStudentAudio', selectedStudentAudio || '');
}

// Add event listeners for student device selection
if (studentVideoSelect && studentAudioSelect) {
  studentVideoSelect.addEventListener('change', handleStudentDeviceSelection);
  studentAudioSelect.addEventListener('change', handleStudentDeviceSelection);
}

// Initialize student device enumeration
enumerateStudentDevices();

// --- Polls ---
function renderPolls(polls) {
  const pollsContainer = document.getElementById('activePolls');
  pollsContainer.innerHTML = '';
  polls.forEach(poll => {
    const pollDiv = document.createElement('div');
    pollDiv.className = 'poll-item';
    pollDiv.style.cssText = 'background:#fff; border-radius:12px; padding:0.9rem; margin-bottom:0.75rem; border:1px solid #ffd6d6;';
    const votedOption = localStorage.getItem('voted_poll_' + poll.id + '_option');
    const optionsHtml = (poll.options || []).map(opt => {
      const voted = votedOption && String(votedOption) === String(opt.id);
      return `
        <div class="poll-option-row" data-option-id="${opt.id}" style="margin:.4rem 0;">
          <button class="poll-vote-btn" ${votedOption ? 'disabled' : ''} style="display:block; width:100%; text-align:left; background:#fff; border:1px solid #ffd6d6; border-radius:10px; padding:0.6rem; cursor:${votedOption ? 'default' : 'pointer'};">
            <div style=\"display:flex; justify-content:space-between; align-items:center; gap:.75rem;\">
              <span>${opt.option_text}</span>
              <span class="poll-vote-meta" style="opacity:.8;">0</span>
      </div>
            <div class="poll-bar" style="height:6px; background:#ffecec; border-radius:6px; margin-top:.5rem; overflow:hidden;">
              <div class="poll-bar-fill" style="height:100%; width:0%; background:linear-gradient(90deg,#6a82fb,#fc5c7d);"></div>
            </div>
          </button>
          ${voted ? `<div class="your-vote" style="font-size:.85rem; color:#6a82fb; margin-top:0.25rem;">Your vote</div>` : ''}
        </div>`;
    }).join('');
    pollDiv.innerHTML = `
      <div class="poll-question" style="font-weight:600; margin-bottom:.35rem;">${poll.question}</div>
      <div class="poll-options" id="poll-${poll.id}-options">${optionsHtml}</div>
      <div class="poll-meta" id="poll-${poll.id}-total" style="margin-top:.25rem; color:#666; font-size:.9rem;">Total: 0 votes</div>
    `;
    pollsContainer.appendChild(pollDiv);
    if (!votedOption) {
      pollDiv.querySelectorAll('.poll-option-row').forEach(row => {
        const btn = row.querySelector('.poll-vote-btn');
        btn.addEventListener('click', () => {
          const optionId = row.getAttribute('data-option-id');
          votePoll(${`poll.id`}, optionId, pollDiv);
        });
      });
    }
  });
}
function votePoll(pollId, optionId, pollDiv) {
  if (localStorage.getItem('voted_poll_' + pollId)) return alert('You already voted!');
  socket.emit('vote_poll', { poll_id: pollId, option_id: optionId, user_id: getUserId(), class_id: classId });
  localStorage.setItem('voted_poll_' + pollId, '1');
  localStorage.setItem('voted_poll_' + pollId + '_option', String(optionId));
  // Disable buttons immediately and mark "Your vote"
  pollDiv.querySelectorAll('.poll-vote-btn').forEach(b => b.disabled = true);
  const row = pollDiv.querySelector(`.poll-option-row[data-option-id='${optionId}']`);
  if (row && !row.querySelector('.your-vote')) {
    const tag = document.createElement('div');
    tag.className = 'your-vote';
    tag.style.cssText = 'font-size:.85rem; color:#6a82fb; margin-top:0.25rem;';
    tag.textContent = 'Your vote';
    row.appendChild(tag);
  }
}
socket.on('new_poll', poll => {
  socket.emit('get_polls_and_doubts', { class_id: classId });
});
socket.on('poll_results', data => {
  if (data && data.results) {
    // Compute totals
    let totalVotes = 0;
    data.results.forEach(opt => { totalVotes += (opt.votes || 0); });
    // Update each option bar and meta
    data.results.forEach(opt => {
      const optionRow = document.querySelector(`.poll-option-row[data-option-id='${opt.option_id}']`);
      if (!optionRow) return;
      const pct = totalVotes > 0 ? Math.round((opt.votes / totalVotes) * 100) : 0;
      const meta = optionRow.querySelector('.poll-vote-meta');
      if (meta) meta.textContent = `${opt.votes}${totalVotes ? ` • ${pct}%` : ''}`;
      const bar = optionRow.querySelector('.poll-bar-fill');
      if (bar) bar.style.width = pct + '%';
    });
    // Update total line
    const totalEl = document.getElementById('poll-' + data.poll_id + '-total');
    if (totalEl) totalEl.textContent = `Total: ${totalVotes} vote${totalVotes===1?'':'s'}`;
  }
});

// --- Doubts ---
function renderDoubts(doubts) {
  const doubtsList = document.getElementById('doubtsList');
  doubtsList.innerHTML = '';
  doubts.forEach(doubt => {
    const div = document.createElement('div');
    div.className = 'doubt-item';
    div.style = 'background: #fff; border-radius: 8px; padding: 0.8rem; margin-bottom: 0.5rem; border-left: 3px solid #48bb78;';
    div.innerHTML = `<div class="doubt-user">${doubt.username}</div><div class="doubt-text">${doubt.doubt_text}</div>` +
      (doubt.status === 'resolved' ? '<div style="color:#48bb78;font-weight:600;">✓ Resolved</div>' : doubt.status === 'ignored' ? '<div style="color:#a0aec0;">Ignored</div>' : '');
    doubtsList.appendChild(div);
  });
}
document.getElementById('doubtForm').onsubmit = function(e) {
  e.preventDefault();
  var doubtInput = document.getElementById('doubtInput');
  var text = doubtInput.value.trim();
  if (!text) return;
  socket.emit('submit_doubt', { class_id: classId, user_id: getUserId(), username: getUsername(), doubt_text: text });
  doubtInput.value = '';
};
socket.on('update_doubts', data => {
  renderDoubts(data.doubts);
});

// Initial fetch of polls and doubts
socket.emit('get_polls_and_doubts', { class_id: classId });
socket.on('init_polls_and_doubts', data => {
  renderPolls(data.polls);
  renderDoubts(data.doubts);
});

// --- Chat Functionality ---
function sendChatMessage() {
  const chatInput = document.getElementById('chatInput');
  const message = chatInput.value.trim();
  
  if (message && isConnected) {
    const messageData = {
      class_id: classId,
      user_id: getUserId(),
      username: getUsername(),
      message: message,
      type: 'chat'
    };
    
    // Emit the message
    socket.emit('chat_message', messageData);
    
    // Clear input
    chatInput.value = '';
    
    // Show typing indicator
    showTypingIndicator(getUsername());
    
    console.log('Student sent message:', messageData);
  }
}

function renderChatMessage(messageData) {
  const chatMessages = document.getElementById('chatMessages');
  const messageDiv = document.createElement('div');
  messageDiv.className = 'chat-message';
  messageDiv.id = `msg-${messageData.id || Date.now()}`;
  
  const timestamp = new Date(messageData.created_at).toLocaleTimeString();
  const isHost = messageData.username === 'Host';
  const isOwnMessage = messageData.username === getUsername();
  const usernameColor = isHost ? '#fc5c7d' : (isOwnMessage ? '#48bb78' : '#6a82fb');
  const messageStyle = isHost ? 'border-left-color: #fc5c7d;' : (isOwnMessage ? 'border-left-color: #48bb78;' : 'border-left-color: #6a82fb;');
  
  messageDiv.innerHTML = `
    <div style="font-weight: 600; color: ${usernameColor}; font-size: 0.9rem;">
      ${messageData.username} <span style="color: #888; font-weight: 400; font-size: 0.8rem;">${timestamp}</span>
      ${isHost ? '<span style="color: #fc5c7d; font-size: 0.8rem;"> 👑</span>' : ''}
      ${isOwnMessage ? '<span style="color: #48bb78; font-size: 0.8rem;"> (You)</span>' : ''}
    </div>
    <div style="margin-top: 0.2rem;">${messageData.message}</div>
  `;
  
  // Apply message style
  messageDiv.style.borderLeftColor = isHost ? '#fc5c7d' : (isOwnMessage ? '#48bb78' : '#6a82fb');
  
  // Check if message already exists to prevent duplicates
  const existingMessage = document.getElementById(`msg-${messageData.id || Date.now()}`);
  if (!existingMessage) {
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Add message animation
    messageDiv.style.opacity = '0';
    messageDiv.style.transform = 'translateY(10px)';
    messageDiv.style.transition = 'all 0.3s ease';
    
    setTimeout(() => {
      messageDiv.style.opacity = '1';
      messageDiv.style.transform = 'translateY(0)';
    }, 100);
    
    // Show notification for host messages
    if (isHost) {
      showNotification(`📢 Message from Host: ${messageData.message}`, 'info');
    }
  }
}

// Enhanced chat event listeners
socket.on('new_chat_message', (messageData) => {
  console.log('Received new chat message:', messageData);
  
  // Don't render if it's our own message
  if (messageData.username !== getUsername()) {
    renderChatMessage(messageData);
  }
});

socket.on('chat_messages_history', (data) => {
  console.log('Received chat history:', data);
  const chatMessages = document.getElementById('chatMessages');
  chatMessages.innerHTML = '';
  
  if (data.messages && data.messages.length > 0) {
    data.messages.forEach(message => {
      renderChatMessage(message);
    });
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
  } else {
    // Show welcome message
    const welcomeDiv = document.createElement('div');
    welcomeDiv.className = 'chat-message';
    welcomeDiv.style.textAlign = 'center';
    welcomeDiv.style.color = '#666';
    welcomeDiv.style.fontStyle = 'italic';
    welcomeDiv.innerHTML = 'Welcome to the live class! Start chatting below.';
    chatMessages.appendChild(welcomeDiv);
  }
});

// Chat form submission
document.getElementById('chatForm').addEventListener('submit', function(e) {
  e.preventDefault();
  sendChatMessage();
});

// Load chat history when joining
socket.emit('get_chat_messages', { class_id: classId, limit: 50 });

// Add error handling for chat
socket.on('error', (data) => {
  console.error('Chat error:', data);
  if (data.message) {
    showNotification('Chat error: ' + data.message, 'error');
  }
});

// Chat status change handling
socket.on('chat_status_change', (data) => {
  if (data.class_id === classId) {
    updateChatStatus(data.status, data.message);
  }
});

// Chat cleared event handling
socket.on('chat_cleared', (data) => {
  if (data.class_id === classId) {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '';
    
    // Show cleared message
    const clearedDiv = document.createElement('div');
    clearedDiv.className = 'chat-message';
    clearedDiv.style.textAlign = 'center';
    clearedDiv.style.color = '#666';
    clearedDiv.style.fontStyle = 'italic';
    clearedDiv.innerHTML = 'Chat has been cleared by host';
    chatMessages.appendChild(clearedDiv);
    
    showNotification('Chat has been cleared by host', 'info');
  }
});

function updateChatStatus(status, message) {
  const statusText = document.getElementById('chatStatusText');
  const chatForm = document.getElementById('chatForm');
  const chatInput = document.getElementById('chatInput');
  
  // Remove all status classes
  statusText.classList.remove('locked', 'private', 'public');
  
  if (status === 'locked') {
    statusText.textContent = '🔒 Locked';
    statusText.classList.add('locked');
    chatForm.style.opacity = '0.5';
    chatInput.disabled = true;
    chatInput.placeholder = 'Chat is locked by host';
    
    // Show notification
    showNotification(message, 'warning');
  } else if (status === 'private') {
    statusText.textContent = '🔒 Private';
    statusText.classList.add('private');
    chatForm.style.opacity = '0.5';
    chatInput.disabled = true;
    chatInput.placeholder = 'Chat is private - only host can see messages';
    
    // Show notification
    showNotification(message, 'info');
  } else if (status === 'public') {
    statusText.textContent = '● Public';
    statusText.classList.add('public');
    chatForm.style.opacity = '1';
    chatInput.disabled = false;
    chatInput.placeholder = 'Type a message...';
    
    // Show notification
    showNotification(message, 'success');
  } else if (status === 'unlocked') {
    statusText.textContent = '● Public';
    statusText.classList.add('public');
    chatForm.style.opacity = '1';
    chatInput.disabled = false;
    chatInput.placeholder = 'Type a message...';
    
    // Show notification
    showNotification(message, 'success');
  }
}

function showTypingIndicator(username) {
  // Show typing indicator
  const chatMessages = document.getElementById('chatMessages');
  const typingDiv = document.createElement('div');
  typingDiv.id = 'typing-indicator';
  typingDiv.className = 'chat-message';
  typingDiv.style.opacity = '0.7';
  typingDiv.style.fontStyle = 'italic';
  typingDiv.innerHTML = `${username} is typing...`;
  
  chatMessages.appendChild(typingDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  
  // Remove typing indicator after 2 seconds
  setTimeout(() => {
    if (typingDiv.parentNode) {
      typingDiv.parentNode.removeChild(typingDiv);
    }
  }, 2000);
}

// Enhanced host stream ready handling
socket.on('host_stream_ready', (data) => {
  if (data.class_id === classId) {
    console.log('Host stream is ready, requesting connection...');
    showNotification('🎥 Host camera is ready!', 'success');
    
    // If not already connected, request the stream
    if (!isHostStreamConnected) {
      requestHostStream();
    }
  }
});

// Handle WebRTC answers from host
socket.on('webrtc_answer', (data) => {
  if (data.from_user === 'host') {
    handleHostAnswer(data.answer);
  }
});

// Handle WebRTC ICE candidates from host
socket.on('webrtc_ice_candidate', (data) => {
  if (data.from_user === 'host') {
    handleHostICECandidate(data.candidate);
  }
});

// Recording Event Listeners
socket.on('recording_started', (data) => {
  if (data.class_id === classId) {
    showRecordingNotification(true, 'Recording started');
    console.log('Recording started:', data);
  }
});

socket.on('recording_stopped', (data) => {
  if (data.class_id === classId) {
    showRecordingNotification(false, 'Recording stopped');
    console.log('Recording stopped:', data);
  }
});

function showRecordingNotification(isRecording, message) {
  const notification = document.getElementById('recordingNotification');
  const statusText = document.getElementById('recordingStatusText');
  
  if (isRecording) {
    notification.style.display = 'block';
    notification.style.background = 'rgba(220,53,69,0.1)';
    notification.style.borderColor = 'rgba(220,53,69,0.2)';
    statusText.style.color = '#dc3545';
    statusText.innerHTML = `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <circle cx="12" cy="12" r="8" fill="#dc3545"/>
      </svg>
      🔴 Recording in progress
    `;
  } else {
    notification.style.display = 'none';
  }
}

// --- Helpers ---
function getUserId() {
  // Use a cookie, session, or fallback to random for demo
  if (window.username) return window.username;
  let id = localStorage.getItem('user_id');
  if (!id) { id = 'user_' + Math.random().toString(36).substr(2, 8); localStorage.setItem('user_id', id); }
  return id;
}
function getUsername() {
  // Use a cookie, session, or fallback to 'Student'
  return window.username || 'Student';
}

// --- Tab switching logic ---
function showTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(tabName + '-tab').classList.add('active');
  event.target.classList.add('active');
}

// Auto-initialize WebRTC when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Initialize WebRTC after a short delay to ensure everything is loaded
  setTimeout(() => {
    initializeWebRTC();
  }, 1000);
  
  // Check if host is already streaming
  socket.emit('request_host_stream', { class_id: classId });
});

// Enhanced camera switching functions
function switchToHostCamera() {
  if (isHostStreamConnected) {
    const hostCameraContainer = document.getElementById('hostCameraContainer');
    const contentVideo = document.getElementById('contentVideo');
    const switchToCameraBtn = document.getElementById('switchToCameraBtn');
    const switchToContentBtn2 = document.getElementById('switchToContentBtn2');
    
    hostCameraContainer.style.display = 'block';
    contentVideo.style.display = 'none';
    switchToCameraBtn.style.display = 'none';
    switchToContentBtn2.style.display = 'inline-block';
    
    // Update status
    liveStatusText.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <circle cx="12" cy="12" r="8" fill="#ff4444"/>
        <circle cx="12" cy="12" r="4" fill="#fff"/>
      </svg>
      🔴 Live Host Camera
    `;
    liveStatusText.style.color = '#48bb78';
    
    showNotification('🎥 Switched to host camera view', 'success');
  } else {
    showNotification('📡 Host camera not available. Click "Request Host Camera" first.', 'warning');
  }
}

function switchToContent() {
  const hostCameraContainer = document.getElementById('hostCameraContainer');
  const contentVideo = document.getElementById('contentVideo');
  const switchToCameraBtn = document.getElementById('switchToCameraBtn');
  const switchToContentBtn2 = document.getElementById('switchToContentBtn2');
  
  hostCameraContainer.style.display = 'none';
  contentVideo.style.display = 'block';
  
  if (isHostStreamConnected) {
    switchToCameraBtn.style.display = 'inline-block';
    switchToContentBtn2.style.display = 'none';
  } else {
    switchToCameraBtn.style.display = 'none';
    switchToContentBtn2.style.display = 'none';
  }
  
  // Update status
  liveStatusText.innerHTML = `
    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
      <path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14z"/>
    </svg>
    Watching content video
  `;
  liveStatusText.style.color = '#6a82fb';
  
  showNotification('📺 Switched to content view', 'info');
}

// Camera quality detection
function detectCameraQuality(videoElement) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  
  // Set canvas size to video dimensions
  canvas.width = videoElement.videoWidth;
  canvas.height = videoElement.videoHeight;
  
  // Draw video frame to canvas
  ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
  
  // Get image data for quality analysis
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;
  
  // Simple quality detection based on resolution
  let quality = 'SD';
  if (canvas.width >= 1280 && canvas.height >= 720) {
    quality = 'HD';
  } else if (canvas.width >= 1920 && canvas.height >= 1080) {
    quality = 'Full HD';
  } else if (canvas.width >= 2560 && canvas.height >= 1440) {
    quality = '2K';
  } else if (canvas.width >= 3840 && canvas.height >= 2160) {
    quality = '4K';
  }
  
  return quality;
}

// Update camera quality display
function updateCameraQuality() {
  const video = document.getElementById('hostCameraFeed');
  const qualityDiv = document.getElementById('cameraQuality');
  const qualityText = document.getElementById('qualityText');
  
  if (video && video.videoWidth > 0) {
    const quality = detectCameraQuality(video);
    qualityText.textContent = quality;
    qualityDiv.style.display = 'block';
  }
}

// Show/hide loading indicator
function showCameraLoading(show) {
  const loadingDiv = document.getElementById('cameraLoading');
  if (loadingDiv) {
    loadingDiv.style.display = show ? 'block' : 'none';
  }
}

// Enhanced WebRTC track handling
function setupVideoQualityMonitoring() {
  const video = document.getElementById('hostCameraFeed');
  if (video && hostStream) {
    // Monitor video quality changes
    video.addEventListener('loadedmetadata', () => {
      updateCameraQuality();
    });
    
    video.addEventListener('resize', () => {
      updateCameraQuality();
    });
    
    // Update quality every 5 seconds
    setInterval(() => {
      if (isHostStreamConnected && video.videoWidth > 0) {
        updateCameraQuality();
      }
    }, 5000);
  }
}

// Fullscreen functionality
function toggleFullscreen() {
  const video = document.getElementById('hostCameraFeed');
  if (!document.fullscreenElement) {
    if (video.requestFullscreen) {
      video.requestFullscreen();
    } else if (video.mozRequestFullScreen) { // Firefox
      video.mozRequestFullScreen();
    } else if (video.webkitRequestFullscreen) { // Chrome, Safari and Opera
      video.webkitRequestFullscreen();
    } else if (video.msRequestFullscreen) { // IE/Edge
      video.msRequestFullscreen();
    }
  } else {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.mozCancelFullScreen) { // Firefox
      document.mozCancelFullScreen();
    } else if (document.webkitExitFullscreen) { // Chrome, Safari and Opera
      document.webkitExitFullscreen();
    } else if (document.msExitFullscreen) { // IE/Edge
      document.msExitFullscreen();
    }
  }
}

// Add keyboard shortcuts for camera switching
document.addEventListener('keydown', function(event) {
  // Ctrl/Cmd + 1: Switch to content
  if ((event.ctrlKey || event.metaKey) && event.key === '1') {
    event.preventDefault();
    switchToContent();
  }
  // Ctrl/Cmd + 2: Switch to host camera
  if ((event.ctrlKey || event.metaKey) && event.key === '2') {
    event.preventDefault();
    switchToHostCamera();
  }
  // F: Toggle fullscreen
  if (event.key === 'f' || event.key === 'F') {
    event.preventDefault();
    toggleFullscreen();
  }
});

// Chat Event Listeners
socket.on('new_chat_message', (data) => {
  if (data.class_id === classId && data.username !== 'You') {
    console.log('New chat message received:', data);
    renderChatMessage(data);
    showNotification(`New message from ${data.username}`, 'info');
  }
});

socket.on('chat_messages_history', (data) => {
  if (data.class_id === classId) {
    console.log('Chat history received:', data);
    if (data.messages.length === 0) {
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = `
        <div style="text-align: center; color: #666; font-style: italic; padding: 1rem;">
          Welcome to the live class! Start chatting with your classmates and host.
        </div>
      `;
    } else {
      data.messages.forEach(message => renderChatMessage(message));
    }
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
});

// Class End Detection
socket.on('class_ended', (data) => {
  if (data.class_id === classId) {
    console.log('Class ended by host:', data);
    handleClassEnd();
  }
});

socket.on('host_disconnected', (data) => {
  if (data.class_id === classId) {
    console.log('Host disconnected:', data);
    showNotification('Host has disconnected. Class may be ending soon.', 'warning');
    
    // Wait a bit then check if class is really ended
    setTimeout(() => {
      if (!isConnected) {
        handleClassEnd();
      }
    }, 10000);
  }
});

// Benchmark Event Listeners
socket.on('section_created', (data) => {
  if (data.class_id === classId) {
    console.log('Section created by another student:', data);
    // Add to local sections if not already present
    if (!sections.find(s => s.id === data.id)) {
      sections.push(data);
      saveSections();
      renderSections();
      updateClassSummary();
    }
  }
});

socket.on('section_updated', (data) => {
  if (data.class_id === classId) {
    console.log('Section updated by another student:', data);
    const sectionIndex = sections.findIndex(s => s.id === data.id);
    if (sectionIndex !== -1) {
      sections[sectionIndex] = data;
      saveSections();
      renderSections();
      updateClassSummary();
    }
  }
});

socket.on('section_deleted', (data) => {
  if (data.class_id === classId) {
    console.log('Section deleted by another student:', data);
    sections = sections.filter(s => s.id !== data.id);
    saveSections();
    renderSections();
    updateClassSummary();
  }
});

// Show notification function
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 10000;
    max-width: 300px;
    word-wrap: break-word;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateX(100%);
    transition: transform 0.3s ease;
  `;
  
  // Set background based on type
  switch(type) {
    case 'success':
      notification.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
      break;
    case 'error':
      notification.style.background = 'linear-gradient(135deg, #dc3545, #e74c3c)';
      break;
    case 'warning':
      notification.style.background = 'linear-gradient(135deg, #ffc107, #fd7e14)';
      break;
    default:
      notification.style.background = 'linear-gradient(135deg, #17a2b8, #6f42c1)';
  }
  
  notification.textContent = message;
  document.body.appendChild(notification);
  
  // Animate in
  setTimeout(() => {
    notification.style.transform = 'translateX(0)';
  }, 100);
  
  // Auto remove after 5 seconds
  setTimeout(() => {
    notification.style.transform = 'translateX(100%)';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 5000);
}
</script>

    <!-- Search Modal -->
    <div id="searchModal" class="modal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div class="modal-content black-glass" style="margin: 10% auto; padding: 2rem; border-radius: 20px; width: 90%; max-width: 600px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="color: white; margin: 0;">🔍 Search</h2>
                <button onclick="closeSearch()" style="background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer;">✕</button>
            </div>
            <input type="text" id="searchInput" placeholder="Search courses, resources, or topics..." style="width: 100%; padding: 15px; border: none; border-radius: 10px; background: rgba(255,255,255,0.1); color: white; font-size: 1rem; margin-bottom: 1rem;">
            <div id="searchResults" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Notification Panel -->
    <div id="notification-panel" class="notification-panel black-glass" style="display: none; position: fixed; top: 100px; right: 20px; width: 350px; max-height: 500px; overflow-y: auto; z-index: 999; border-radius: 16px; padding: 1rem; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.2);">
            <h3 style="margin: 0; font-size: 1.2rem; color: white;">🔔 Notifications</h3>
            <button onclick="toggleNotifications()" style="background: none; border: none; color: #fff; font-size: 1.2rem; cursor: pointer; padding: 0.2rem;">✕</button>
        </div>
        <div class="notification-list">
            <div class="notification-item" style="padding: 0.8rem; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 0.5rem;">
                <div style="font-weight: 600; margin-bottom: 0.3rem; color: white;">📚 Latest Updates</div>
                <div style="font-size: 0.9rem; opacity: 0.8; color: rgba(255,255,255,0.8);">Check out new features and content</div>
            </div>
        </div>
    </div>

    <script src="navbar-functions.js"></script>
</body>
<script src="/attached_assets/theme.js"></script>
</html> 